<!-- FIXED V2: single addClient() call -->
<!DOCTYPE html>

<html lang="fr">
<head>
<!-- Deletion logger (EARLY, non-invasive) -->
<script>
   (() => {
  const STORE_KEY = 'iptv_activity_logs_v1';
  const MAX = 500;
  const WATCH = ['iptv_resellers_v1', 'iptv_macs_v1']; // keys to watch
  const pad = n => String(n).padStart(2,'0');
  const fmt = d => `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const nowISO = () => new Date().toISOString();
  const safeParse = v => { try { const x = JSON.parse(v||'[]'); return Array.isArray(x) ? x : []; } catch { return []; } };

  const load = () => { try { const x = JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); return Array.isArray(x)? x: []; } catch { return []; } };
  const save = arr => { try { localStorage.setItem(STORE_KEY, JSON.stringify(arr.slice(0, MAX))); } catch {} };
  let STORE = load();

  // Snapshots for watched keys
  const snapshots = {};
  for (const k of WATCH) snapshots[k] = safeParse(localStorage.getItem(k));

  // Safe DOM getters (panel may not exist yet — we run EARLY)
  const elPanel   = () => document.getElementById('logsPanel');
  const elContainer = () => document.getElementById('logsContainer');

  function lineFromEntry(item){
    const t = fmt(new Date(item.time || Date.now()));
    if(item.type==='client' && item.action==='delete'){
      return null; // ignore client deletion to avoid duplicate
    }
    if(item.type==='reseller' && item.action==='delete'){

      const r = Array.isArray(item?.details?.removed) ? item.details.removed : [];
      const who = r[0]?.name ?? r[0]?.username ?? r[0]?.id ?? '';
      return `${t} Suppression Reseller "${who}"`;
    }
    if(item.type==='mac' && item.action==='delete'){
      const r = Array.isArray(item?.details?.removed) ? item.details.removed : [];
      const mac = r[0]?.mac ?? r[0]?.address ?? r[0]?.id ?? item?.details?.mac ?? '';
      return `${t} Suppression MAC "${mac}"`;
    }
    if(item.action==='delete_all'){ return `${t} Purge ${item.type?.toUpperCase()||''} (${item.entity})`; }
    return null;
  }

  function appendToPanel(line){
    const c = elContainer(); if(!c || !line) return;
    const needsNL = c.textContent && !c.textContent.endsWith('\n');
    c.textContent += (needsNL? '\n':'') + line;
    c.scrollTop = c.scrollHeight;
  }

  function record(item){
    STORE.unshift(item);
    if (STORE.length > MAX) STORE.length = MAX;
    save(STORE);
    // live-append if panel visible
    const p = elPanel();
    if (p && p.style.display !== 'none') {
      const line = lineFromEntry(item);
      appendToPanel(line);
    }
    try { console.log('[DEL-LOG]', item); } catch {}
  }

  // ---- Client deletion: capture clicks on [data-act="del"] (runs EVEN if late-binded elsewhere) ----
  function extractClientRowInfo(tr){
    try{
      const tds = tr ? tr.querySelectorAll('td') : null;
      const name = tds?.[1]?.textContent?.trim() || '';
      const username = tds?.[2]?.textContent?.trim() || '';
      const mac = tds?.[9]?.textContent?.trim() || '';
      return { name, username, mac };
    }catch{ return {}; }
  }
  document.addEventListener('click', function(e){
    const btn = e.target.closest?.('[data-act="del"]');
    if(!btn) return;
    // ignore client deletions to prevent duplicate entries
    return;
  
  }, true);

  // ---- Robust hook: patch BOTH instance and prototype methods ----
  const _protoSet = Storage.prototype.setItem;
  const _protoRem = Storage.prototype.removeItem;
  const _instSet  = localStorage.setItem.bind(localStorage);
  const _instRem  = localStorage.removeItem.bind(localStorage);

  function diffRemoved(before, after){
    const S = x => JSON.stringify(x);
    const setA = new Set(after.map(S));
    return before.filter(x => !setA.has(S(x)));
  }

  function afterWrite(key){
    if (!WATCH.includes(key)) return;
    const before = snapshots[key];
    let after = safeParse(localStorage.getItem(key));
    if (!Array.isArray(after)) after = [];
    const removed = diffRemoved(before, after);
    if (removed.length){
      const type = key === 'iptv_resellers_v1' ? 'reseller' : 'mac';
      record({ time: nowISO(), type, action:'delete', entity:key, details:{ removed, lenBefore: before.length, lenAfter: after.length } });
    }
    snapshots[key] = after;
  }

  // Patch prototype (covers most calls)
  Storage.prototype.setItem = function(key, val){
    const out = _protoSet.call(this, key, val);
    afterWrite(key);
    return out;
  };
  Storage.prototype.removeItem = function(key){
    const was = WATCH.includes(key) ? snapshots[key] : null;
    const out = _protoRem.call(this, key);
    if (WATCH.includes(key) && was && was.length){
      const type = key==='iptv_resellers_v1' ? 'reseller' : 'mac';
      record({ time: nowISO(), type, action:'delete_all', entity:key, details:{ removedAllCount: was.length } });
      snapshots[key] = [];
    }
    return out;
  };

  // Patch instance as well (in case code calls localStorage.setItem directly)
  localStorage.setItem = function(key, val){
    const out = _instSet(key, val);
    afterWrite(key);
    return out;
  };
  localStorage.removeItem = function(key){
    const was = WATCH.includes(key) ? snapshots[key] : null;
    const out = _instRem(key);
    if (WATCH.includes(key) && was && was.length){
      const type = key==='iptv_resellers_v1' ? 'reseller' : 'mac';
      record({ time: nowISO(), type, action:'delete_all', entity:key, details:{ removedAllCount: was.length } });
      snapshots[key] = [];
    }
    return out;
  };

  // ---- Last-resort polling (catches deletions made via stale bound refs) ----
  setInterval(() => {
    for (const k of WATCH){
      const before = snapshots[k];
      const after = safeParse(localStorage.getItem(k));
      if (!Array.isArray(after)) continue;
      if (after.length < before.length){
        const removed = diffRemoved(before, after);
        if (removed.length){
          const type = k==='iptv_resellers_v1' ? 'reseller' : 'mac';
          record({ time: nowISO(), type, action:'delete', entity:k, details:{ removed, lenBefore: before.length, lenAfter: after.length } });
        }
      }
      snapshots[k] = after;
    }
  }, 600); // low frequency to avoid overhead

  // Merge stored deletions into panel after your renderer shows (when panel becomes visible)
  const obs = new MutationObserver(() => {
    const p = elPanel();
    if (p && p.style.display !== 'none'){
      const c = elContainer();
      if (!c) return;
      const existing = (c.textContent || '').split('\n').filter(Boolean);
      const ours = load().map(lineFromEntry).filter(Boolean);
      const set = new Set(existing);
      let added = 0;
      for (const ln of ours){
        if (!set.has(ln)){
          const needsNL = c.textContent && !c.textContent.endsWith('\n');
          c.textContent += (needsNL? '\n':'') + ln;
          set.add(ln);
          added++;
        }
      }
      if (added) try { console.log(`[DEL-LOG] ${added} lignes fusionnées dans le panel`); } catch {}
    }
  });
  document.addEventListener('DOMContentLoaded', () => {
    const p = elPanel();
    if (p) obs.observe(p, { attributes:true, attributeFilter:['style','aria-hidden'] });
  });

  console.log('%cEARLY deletion logger actif (clients/resellers/MACs): proto+instance patch + polling', 'color:#22d3a3;font-weight:700');
})();
  </script>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>
   Gestionnaire Clients IPTV
  </title>
<style>
   :root{
      --bg:url('https://eagleiptv.cc/pntv/assets/img/login-bg/login-bg-27.jpg');
      --glass: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.18);
      --text: #f8fafc;
      --muted:#cbd5e1;
      --accent:#22d3a3; /* vert */
      --danger:#ff5d5d; /* rouge */
      --warning:#fbbf24;
      --ink:#020617;
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;background:#0b0f16}
    body::before{content:'';position:fixed;inset:0;background-image:var(--bg);background-size:cover;background-position:center;filter:brightness(.55) saturate(1.05);z-index:-2}
    body::after{content:'';position:fixed;inset:0;background:radial-gradient(800px 500px at 15% 10%, rgba(34,211,163,.18), transparent 60%),radial-gradient(700px 400px at 85% 90%, rgba(251,191,36,.12), transparent 60%),linear-gradient(to bottom, rgba(0,0,0,.3), rgba(0,0,0,.7));z-index:-1}

    .container{max-width:100%;margin:0 auto;padding:16px 24px}
    header{position:relative;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:120px;height:120px;display:grid;place-items:center}
    .logo img{width:120px;height:auto;filter: drop-shadow(0 10px 30px rgba(34,211,163,.35))}
    h1{font-size:22px;margin:0}

    .stats{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:10px 12px;border-radius:999px;background:var(--glass);border:1px solid var(--border);backdrop-filter:blur(8px);font-size:14px}
    .ok{color:var(--accent);font-weight:700}
    .low{color:var(--warning);font-weight:700}
    .zero{color:var(--danger);font-weight:700}

    /* Logout bouton (rouge, coin droit) */
    #btnLogout{
      background:var(--danger); color:#fff; font-weight:700;
      padding:10px 14px; border-radius:8px; border:none; cursor:pointer;
      box-shadow:0 6px 18px rgba(255,93,93,.35); transition:all .2s ease;
    }
    #btnLogout:hover{ background:#ff7676; }
    .logout-col{display:flex;flex-direction:column;align-items:flex-end;gap:6px;margin-bottom:6px}
    #who{ color:#f59e0b; font-weight:800; font-size:15px; }
    #btnLogout:hover{ background:#ff7676; }

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:var(--glass);border:1px solid var(--border);border-radius:18px;padding:16px;backdrop-filter:blur(10px);box-shadow:0 10px 30px rgba(0,0,0,.4)}
    @media(min-width:950px){.left{grid-column:span 4}.right{grid-column:span 8}}
    .card h2{margin:0 0 10px 0;color:var(--accent);font-size:18px}

    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){.row{grid-template-columns:repeat(2,1fr)}}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .input, select, input[type=date], input[type=password], input[type=number]{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(3,8,18,.65);color:var(--text);outline:none}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{appearance:none;border:none;padding:12px 14px;border-radius:12px;font-weight:700;cursor:pointer;color:#03120b;background:var(--accent);box-shadow:0 6px 18px rgba(34,211,163,.35);transition:transform .06s ease}
    .btn:active{transform:translateY(1px)}
    .btn-outline{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.28)}
    .btn-danger{background:var(--danger);color:#fff;box-shadow:0 6px 18px rgba(255,93,93,.35)}

    .search{display:flex;gap:8px;align-items:center}
    .search input{flex:1}

    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;font-size:12px;color:var(--muted);padding:8px;border-bottom:1px dashed rgba(255,255,255,.18)}
    tbody td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px}
    tbody tr:hover{background:rgba(255,255,255,.04)}
    .paid{color:var(--accent);font-weight:700}
    .unpaid{color:var(--danger);font-weight:700}

    .hint{font-size:12px;color:var(--muted);margin-top:6px}

    /* AUTH */
    .auth-wrap{position:fixed;inset:0;display:grid;place-items:center;padding:24px}
    .auth-card{width:min(520px, 96vw);background:var(--glass);border:1px solid var(--border);border-radius:20px;padding:18px 18px 22px;backdrop-filter:blur(10px);box-shadow:0 10px 30px rgba(0,0,0,.55)}
    .tabs{display:flex;background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:12px}
    .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer}
    .tab.active{background:rgba(0,0,0,.45);font-weight:700;color:var(--accent)}
    .auth-actions{display:flex;gap:8px;justify-content:center;margin-top:10px}
    .auth-hint{font-size:12px;color:var(--muted);margin-top:8px}

    .hidden{display:none !important}
  
    /* Tools button (blue) and dropdown */
    .btn-blue{
      appearance:none;border:none;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;
      color:#fff;background:#3b82f6; /* blue */ box-shadow:0 10px 30px rgba(59,130,246,.35);
      border:1px solid rgba(59,130,246,.5);
    }
    .tools-wrap{ position:relative; }
    .tools-menu{
      position:absolute; right:0; top:110%; min-width:260px;
      background:rgba(3,8,18,.9); border:1px solid var(--border); border-radius:12px; padding:10px;
      box-shadow:0 20px 50px rgba(0,0,0,.55); backdrop-filter: blur(10px); display:none; z-index:3000;
    }
    .tools-menu .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .tools-menu .btn-outline, .tools-menu .btn-danger{ padding:10px 12px; border-radius:10px; }
    .hidden{display:none !important}
    .icon-btn{
      appearance:none;border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.08);
      color:var(--text); border-radius:10px; padding:8px 10px; cursor:pointer;
      transition:transform .06s ease, background .2s ease;
    }
    .icon-btn:active{ transform: translateY(1px); }

  
    .btn-yellow{
      appearance:none;border:none;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;
      color:#000;background:#facc15; /* yellow */ box-shadow:0 10px 30px rgba(250,204,21,.35);
      border:1px solid rgba(250,204,21,.5);
    }
    #clientForm{ display:none; margin-top:16px; }

  
/* === Add Client (yellow) === */
.btn-yellow{
  appearance:none;border:1px solid rgba(234,179,8,.6);
  background:#facc15;color:#111;font-weight:800;
  padding:10px 14px;border-radius:999px;cursor:pointer;
  box-shadow:0 10px 30px rgba(250,204,21,.35);
}
/* Modal */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:2000;
}
.modal{
  width:min(560px,92vw);background:#0b1220;border:1px solid var(--border);
  border-radius:16px;padding:18px;box-shadow:0 30px 80px rgba(0,0,0,.6);
}
.modal .row{display:grid;grid-template-columns:1fr 1fr; gap:10px}
.modal .field{display:flex;flex-direction:column;gap:6px}
.modal h3{margin:0 0 8px 0}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media(max-width:720px){ .modal .row{grid-template-columns:1fr} }


/* === Couleurs colonnes Achat/Vente/Profit === */
td.col-achat {
  color: #facc15; /* jaune */
  font-weight: 700;
}
td.col-vente {
  color: #3b82f6; /* bleu */
  font-weight: 700;
}
td.col-profit {
  color: #22c55e; /* vert */
  font-weight: 700;
}


/* === Total à payer serveur en JAUNE === */
#totalToPay {
  color: #facc15 !important; /* jaune */
  font-weight: 800;
}


/* === Abonnement 1 an en mauve === */
td.col-type-1y {
  color: #a855f7; /* mauve */
  font-weight: 700;
}


/* === Username/Code en jaune === */
td.col-username {
  color: #facc15; /* jaune */
  font-weight: 700;
}


/* === Revamped Monthly Panel (design zwin) === */
.monthly-panel{
  position: fixed; right: 24px; top: 88px; width: min(420px, 92vw);
  background: radial-gradient(120% 100% at 0% 0%, rgba(34,211,163,.10), transparent 50%),
              radial-gradient(120% 100% at 100% 100%, rgba(99,102,241,.12), transparent 50%),
              rgba(3,8,18,.78);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 24px 80px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
  backdrop-filter: blur(12px);
  z-index: 1200;
}
.monthly-panel header{
  display:flex; align-items:center; justify-content:space-between;
  padding: 6px 8px 10px 8px; border-bottom: 1px dashed rgba(255,255,255,.12);
}
.monthly-panel h3{
  margin: 0; font-size: 16px;
  background: linear-gradient(90deg, #22d3a3, #60a5fa, #a78bfa);
  -webkit-background-clip: text; background-clip: text; color: transparent;
  font-weight: 800; letter-spacing: .3px;
  display:flex; align-items:center; gap:8px;
}
.monthly-panel h3::before{
  content: "📈";
}
.monthly-close{
  appearance:none; border:none; background:rgba(255,255,255,.06);
  color:#e5e7eb; width: 28px; height: 28px; border-radius: 8px;
  cursor:pointer; transition: transform .08s ease, background .2s ease, color .2s ease;
}
.monthly-close:hover{ background: rgba(255,255,255,.12); color:#fff; }
.monthly-close:active{ transform: translateY(1px); }

.monthly-summary{
  display:flex; align-items:center; justify-content:space-between;
  background: linear-gradient(180deg, rgba(34,211,163,.18), rgba(34,211,163,.10));
  border:1px solid rgba(34,211,163,.35);
  padding:10px 12px; border-radius: 12px; margin: 10px 4px 8px 4px;
  box-shadow: inset 0 -2px 0 rgba(0,0,0,.08);
}
.monthly-summary .title{
  font-size: 13px; color:#cbd5e1; font-weight:600;
}
.monthly-summary .value{
  font-weight:900; font-size:16px; color:#22d3a3;
}

.month-list{
  list-style:none; margin: 4px 0 0 0; padding:0; max-height: 56vh;
  overflow:auto; border-radius: 12px;
}
.month-item{
  display:grid; grid-template-columns: 1fr auto; align-items:center;
  gap:8px; padding: 10px 10px;
  border-bottom: 1px dashed rgba(255,255,255,.09);
  transition: background .2s ease, transform .06s ease;
}
.month-item:hover{ background: rgba(255,255,255,.05); }
.month-item:active{ transform: translateY(1px); }
.m-name{
  color:#e5e7eb; font-weight:700; letter-spacing:.2px;
}
.m-amt{
  font-weight:900;
}
.m-amt.pos{ color: #22c55e; }  /* green */
.m-amt.neg{ color: #ff5d5d; }  /* red */

.month-list::-webkit-scrollbar{ width:10px }
.month-list::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, rgba(96,165,250,.5), rgba(167,139,250,.5));
  border-radius:999px; border:2px solid rgba(3,8,18,.6);
}
.month-list::-webkit-scrollbar-track{ background: transparent; }

.monthly-panel .hint{
  margin-top:8px; font-size:12px; color:#94a3b8;
}
  </style>
<style>
   /* New Monthly Earning button & panel (non-invasive) */
    #gainMonthly{ display:none !important; } /* hide original text value */
    .pill-btn{
      padding:10px 14px;border-radius:999px;background:linear-gradient(180deg, rgba(34,211,163,.95), rgba(34,211,163,.8));
      border:1px solid rgba(34,211,163,.45); color:#03120b; font-weight:800; cursor:pointer;
      box-shadow:0 10px 30px rgba(34,211,163,.35), inset 0 -2px 0 rgba(0,0,0,.08);
      backdrop-filter:blur(8px); transition:transform .06s ease, filter .2s ease;
      margin-left:8px;
    }
    .pill-btn:active{ transform: translateY(1px); }
    .monthly-panel{
      position:fixed; right:24px; top:88px; width:min(360px, 92vw);
      background:rgba(3,8,18,.75); border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow:0 20px 50px rgba(0,0,0,.55); backdrop-filter: blur(10px); z-index:1000;
      display:none;
    }
    .monthly-panel header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
    .monthly-panel h3{ margin:0; font-size:16px; color:var(--accent) }
    .monthly-close{
      appearance:none; border:none; background:transparent; color:var(--muted); font-size:18px; cursor:pointer;
    }
    .month-list{ list-style:none; margin:0; padding:0; max-height:50vh; overflow:auto }
    .month-item{ display:flex; align-items:center; justify-content:space-between; padding:10px 8px;
      border-bottom:1px dotted rgba(255,255,255,.12); font-size:14px }
    .month-item .m-name{ color:#e5e7eb; font-weight:600 }
    .month-item .m-amt{ color:var(--accent); font-weight:800 }
    .hint{ margin-top:8px; font-size:12px; color:var(--muted) }
  </style>
<style>
   /* Variant C: Minimal Bar */
.stats-card{grid-column:1 / -1; padding:10px 0; background:transparent; border:none; box-shadow:none}
.stats-card > h3{display:none}
.stats-card .stats{display:flex; flex-wrap:wrap; gap:8px 10px; align-items:center; padding:4px 0; border-top:1px solid rgba(255,255,255,.08); border-bottom:1px solid rgba(255,255,255,.08)}
.stats-card .pill{background:transparent; border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:999px; box-shadow:none}
.stats-card .pill-btn{border-radius:999px; padding:8px 12px}
  </style>
<style>
   /* Dates color coding */
.date-start{ color: var(--accent); font-weight: 700; } /* green */
.date-end{ color: var(--danger); font-weight: 700; }   /* red */
  </style>
<style>
   .card.right {
  position: relative;
  position: relative;
  background: linear-gradient(to bottom right, rgba(3, 8, 18, 0.6), rgba(0, 0, 0, 0.6));
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 20px;
  padding: 20px;
  transition: all 0.3s ease;
}
.card.right:hover {
  transform: scale(1.01);
  border-color: var(--accent);
}
  </style>
<style>
   /* === Professional Header Styling === */
header {
  position: sticky;
  top: 0;
  z-index: 999;
  background: rgba(3, 8, 18, 0.75);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding: 16px 24px;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
}
header .brand {
  display: flex;
  align-items: center;
  gap: 16px;
}
header .logo img {
  width: 120px;
  height: auto;
}
header h1 {
  font-size: 20px;
  margin: 0;
  color: var(--accent);
}
header .hint {
  font-size: 12px;
  color: var(--muted);
}
header .tools-wrap {
  display: flex;
  align-items: center;
  gap: 12px;
}
  </style>
<style>
   /* Align logout-col to the far right */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}
.logout-col {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: center;
  gap: 6px;
  margin-left: auto;
  text-align: right;
}
  </style>
<style>
   .client-id {
  color: var(--accent);
  color: var(--muted);
  font-weight: 600;
  font-size: 13px;
}
  </style>
<style>
   /* === Zwin Button Effacer === */
#btnClear {
  padding: 10px 16px;
  border-radius: 999px; /* rond pill */
  background: linear-gradient(90deg, rgba(239,68,68,.9), rgba(239,68,68,.7));
  color: #fff;
  font-weight: 700;
  border: 1px solid rgba(239,68,68,.6);
  box-shadow: 0 6px 18px rgba(239,68,68,.35);
  cursor: pointer;
  transition: all .25s ease;
}
#btnClear:hover {
  background: linear-gradient(90deg, rgba(239,68,68,1), rgba(220,38,38,.9));
  transform: scale(1.05);
  box-shadow: 0 8px 22px rgba(239,68,68,.55);
}
#btnClear:active {
  transform: scale(0.97);
}
  </style>
<!-- removed corrupted <style> block -->
<style>
   @keyframes blink { 0%,50%,100%{opacity:1} 25%,75%{opacity:0} }
.expired { color:#ff5d5d; font-weight:900; animation: blink 1s infinite; }
  </style>
<style>
   #monthlyPanel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:5000}
#monthlyPanel .panel-content{background:linear-gradient(160deg,rgba(3,8,18,.95),rgba(15,23,42,.95));border:1px solid rgba(255,255,255,.15);border-radius:20px;width:min(480px,95vw);max-height:80vh;padding:20px;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,.6);backdrop-filter:blur(10px);animation:popupScale .25s ease}
@keyframes popupScale{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
#monthlyPanel h3{margin:0 0 12px;font-size:18px;color:var(--accent);display:flex;justify-content:space-between;align-items:center}
#monthlyPanel .month-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.1)}
  </style>
<style>
   .generic-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:6000}
.generic-modal .gm-content{background:linear-gradient(160deg,rgba(3,8,18,.95),rgba(15,23,42,.95));border:1px solid rgba(255,255,255,.15);border-radius:20px;width:min(560px,95vw);max-height:80vh;padding:20px;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,.6);backdrop-filter:blur(10px);animation:popupScale .25s ease}
.generic-modal .gm-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.generic-modal .gm-title{margin:0;font-size:18px;color:var(--accent);font-weight:800}
.generic-modal .gm-close{appearance:none;border:none;background:rgba(255,255,255,.06);color:#e5e7eb;width:32px;height:32px;border-radius:10px;cursor:pointer}
.generic-modal .gm-close:hover{background:rgba(255,255,255,.12);color:#fff}
.btn-save{appearance:none;border:none;padding:10px 16px;border-radius:999px;font-weight:800;cursor:pointer;color:#000;background:#facc15;box-shadow:0 8px 22px rgba(250,204,21,.4);border:1px solid rgba(250,204,21,.5);transition:transform .08s ease,background .2s ease;font-size:15px;letter-spacing:.3px}
.btn-save:hover{background:#fde047}.btn-save:active{transform:scale(.97)}
.toast-success{display:none;background:linear-gradient(180deg,rgba(34,197,94,.15),rgba(34,197,94,.10));border:1px solid rgba(34,197,94,.45);color:#bbf7d0;padding:10px 14px;border-radius:12px;font-weight:800;letter-spacing:.3px;box-shadow:0 12px 30px rgba(0,0,0,.35),inset 0 -2px 0 rgba(0,0,0,.08);animation:slideUpFade .25s ease}
@keyframes slideUpFade{from{transform:translateY(6px);opacity:0}to{transform:translateY(0);opacity:1}}
.clients-count{margin:0 0 6px 0;font-size:15px;font-weight:600;color:#cbd5e1;text-align:right}
.count-green{color:#22c55e;font-weight:900;font-size:16px}
/* Paiement select */
.pay-select{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.22);background:rgba(3,8,18,.65);color:var(--text);font-size:14px;outline:none}
.pay-select:focus{border-color:rgba(34,211,163,.55);box-shadow:0 0 0 3px rgba(34,211,163,.18)}

.card.right {
  max-width: 900px;   /* limit width */
  margin: auto;       /* center */
  padding: 12px;      /* smaller padding */
  font-size: 13px;    /* smaller text */
}
.card.right h2 {
  font-size: 16px;    /* smaller heading */
}
.card.right table thead th,
.card.right table tbody td {
  font-size: 12px;    /* smaller table text */
}


/* === Full-width layout overrides === */
.container{max-width:100% !important;}
.card.right{
  max-width:none !important;
  width:100% !important;
  margin:0 !important;
  padding:16px;        /* comfortable padding */
  font-size:14px;      /* readable body size */
}
.card.right h2{ font-size:18px; }
.card.right table thead th,
.card.right table tbody td{ font-size:13px; }


/* === Force the .right card to take the full grid width on large screens === */
@media(min-width:950px){
  .right{ grid-column: 1 / -1 !important; }
}


/* inline country input in table */
td input.country-input{
  padding:8px 10px;
  border-radius:10px;
  width: 140px;
}
  </style>
<!-- removed corrupted <style> block -->
<!-- removed corrupted <style> block -->
<!-- removed corrupted <style> block -->
<style>
   /* === Mobile Hamburger + Menu === */
.menu-btn { display:none; }
.mobile-menu { display:none; }
@media (max-width: 768px){
  /* place hamburger at top-right */
  .menu-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    position:absolute;
    right:16px;
    top:16px;
    font-size:22px;
    padding:6px 10px;
    background:rgba(255,255,255,.08);
    color:var(--text);
    border:1px solid rgba(255,255,255,.18);
    border-radius:10px;
    cursor:pointer;
  }
  .menu-btn:active{ transform: translateY(1px); }

  .mobile-menu{
    position:absolute;
    top:64px;
    left:12px;
    right:12px;
    background:linear-gradient(160deg, rgba(16,24,40,0.95), rgba(3,8,18,0.95));
    border:1px solid rgba(255,255,255,0.12);
    border-radius:16px;
    padding:16px;
    box-shadow:0 12px 40px rgba(0,0,0,.55);
    backdrop-filter: blur(12px);
    display:none;
    flex-direction:column;
    gap:12px;
    z-index:3000;
  }
  .mobile-menu.show{ display:flex; animation: slideDown .25s ease forwards; }
  @keyframes slideDown{ 0%{ transform:translateY(-10px); opacity:0 } 100%{ transform:translateY(0); opacity:1 } }

  .mobile-item{
    appearance:none;
    border:none;
    border-radius:12px;
    padding:12px;
    font-weight:700;
    letter-spacing:.3px;
    cursor:pointer;
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
  }
  .mobile-item:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.25); }
  .mobile-item:active{ transform: scale(0.97); }

  /* colored buttons */
  #mobileAddClient{ background:linear-gradient(90deg,#facc15,#fbbf24); color:#111; }
  #mobileTools{ background:linear-gradient(90deg,#3b82f6,#2563eb); color:#fff; }
  #mobileSettings{ background:linear-gradient(90deg,#22d3a3,#10b981); color:#03120b; }
  #mobileLogout{ background:linear-gradient(90deg,#ef4444,#dc2626); color:#fff; }
}
  </style>
<style>
   /* === Mobile: hide header buttons; show only hamburger menu === */
@media (max-width: 768px){
  header .tools-wrap,
  header .logout-col,
  header #btnAddClientOpen,
  header #btnTools,
  header #btnLogout,
  header #btnSettings {
    display: none !important;
  }
}
  </style>
<style>
   @media (max-width: 768px){
  #toolsOverlay { display: none; }
  #toolsOverlay[aria-hidden="false"] { display: flex !important; }
}
  </style>
<style>
   /* === Settings Overlay Modal === */
.gm-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 4000;
}
.gm-modal{
  width: min(640px, 92vw);
  max-height: 86vh;
  overflow: auto;
  background: rgba(15,23,42,0.96);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.5);
  padding: 14px;
}
.gm-modal-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 8px;
  padding: 4px 2px 10px 2px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.gm-modal-header h3{
  margin:0;
  font-size: 18px;
}
.gm-close{
  border:none;
  background: transparent;
  color: var(--text);
  font-size: 22px;
  cursor: pointer;
}
.gm-modal-footer{
  display:flex;
  justify-content:flex-end;
  gap: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255,255,255,0.08);
}
.btn-save{
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.18);
  background: linear-gradient(90deg, #22d3a3, #10b981);
  color: #03120b;
  font-weight: 700;
  cursor:pointer;
}
  </style>
<style>
   /* === Mobile width/overflow fixes === */
html, body { max-width: 100%; overflow-x: hidden; }
* { box-sizing: border-box; }

/* Ensure main containers never exceed viewport width */
#app, .container, .wrap, .content, .card { max-width: 100%; }

/* Images and logos scale down */
img, svg { max-width: 100%; height: auto; }

/* Buttons and inputs avoid forcing width */
button, select, input { max-width: 100%; }

/* Tables: allow horizontal scroll inside wrapper instead of stretching page */
.table-wrap, .table-container {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
table { width: 100%; border-collapse: collapse; }
table th, table td { white-space: nowrap; } /* keep rows tidy on narrow screens */

/* Prevent absolutely positioned elements from creating extra width */
header .menu-btn { right: 12px; }
@media (max-width: 420px){
  body { padding-right: 0 !important; }
  header { padding-left: 12px; padding-right: 12px; }
  .card.right .search { padding: 8px; gap: 8px; }
  #btnClear { width: auto; }
}

/* Avoid large margin that could push content */
.section, .stats, .cards { margin-left: 0; margin-right: 0; }
  </style>
<style>
   /* === Mobile zoom & sizing normalization === */
@media (max-width: 480px){
  html { font-size: 14px; }              /* shrink base type */
  body { line-height: 1.35; }
  header h1 { font-size: 1.1rem; }

  /* Compact chips/buttons */
  .btn, .btn-outline, .btn-danger, .btn-save, .mobile-item {
    padding: 8px 12px !important;
    border-radius: 10px !important;
    font-size: 0.95rem !important;
  }

  /* Search cluster compact */
  .card.right .search .input { height: 38px !important; }
  #filterPaid, #btnClear { height: 38px !important; }

  /* Table text a bit smaller */
  table th, table td { font-size: 0.9rem; }

  /* Ensure controls don't trigger iOS zoom on focus */
  input, select, textarea { font-size: 16px; }

  /* Logo & header spacing */
  header .logo img { max-width: 90px; }
  header { padding-top: 10px; padding-bottom: 10px; }
}
  </style>
<style>
   /* === Row Actions Dropdown === */
.actions-dropdown{ position: relative; display:inline-block; }
.actions-btn{
  padding: 8px 14px; border-radius: 10px;
  background: linear-gradient(90deg,#3b82f6,#2563eb);
  color:#fff; font-weight:700; border:1px solid rgba(59,130,246,.6);
  box-shadow:0 6px 16px rgba(59,130,246,.35); cursor:pointer;
}
.actions-menu{
  position:absolute; top:110%; right:0; min-width:180px;
  background:rgba(3,8,18,.95); border:1px solid rgba(255,255,255,.12);
  border-radius:10px; padding:6px; display:none; flex-direction:column;
  box-shadow:0 12px 28px rgba(0,0,0,.55); z-index:2200;
}
.actions-menu.hidden{ display:none; }
.actions-dropdown.open .actions-menu{ display:flex; }
.actions-menu .menu-item{
  appearance:none; border:none; background:transparent;
  padding:10px 12px; text-align:left; color:#e5e7eb; font-weight:700;
  border-radius:8px; cursor:pointer;
}
.actions-menu .menu-item:hover{ background:rgba(255,255,255,.08); }
.actions-menu .danger{ color:#f87171; }
  </style>
<style>
   /* Override: larger logo on small screens */
@media (max-width: 480px){
  header .logo img { max-width: 115px !important; }
}
  </style>
<style>
   /* Fix: Add spacing below burger menu on mobile for title/hint */
@media (max-width: 480px){
  header + div h1 {
    margin-top: 20px !important;
  }
  header + div .hint {
    margin-top: 8px !important;
    display: block;
  }
}
  </style>
<style>
   /* Stronger fix: Larger spacing below burger menu on mobile for title/hint */
@media (max-width: 480px){
  header + div h1 {
    margin-top: 50px !important;
  }
  header + div .hint {
    margin-top: 20px !important;
    display: block;
  }
}
  </style>
<style>
   /* Bold H1 for mobile view */
@media (max-width: 480px){
  h1 {
    font-weight: 900 !important;
  }
}
  </style>
<style>
   /* Bigger and bold H1 for mobile view */
@media (max-width: 480px){
  h1 {
    font-weight: 900 !important;
    font-size: 1.6rem !important;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
}
  </style>
<style>
   /* Professional style H1 for mobile */
@media (max-width: 480px){
  h1 {
    font-size: 1.8rem !important;
    font-weight: 800 !important;
    text-align: center;
    background: linear-gradient(90deg, #3b82f6, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 0.5px;
    margin-top: 40px !important;
  }
}
  </style>
<!-- Reseller Feature Styles (injected) -->
<style id="reseller-css">
   .btn-brown{
    appearance:none;border:1px solid rgba(120,72,0,.45);
    background:#8B5E34;color:#fff;font-weight:800;
    padding:10px 14px;border-radius:999px;cursor:pointer;
    box-shadow:0 10px 30px rgba(139,94,52,.35);
    transition:transform .06s ease, filter .2s ease, background .2s ease;
  }
  .btn-brown:hover{ filter:brightness(1.05); }
  .btn-brown:active{ transform:translateY(1px); }
  .tag{ display:inline-block;padding:4px 8px;border-radius:999px;
        background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);
        font-size:12px }
  .actions-dropdown{ position:relative; display:inline-block }
  .actions-btn{ padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);
                background:transparent;color:#fff;cursor:pointer }
  .actions-menu{ position:absolute; right:0; top:100%; min-width:140px; margin-top:6px;
                 background:rgba(3,8,18,.95); border:1px solid rgba(255,255,255,.12);
                 border-radius:12px; padding:6px; box-shadow:0 10px 30px rgba(0,0,0,.4) }
  .actions-menu.hidden{ display:none }
  .menu-item{ display:block; width:100%; text-align:left; padding:8px 10px;
              border-radius:8px; background:transparent; color:#e5e7eb; border:none; cursor:pointer }
  .menu-item:hover{ background:rgba(255,255,255,.06) }
  .menu-item.danger{ color:#ff7a7a }
  </style>
<style id="reseller-floating-menu-css">
   .reseller-floating-menu{
    position:fixed;min-width:160px;background:rgba(3,8,18,.98);
    border:1px solid rgba(255,255,255,.14);border-radius:12px;
    box-shadow:0 12px 40px rgba(0,0,0,.45);padding:6px;z-index:99999;
  }
  .reseller-floating-menu .menu-item{display:block;width:100%;text-align:left;padding:8px 10px;border-radius:8px;background:transparent;color:#e5e7eb;border:none;cursor:pointer}
  .reseller-floating-menu .menu-item:hover{background:rgba(255,255,255,.06)}
  .reseller-floating-menu .menu-item.danger{color:#ff7a7a}
  </style>
<style id="modal-responsive-fix">
   @media (max-width: 600px) {
  .generic-modal .gm-content {
    max-width: 95% !important;
    min-width: auto !important;
    width: 95% !important;
    margin: 0 auto;
    border-radius: 12px;
  }
  .gm-header h3 {
    font-size: 16px;
  }
  .gm-content .field label {
    font-size: 14px;
  }
  .gm-content .input {
    font-size: 14px;
    padding: 6px 8px;
  }
  .gm-content .actions button {
    font-size: 14px;
    padding: 6px 10px;
  }
}
  </style>
<style>
   /* MOBILE-TOOLS */
@media (max-width: 640px){
  .mobile-tools {
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: 12px;
    display: flex;
    gap: 8px;
    z-index: 9999;
    pointer-events: none; /* container ignores clicks */
  }
  .mobile-tools .btn {
    pointer-events: auto; /* buttons receive clicks */
    flex: 1;
    padding: 10px 12px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,.22);
  }
  .mobile-tools .btn-backup { background:#2b2b2b; color:#fff; border:1px solid rgba(255,255,255,.15); }
  .mobile-tools .btn-restore{ background:#8b5cf6; color:#fff; border:none; }
}
@media (min-width: 641px){
  .mobile-tools{ display:none; }
}
  </style>
<style>
   /* BTN-RESELLER-GAIN */
#btnResellerGain {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: #fff;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
  transition: all 0.25s ease;
}
#btnResellerGain:hover {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  box-shadow: 0 6px 16px rgba(37, 99, 235, 0.55);
  transform: translateY(-2px);
}
#btnResellerGain:active {
  transform: scale(0.97);
}
  </style>
<style>
   /* STATS-CENTER */
.stats { display:flex; justify-content:center; }
  </style>
<style id="reseller-floating-menu-style">
   .reseller-floating-menu{
  position: fixed;
  z-index: 2147483647;
  top: 0; left: 0;
  display: inline-flex;
  flex-direction: column;
  min-width: 200px;
  padding: 6px;
  background: #1e1e2f; /* dark background */
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0,0,0,.5);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: #f1f1f1;
}
.reseller-floating-menu .menu-item{
  display: block;
  width: 100%;
  padding: 10px 12px;
  text-align: left;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 14px;
  color: #f1f1f1;
  border-radius: 4px;
}
.reseller-floating-menu .menu-item:hover{
  background: #2c2c40;
}
.reseller-floating-menu .menu-item.danger{
  color: #ff4d4f;
}
.reseller-floating-menu .menu-item.danger:hover{
  background: #3a1f1f;
}
  </style>
<style id="reseller-pills-style">
   .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;line-height:1;}
.pill-green{background:#16a34a;color:#ecfdf5;}
.pill-grey{background:#374151;color:#e5e7eb;}
  </style>
<style>
   .yellow {
  color: #facc15; /* amber yellow */
  font-weight: bold;
}
  </style>
<!-- Leaflet for Statistiques (choropleth world map) -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
   /* --- Device stats renderer (robust, uses in-memory state or multiple storage keys) --- */
function getClientsForCurrentUser() {
  try {
    // Prefer in-memory state if available
    if (window.state && Array.isArray(state.clients)) return state.clients;

    // Determine current user from known keys
    const user = (window.state && state.user) || localStorage.getItem(LS_CURRENT) || localStorage.getItem('iptv_current_user_v1') || '';

    // candidate keys (per-user and global)
    const candidateKeys = [];
    if (user) {
      candidateKeys.push(`iptv_clients_v4__${user}`, `iptv_clients__${user}`, `iptv_clients_v4__${user}`, `iptv_clients__${user}`);
    }
    candidateKeys.push('iptv_clients_v4', 'iptv_clients', `iptv_clients_v4__${user}`, `iptv_clients__${user}`);

    // try each key until we find an array
    for (const key of candidateKeys) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) continue;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
      } catch (e) { /* ignore and continue */ }
    }

    // fallback: parse current table rows (#tbody) if present
    const rows = Array.from(document.querySelectorAll('#tbody tr'));
    if (rows.length) {
      const out = [];
      rows.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (!tds || tds.length < 4) return;
        const dev = (tds[3].textContent || '').trim(); // 4th column is Device/APP
        if (dev) out.push({ device: dev });
      });
      if (out.length) return out;
    }

    // last fallback: empty array
    return [];
  } catch (err) {
    console.error('getClientsForCurrentUser error', err);
    return [];
  }
}

const mobileBtn = document.getElementById('mobileStats');
    if(mobileBtn && !mobileBtn.__deviceStatsBound){ mobileBtn.addEventListener('click', renderDeviceStats); mobileBtn.__deviceStatsBound = true; }

    const closeStats = document.getElementById('closeStats');
    if(closeStats && !closeStats.__deviceStatsBound){ closeStats.addEventListener('click', renderDeviceStats); closeStats.__deviceStatsBound = true; }

    // Observe client list changes (tbody) so stats update when clients are added/removed
    try{
      const listTbody = document.getElementById('tbody');
      if(listTbody && !listTbody.__deviceStatsObserverBound){
        const mo = new MutationObserver(function(){ try{ renderDeviceStats(); }catch(e){} });
        mo.observe(listTbody, { childList: true, subtree: true });
        listTbody.__deviceStatsObserverBound = true;
      }
    }catch(e){ /* ignore */ }
  }catch(e){ console.warn('attachDeviceStatsListeners failed', e); }
}
// Attach on DOM ready
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachDeviceStatsListeners);
else attachDeviceStatsListeners();
/* --- end device stats block --- */

document.getElementById("btnStats").addEventListener("click", () => {
  renderDeviceStats();
});
  </script>
<style>
   /* stats modal larger width */
#statsModal .gm-content { max-width: 1100px; width: 95vw; }
#mapLegend { background: rgba(255,255,255,0.95); color:#111; padding:8px 10px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.12); font-weight:700; }
.leaflet-container { border-radius:12px; }
  </style>
<style id="mobile-stats-style">
   @media (max-width: 768px){
  .mobile-item.mobile-yellow, .mobile-item#mobileStats {
    background: linear-gradient(90deg, #facc15, #fbbf24);
    color: #111 !important;
    font-weight: 800;
    border: 1px solid rgba(234,179,8,.6);
    box-shadow: 0 6px 18px rgba(250,204,21,.35);
  }
  .mobile-item.mobile-yellow:hover, .mobile-item#mobileStats:hover {
    filter: brightness(1.05);
    transform: scale(1.03);
  }
  .mobile-item.mobile-yellow:active, .mobile-item#mobileStats:active {
    transform: scale(0.97);
  }
}
  </style>
<style>
   .leaflet-overlay-pane text {
  fill: #fff !important;
  font-weight: 900 !important;
  text-shadow: 0 0 4px #000;
  font-size: 14px !important;
}
  </style>
<style>
   .country-label {
  color: #fff;
  font-weight: 900;
  text-shadow: 0 0 4px #000;
  font-size: 14px;
  pointer-events: none;
}
  </style>
<style id="mobile-reseller-style">
   @media (max-width: 768px){
  #mobileResellerGain {
    background: linear-gradient(135deg, #8B5E34, #7B4A28);
    color: #fff;
    font-weight: 800;
    border: 1px solid rgba(120,72,0,.45);
    box-shadow: 0 6px 18px rgba(139,94,52,.35);
  }
  #mobileResellerGain:hover {
    filter: brightness(1.05);
  }
}
  </style>
<style>
   #btnResellerGain {
  background: linear-gradient(135deg, #8B5E34, #7B4A28) !important;
  color: #fff !important;
  font-weight: 800 !important;
  border: 1px solid rgba(120,72,0,.45) !important;
  box-shadow: 0 6px 18px rgba(139,94,52,.35) !important;
  border-radius: 9999px !important;
}
#btnResellerGain:hover {
  filter: brightness(1.05) !important;
}
  </style>
<style id="actions-css-clean">
   /* ==== Actions du tableau (CSS PROPRE - injecté) ==== */
.actions-dropdown{ position: relative; display:inline-block; }
.actions-btn{
  padding: 8px 14px; border-radius: 10px;
  background: linear-gradient(90deg,#3b82f6,#2563eb);
  color:#fff; font-weight:700; border:1px solid rgba(59,130,246,.6);
  box-shadow:0 6px 16px rgba(59,130,246,.35); cursor:pointer;
}
.actions-menu{
  position:absolute; top:110%; right:0; min-width:180px;
  background:#0b1220; border:1px solid rgba(255,255,255,.12);
  border-radius:10px; padding:6px; display:none; flex-direction:column;
  box-shadow:0 12px 28px rgba(0,0,0,.55); z-index:2200;
}
.actions-dropdown.open .actions-menu{ display:flex; }
.actions-menu .menu-item{
  appearance:none; border:none; background:transparent;
  padding:10px 12px; text-align:left; color:#e5e7eb; font-weight:700;
  border-radius:8px; cursor:pointer;
}
.actions-menu .menu-item:hover{ background:rgba(255,255,255,.08); }
.actions-menu .danger{ color:#f87171; }
  </style>
<style id="logsPanelSpacingStyle">
   /* Stable visual spacing between log lines */
#logsPanel #logsContainer {
  white-space: pre-wrap;
  line-height: 1.8; /* tweak to 2.0 if you want more space */
}
  </style>
<style>
   /* LOGS COLORIZER (injected) */
#logsContainerView.logs-view {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 13px;
  line-height: 1.9;
  white-space: pre-wrap;
}
#logsContainerView .log-line { display: block; }
#logsContainerView .log-add { color: #22c55e; font-weight: 600; }   /* green */
#logsContainerView .log-delete { color: #f97316; font-weight: 600; }/* orange */
  </style>
</head>
<body>
<!-- AUTH OVERLAY -->
<div class="auth-wrap hidden" id="auth">
<div class="auth-card">
<div style="text-align:center; margin-bottom:18px;">
<img alt="IPTV Manager Logo" src="assets/img/logo.png" style="width:200px; filter: drop-shadow(0 0 15px rgba(34,211,163,.5));"/>
</div>
<div class="tabs">
<div class="tab active" id="tabLogin">
      Se connecter
     </div>
<div class="tab" id="tabSignup">
      Créer un compte
     </div>
</div>
<div id="loginForm">
<div class="field">
<label>
       Nom d'utilisateur
      </label>
<input class="input" id="authUser" placeholder="ex: mohcine"/>
</div>
<div class="field">
<label>
       Mot de passe
      </label>
<input class="input" id="authPass" placeholder="••••••" type="password"/>
</div>
<div class="auth-actions">
<button class="btn" id="btnLogin">
       Connexion
      </button>
</div>
<div class="auth-hint" id="authMsg">
</div>
</div>
<div class="hidden" id="signupForm">
<div class="field">
<label>
       Nom d'utilisateur
      </label>
<input class="input" id="suUser" placeholder="ex: papa"/>
</div>
<div class="field">
<label>
       Mot de passe (min 6 caractères)
      </label>
<input class="input" id="suPass" type="password"/>
</div>
<div class="field">
<label>
       Confirmer le mot de passe
      </label>
<input class="input" id="suPass2" type="password"/>
</div>
<div class="auth-actions">
<button class="btn" id="btnSignup">
       Créer le compte
      </button>
</div>
<div class="auth-hint" id="suMsg">
</div>
</div>
</div>
</div>
<!-- APP -->
<div class="hidden" id="app">
<header>
<div class="brand">
<div class="logo">
<img alt="IPTV Manager" src="assets/img/logo.png"/>
</div>
<button aria-controls="mobileMenu" aria-expanded="false" aria-label="Menu" class="menu-btn" id="menuToggle">
      ☰
     </button>
<div aria-hidden="true" class="mobile-menu" id="mobileMenu">
<!-- Added: View Logs button for mobile -->
<button class="btn-outline" id="btnViewLogs">
       📜 Voir les Logs
      </button>
<div class="mobile-user" style="text-align:center; color:var(--accent); font-weight:700; margin-bottom:8px;">
       👤 Connecté :
       <span id="currentClientMobile">
        —
       </span>
</div>
<button class="mobile-item" id="mobileFullRestore">
       ♻️ Restore
      </button>
<button class="mobile-item" id="mobileFullBackup">
       📦 Backup
      </button>
<button class="mobile-item" id="mobileResetData">
       🧨 Reset Data
      </button>
<button class="mobile-item" id="mobileAddClient">
       Add Client
      </button>
<button class="mobile-item" id="mobileResellerGain" type="button">
       $ Resellers Price $
      </button>
<button class="mobile-item" id="mobileStats">
       📊 Statistiques
      </button>
<button class="mobile-item" id="mobileSettings">
       Settings
      </button>
<button class="mobile-item" id="mobileLogout">
       Logout
      </button>
</div>
<div>
<h1>
       IPTV MANAGER
      </h1>
<div class="hint">
       Developper par
       <strong>
        Mohcine
       </strong>
       All Rights Reserved
      </div>
</div>
</div>
<!-- username moved above logout button as requested -->
<div class="tools-wrap">
<button class="icon-btn" id="btnSettings" title="Paramètres">
      ⚙️
     </button>
<button class="btn-yellow" id="btnAddClientOpen">
      Add Client
     </button>
<button class="btn-brown" id="btnResellerGain" type="button">
      $ Resellers Price $
     </button>
<button class="btn-yellow" id="btnStats">
      📊 Statistiques
     </button>
</div>
<div class="tools-wrap">
<button class="btn-blue" id="btnTools" title="Outils">
      Tools
     </button>
<div aria-hidden="true" class="tools-menu" id="toolsMenu">
<button class="btn-outline" id="btnViewLogsDesktop">
       📜 Voir les Logs
      </button>
<div class="actions" style="gap:8px;margin:10px 0">
<button id="btnFullRestore">
        ♻️ Restore
       </button>
<button id="btnFullBackup">
        📦 Backup
       </button>
<button id="btnResetData">
        🧨 Reset Data
       </button>
<input accept="application/json" id="restoreFile" style="display:none" type="file"/>
<input accept="application/json" id="restoreInput" style="display:none" type="file"/>
</div>
<div class="actions">
<input accept="application/json" id="fileImport" style="display:none" type="file"/>
</div>
</div>
</div>
<div class="logout-col">
<div class="client-id">
      Client :
      <span id="currentClient">
       —
      </span>
</div>
<div style="display:flex; gap:8px;">
</div>
<div class="logout-row">
<button id="btnLogout">
       Logout
      </button>
</div>
</div>
</header>
<div aria-hidden="true" class="generic-modal" id="settingsOverlay">
<div class="gm-content">
<div class="gm-header">
<h3 class="gm-title">
       Paramètres
      </h3>
<button class="gm-close" id="closeSettings">
       ×
      </button>
</div>
<div class="toast-success" id="settingsToast">
      Paramètres sauvegardées ✓
     </div>
<div id="settingsMount">
</div>
<div class="actions" style="justify-content:center; margin-top:20px;">
<button class="btn-save" id="btnSaveSettings">
       Save
      </button>
</div>
</div>
</div>
<div aria-hidden="true" class="generic-modal" id="toolsOverlay">
<div class="gm-content">
<div class="gm-header">
<h3 class="gm-title">
       Outils
      </h3>
<button class="gm-close" id="closeTools">
       ×
      </button>
</div>
<div class="actions" style="justify-content:flex-start">
<button class="btn-outline" id="toolsExport">
       Exporter JSON
      </button>
<button class="btn-outline" id="toolsImport">
       Importer JSON
      </button>
<button class="btn-danger" id="toolsReset">
       Tout réinitialiser (compte)
      </button>
</div>
<p class="hint" style="margin-top:10px">
      L'import utilise le même sélecteur de fichier caché.
     </p>
</div>
</div>
<!-- Add Client Modal -->
<div aria-hidden="true" class="modal-backdrop" id="addClientModal">
<div class="modal">
<h3>
      Ajouter un client
     </h3>
<div class="row">
<div class="field">
<label>
        Nom
       </label>
<input class="input" id="m_name" placeholder="ex: Yassine"/>
</div>
<div class="field">
<label>
        Username / Code
       </label>
<input class="input" id="m_username" placeholder="ex: yassine_123"/>
</div>
<div class="field">
<label>
        Adresse MAC
       </label>
<input class="input" id="m_mac" placeholder="ex: AA:BB:CC:DD:EE:FF"/>
</div>
<div class="field">
<label>
        Date de début
       </label>
<div style="display:flex; gap:8px; align-items:center">
<input class="input" id="m_start" type="date"/>
<button class="icon-btn" id="m_start_btn" title="Ouvrir le calendrier" type="button">
         📅
        </button>
</div>
</div>
<div class="field">
<label>
        Type d'abonnement
       </label>
<select class="input" id="m_type">
<option selected="" value="1y">
         1 an
        </option>
</select>
</div>
<div class="field">
<label>
        Prix de vente (DH)
       </label>
<input class="input" id="m_sale" min="0" placeholder="ex: 300" step="1" type="number"/>
</div>
<div class="field">
<label>
        Device/APP
       </label>
<select class="input" id="m_device">
<option value="Eagle 3.8">
         Eagle 3.8
        </option>
<option selected="" value="Eagle Pro (code)">
         Eagle Pro (code)
        </option>
<option value="Hot Player">
         Hot Player (LG/Samsung)
        </option>
<option value="Iptv Smarters">
         Iptv Smarters (LG/Samsung)
        </option>
<option value="IOS (iPhone)">
         IOS (iPhone)
        </option>
<option value="IOS (IPAD)">
         IOS (IPAD)
        </option>
<option value="STB (Receiver)">
         STB (Receiver)
        </option>
</select>
</div>
<div class="field">
<label>
        Country
       </label>
<input class="input" id="m_country" placeholder="ex: Maroc"/>
</div>
<div class="field">
<label>
        Paiement Par
       </label>
<select class="input" id="m_paiement">
<option value="Ria/WU">
         Ria / WU
        </option>
<option value="Virement">
         Virement (Bank)
        </option>
<option value="PayPal">
         PayPal
        </option>
<option selected="" value="Espece">
         Espèce
        </option>
<option value="Pas encore">
         Pas encore
        </option>
</select>
</div>
</div>
<div class="actions">
<button class="btn-outline" id="btnModalClose">
       Annuler
      </button>
<button class="btn-yellow" id="btnModalAdd">
       + Ajouter le client
      </button>
</div>
</div>
</div>
<!-- Edit Client Modal -->
<div aria-hidden="true" class="modal-backdrop" id="editClientModal">
<div class="modal">
<h3>
      Modifier client
     </h3>
<div class="row">
<div class="field">
<label>
        Nom
       </label>
<input class="input" id="e_name"/>
</div>
<div class="field">
<label>
        Username / Code
       </label>
<input class="input" id="e_username"/>
</div>
<div class="field">
<label>
        Adresse MAC
       </label>
<input class="input" id="e_mac"/>
</div>
<div class="field">
<label>
        Country
       </label>
<input class="input" id="e_country" placeholder="ex: Maroc"/>
</div>
<div class="field">
<label>
        Device/APP
       </label>
<select class="input" id="e_device">
<option value="Eagle 3.8">
         Eagle 3.8
        </option>
<option value="Eagle Pro (code)">
         Eagle Pro (code)
        </option>
<option value="Hot Player">
         Hot Player (LG/Samsung)
        </option>
<option value="Iptv Smarters">
         Iptv Smarters (LG/Samsung)
        </option>
<option value="IOS (iPhone)">
         IOS (iPhone)
        </option>
<option value="IOS (IPAD)">
         IOS (IPAD)
        </option>
<option value="STB (Receiver)">
         STB (Receiver)
        </option>
</select>
</div>
<div class="field">
<label>
        Date de début
       </label>
<input class="input" id="e_start" type="date"/>
</div>
<div class="field">
<label>
        Type d'abonnement
       </label>
<select class="input" id="e_type">
<option value="1y">
         1 an
        </option>
<option value="6m">
         6 mois
        </option>
<option value="3m">
         3 mois
        </option>
</select>
</div>
<div class="field">
<label>
        Prix de vente (DH)
       </label>
<input class="input" id="e_sale" min="0" step="1" type="number"/>
</div>
<div class="field">
<label>
        Paiement Par
       </label>
<select class="input" id="e_paiement">
<option value="Ria/WU">
         Ria / WU
        </option>
<option value="Virement">
         Virement (Bank)
        </option>
<option value="PayPal">
         PayPal
        </option>
<option value="Espece">
         Espèce
        </option>
<option value="Pas encore">
         Pas encore
        </option>
</select>
</div>
</div>
<div class="actions">
<button class="btn-outline" id="btnEditClose">
       Annuler
      </button>
<button class="btn-yellow" id="btnEditSave">
       Enregistrer
      </button>
</div>
</div>
</div>
<div class="hidden" id="clientForm">
<h2 style="margin-top:16px">
     Ajouter un client
    </h2>
<div class="row">
<div class="field">
<label>
       Nom
      </label>
<input class="input" id="name" placeholder="ex: Yassine"/>
</div>
<div class="field">
<label>
       Username / Code
      </label>
<input class="input" id="username" placeholder="ex: yassine_123"/>
</div>
<div class="field">
<label>
       Adresse MAC
      </label>
<input class="input" id="mac" placeholder="ex: AA:BB:CC:DD:EE:FF"/>
</div>
<div class="field">
<label>
       Date de début
      </label>
<input class="input" id="start" type="date"/>
</div>
<div class="field">
<label>
       Type d'abonnement
      </label>
<select id="type">
<option selected="" value="1y">
        1 an
       </option>
</select>
</div>
<div class="field">
<label>
       Prix de vente (DH)
      </label>
<input class="input" id="sale" min="0" placeholder="ex: 300" step="1" type="number"/>
</div>
</div>
</div>
<input id="device" type="hidden"/>
<input id="country" type="hidden"/>
<input id="paiement" type="hidden"/>
<section class="grid">
<div class="card full stats-card" style="grid-column:1 / -1">
<h3>
      Statistiques
     </h3>
<div class="stats-wrap">
<div class="stats">
<!-- removed the "Utilisateur" pill as requested -->
<div class="pill">
        Crédits Restants :
        <span class="ok" id="creditsLeft">
         —
        </span>
</div>
<div class="pill">
        Total à Payer :
        <strong class="ok" id="totalToPay">
         0 DH
        </strong>
</div>
<div class="pill">
        Total Mac à payer :
        <strong class="yellow mac-total" id="macsTotalPay">
         0 DH
        </strong>
</div>
<div class="pill">
        Gain Général :
        <strong class="ok" id="gainTotal">
         0 DH
        </strong>
</div>
<button class="pill-btn" id="btnMonthly" title="Voir historique mensuel">
        $ Gain Mensuel $
       </button>
</div>
</div>
</div>
<!-- Paramètres & Formulaire -->
<div class="card left hidden" id="settingsCard">
<h2>
      Paramètres
     </h2>
<div class="field">
<label>
       Crédits disponibles
      </label>
<input class="input" id="inputCredits" min="0" placeholder="ex: 500" step="1" type="number"/>
</div>
<div class="field">
<label>
       Coût par abonnement (crédits)
      </label>
<input class="input" id="inputCost" min="1" step="1" type="number" value="12"/>
</div>
<div class="field">
<label>
       Prix d'achat par code 1 an (DH)
      </label>
<input class="input" id="inputPrice" min="0" step="1" type="number" value="60"/>
</div>
<div class="field">
<label>
       Prix de vente par défaut (DH)
      </label>
<input class="input" id="inputSale" min="0" step="1" type="number" value="300"/>
</div>
<div class="hint">
      Les outils (export, import, réinitialisation) sont dans le menu
      <strong>
       Tools
      </strong>
      en haut.
     </div>
<button class="btn hidden" id="btnAdd">
      + Ajouter le client
     </button>
<div class="hint hidden" id="addMsg">
</div>
</div>
<!-- Liste des clients -->
<div class="card right">
<div>
<div class="clients-count">
       Nombre total de clients :
       <span class="count-green" id="countClients">
        0
       </span>
</div>
<h2>
       Liste des clients
      </h2>
<div class="search">
<input class="input" id="search" placeholder="Rechercher nom / username / code…"/>
<select id="filterPaid" onchange="render()" style="margin-left:8px;padding:6px 8px;border-radius:8px;
           border:1px solid rgba(255,255,255,.22);
           background:rgba(3,8,18,.65);color:var(--text);font-size:12px">
<option selected="" value="all">
         All
        </option>
<option value="paid">
         Payé
        </option>
<option value="unpaid">
         Non Payé
        </option>
</select>
<button class="btn-outline" id="btnClear">
        Effacer
       </button>
</div>
</div>
<div style="overflow:auto;max-height:62vh;border-radius:12px;border:1px solid rgba(255,255,255,.08);margin-top:8px">
<table>
<thead>
<tr>
<th>
          #
         </th>
<th>
          Nom
         </th>
<th>
          Username/Code
         </th>
<th>
          Device/APP
         </th>
<th>
          Début
         </th>
<th>
          Fin
         </th>
<th>
          Type
         </th>
<th>
          Paiement
          <br/>
</th>
<th>
          Paiement Par
         </th>
<th>
          MAC
         </th>
<th>
          Country
         </th>
<th>
          Vente (DH)
         </th>
<th>
          Profit (DH)
         </th>
<th>
          Actions
         </th>
</tr>
</thead>
<tbody id="tbody">
</tbody>
</table>
</div>
<div class="hint">
      Les données sont stockées localement dans ce navigateur
     </div>
</div>
</section>
</div>
<script>
   // ======= LocalStorage Keys (global) =======
    const LS_ACCOUNTS = 'iptv_accounts_v1'; // [{user, passHash, createdAt}]
    const LS_CURRENT  = 'iptv_current_user_v1';

    // ======= Per-user key helper =======
    const k = (base, user)=> `${base}__${user}`;

    // ======= Helpers =======
    const $ = (q)=> document.querySelector(q);
    const formatDate = (d)=> new Date(d).toLocaleDateString('fr-FR');
    const escapeHtml = (s)=> String(s||'').replace(/[&<>\"]/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[m]));
    const toHex = (buf)=> [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    async function sha256(str){ const enc = new TextEncoder().encode(str); const hash = await crypto.subtle.digest('SHA-256', enc); return toHex(hash); }

    // ======= App State =======
    const state = { user: null, clients: [], credits: 500, cost: 12, price: 60, saleDefault: 300, search: '' };

    function userKeys(){
      if(!state.user) return {};
      return {
        LS_CLIENTS: k('iptv_clients_v4', state.user),
        LS_CREDITS: k('iptv_credits_v4', state.user),
        LS_COST:    k('iptv_cost_v4', state.user),
        LS_PRICE:   k('iptv_price_v4', state.user),
        LS_SALE:    k('iptv_sale_default_v4', state.user),
      };
    }

    function loadUserData(){
      const keys = userKeys(); if(!keys.LS_CLIENTS) return;
      try{ state.clients = JSON.parse(localStorage.getItem(keys.LS_CLIENTS) || '[]'); }catch{ state.clients = [] }
      state.credits = parseInt(localStorage.getItem(keys.LS_CREDITS) || '500', 10);
      state.cost    = parseInt(localStorage.getItem(keys.LS_COST)    || '12', 10);
      state.price   = parseInt(localStorage.getItem(keys.LS_PRICE)   || '60', 10);
      state.saleDefault = parseInt(localStorage.getItem(keys.LS_SALE) || '300', 10);
      $('#inputCredits').value = state.credits;
      $('#inputCost').value = state.cost;
      $('#inputPrice').value = state.price;
      $('#inputSale').value = state.saleDefault;
      // set username in its new location
      const whoEl = $('#who');
      if(whoEl) whoEl.textContent = state.user;
  const clientEl = $('#currentClient'); if (clientEl) clientEl.textContent = state.user;
    }
    function saveUserData(){
      const keys = userKeys(); if(!keys.LS_CLIENTS) return;
      localStorage.setItem(keys.LS_CLIENTS, JSON.stringify(state.clients));
      localStorage.setItem(keys.LS_CREDITS, String(state.credits));
      localStorage.setItem(keys.LS_COST,    String(state.cost));
      localStorage.setItem(keys.LS_PRICE,   String(state.price));
      localStorage.setItem(keys.LS_SALE,    String(state.saleDefault));
    }

    function badgeClass(v){ if(v <= 0) return 'zero'; if(v <= state.cost * 2) return 'low'; return 'ok'; }

    
function totals(){
  // Clients
  let totalAchat = state.clients.reduce((s,c)=> s + (c.price ?? state.price), 0);
  let totalVente = state.clients.reduce((s,c)=> s + (c.sale  ?? state.saleDefault), 0);
  let totalProfit = totalVente - totalAchat;

  /*RES-TOTALS*/
  let resBuy = 0, resProfit = 0, resMonthly = 0;
  try{
    const list = JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]')||[];
    const now = new Date(); const m0 = now.getMonth(), y0 = now.getFullYear();
    for(const r of list){
      if(!r) continue;
      const buy  = parseInt(r.buy??0,10)||0;
      const sell = parseInt(r.sell??0,10)||0;
      let p = (r.profit!=null) ? parseInt(r.profit,10) : (sell - buy);
      if(isNaN(p)) p = (sell - buy);
      resBuy    += buy;
      resProfit += (p||0);
      const dstr = (r.date || r.createdAt || '').trim();
      if(dstr){
        let d = new Date(dstr);
        if(isNaN(d) && /\d{2}\/\d{2}\/\d{4}/.test(dstr)){
          const [dd,mm,yy] = dstr.split('/').map(x=>parseInt(x,10));
          d = new Date(yy, mm-1, dd);
        }
        if(d && !isNaN(d) && d.getMonth()===m0 && d.getFullYear()===y0){
          resMonthly += (p||0);
        }
      }
    }
  }catch(_){}

  totalAchat  += resBuy;     // -> Total à payer serveur
  totalProfit += resProfit;  // -> Gain total

  // === Include MAC entries (iptv_macs_v1) ===
  try{
    const macs = JSON.parse(localStorage.getItem('iptv_macs_v1')||'[]') || [];
    const n = new Date(); const m0=n.getMonth(), y0=n.getFullYear();
    var macMonthly = 0;
    for(const m of macs){
      const buy = parseInt(m.price||0,10)||0;
      const sell = parseInt(m.salePrice||0,10)||0;
      const p = (typeof m.profit==='number') ? parseInt(m.profit,10) : (sell - buy);
      /* do not add MAC buy to totalAchat (has its own pill) */
      totalProfit += (p||0);
      const dstr = (m.date||'').trim(); if(dstr){ const d=new Date(dstr); if(d && !isNaN(d) && d.getMonth()===m0 && d.getFullYear()===y0){ macMonthly += (p||0);} }
    }
  }catch(_){ }

  // Monthly (clients this month + reseller profits this month)
  const now = new Date();
  const month = now.getMonth();
  const year = now.getFullYear();
  const monthlyClients = state.clients
    .filter(c=> { const d=new Date(c.start); return d.getMonth()===month && d.getFullYear()===year; })
    .reduce((s,c)=> s + ((c.sale ?? state.saleDefault) - (c.price ?? state.price)), 0);
  const monthly = monthlyClients + resMonthly + (typeof macMonthly!=='undefined'?macMonthly:0);

  return { totalAchat, totalVente, totalProfit, monthly };
}


    function updateTotals(){
      const { totalAchat, totalProfit, monthly } = totals();
      const cls = badgeClass(state.credits);
      const leftEl = $('#creditsLeft'); leftEl.textContent = state.credits; leftEl.className = cls;
      $('#countClients').textContent = state.clients.length;
      const payEl = $('#totalToPay');  payEl.textContent  = `${totalAchat} DH`;  payEl.className  = cls;
      const gainEl = $('#gainTotal');  gainEl.textContent = `${totalProfit} DH`; gainEl.className = cls;
      const gainMonthly = $('#gainMonthly'); if(gainMonthly){ gainMonthly.textContent = `${monthly} DH`; gainMonthly.className = 'ok'; }
    }

    function render(){
      updateTotals();
      const q = state.search.toLowerCase().trim();
      const tbody = $('#tbody'); tbody.innerHTML = '';
      const rows = state.clients
        .map((c,i)=> ({...c, idx:i+1, achat:(c.price ?? state.price), vente:(c.sale ?? state.saleDefault)}))
        .filter(c => {
        const paidFilter = document.getElementById('filterPaid')?.value || 'all';
        const matchText = !q || [c.name, c.username, c.code].some(v => (v || '').toLowerCase().includes(q));
        const matchPaid = paidFilter === 'all' ||
          (paidFilter === 'paid' && c.paid === 'yes') ||
          (paidFilter === 'unpaid' && c.paid !== 'yes');
        return matchText && matchPaid;
      });

      const cntEl = document.getElementById('countClients'); if (cntEl) cntEl.textContent = rows.length;
      if(rows.length===0){
        const tr=document.createElement('tr');
        const td=document.createElement('td'); td.colSpan=14; td.textContent='Aucun client.'; td.style.color='#cbd5e1'; td.style.padding='16px';
        tr.appendChild(td); tbody.appendChild(tr);
      } else {
        for(const c of rows){
          const profit = (c.vente - c.achat);
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${c.idx}</td>
            <td><strong>${escapeHtml(c.name)}</strong></td>
            <td class="col-username"><span class="pill" style="padding:4px 8px">${escapeHtml(c.username||c.code||'—')}</span></td>
            <td><select class="device-select" data-id="${c.id}"><option value="Eagle 3.8" ${ c.device==="Eagle 3.8" ? "selected" : "" }>Eagle 3.8</option><option value="Eagle Pro (code)" ${ c.device==="Eagle Pro (code)" ? "selected" : "" }>Eagle Pro (code)</option><option value="Hot Player" ${ c.device==="Hot Player" ? "selected" : "" }>Hot Player (LG/Samsung)</option><option value="Iptv Smarters" ${ c.device==="Iptv Smarters" ? "selected" : "" }>Iptv Smarters (LG/Samsung)</option><option value="IOS (iPhone)" ${ c.device==="IOS (iPhone)" ? "selected" : "" }>IOS (iPhone)</option><option value="IOS (IPAD)" ${ c.device==="IOS (IPAD)" ? "selected" : "" }>IOS (IPAD)</option><option value="STB (Receiver)" ${ c.device==="STB (Receiver)" ? "selected" : "" }>STB (Receiver)</option></select></td>
            <td class="date-start">${formatDate(c.start)}</td>
            <td class="date-end ${new Date(c.end) < new Date() ? 'expired' : ''}">${formatDate(c.end)}</td>
            <td><select class="pay-select type-select" data-id="${c.id}"><option value="1y" ${ c.type==="1y" ? "selected" : "" }>1 an</option><option value="6m" ${ c.type==="6m" ? "selected" : "" }>6 months</option><option value="3m" ${ c.type==="3m" ? "selected" : "" }>3 months</option></select></td>
            <td class="${c.paid==='yes'?'paid':'unpaid'}">${c.paid==='yes'?'Payé':'Non Payé'}</td>
            <td><select class="pay-select" data-id="${c.id}"><option value="Ria/WU" ${ (c.paiement||"Espece")==="Ria/WU" ? "selected" : "" }>Ria / WU</option><option value="Virement" ${ (c.paiement||"Espece")==="Virement" ? "selected" : "" }>Virement (Bank)</option><option value="PayPal" ${ (c.paiement||"Espece")==="PayPal" ? "selected" : "" }>PayPal</option><option value="Espece" ${ (c.paiement||"Espece")==="Espece" ? "selected" : "" }>Espèce</option><option value="Pas encore" ${ (c.paiement||"Espece")==="Pas encore" ? "selected" : "" }>Pas encore</option></select></td>
            <td>${escapeHtml(c.mac || '—')}</td>
            <td><input class="input country-input" data-id="${c.id}" placeholder="ex: Maroc" value="${escapeHtml(c.country||'')}"></td>
            <td class="col-vente">${c.vente} DH</td>
            <td class="col-profit">${profit} DH</td>
            <td>
  <div class="actions-dropdown">
    <button class="btn-outline actions-btn" data-id="${c.id}">⚙️ Actions</button>
    <div class="actions-menu hidden" id="menu-${c.id}">
      <button class="menu-item" data-act="edit" data-id="${c.id}">Modifier</button>
<button class="menu-item" data-act="toggle" data-id="${c.id}">Marquer comme payé / non payé</button>
      
      <button class="menu-item" data-act="invoice" data-id="{{ID}}">🧾 Générer la facture</button>
      <!-- bouton ajouté -->
      <!-- keep following -->
      <button style="display:none" data-act="toggle_hidden" data-id="${c.id}">${c.paid==='yes'?'Marquer Non Payé':'Marquer Payé'}</button>
      <button class="menu-item danger" data-act="del" data-id="${c.id}">Supprimer</button>
    </div>
  </div>
</td>`;
          tbody.appendChild(tr);
        }
      }

      saveUserData();
    }

    function flash(msg, isErr=false){
      const el = $('#addMsg');
      el.textContent = msg;
      el.style.color = isErr ? 'var(--danger)' : 'var(--accent)';
      setTimeout(()=> el.textContent='', 3000);
    }

    // ======= Auth Logic =======
    function showAuth(){ $('#auth').classList.remove('hidden'); $('#app').classList.add('hidden'); }
    function showApp(){  $('#auth').classList.add('hidden');    $('#app').classList.remove('hidden'); }

    function getAccounts(){ try{ return JSON.parse(localStorage.getItem(LS_ACCOUNTS) || '[]'); }catch{ return [] } }
    function setAccounts(list){ localStorage.setItem(LS_ACCOUNTS, JSON.stringify(list)); }

    async function login(user, pass){
      const list = getAccounts();
      const u = list.find(a=> a.user===user);
      if(!u) throw new Error("Utilisateur introuvable");
      const ph = await sha256(pass);
      if(u.passHash !== ph) throw new Error("Mot de passe incorrect");
      localStorage.setItem(LS_CURRENT, user);
      state.user = user; loadUserData(); showApp(); render();
    }
    async function signup(user, pass, pass2){
      if(!user || user.length<3) throw new Error('Nom d\'utilisateur trop court');
      if(pass!==pass2) throw new Error('Les mots de passe ne correspondent pas');
      if(!pass || pass.length<6) throw new Error('Mot de passe trop court');
      const list = getAccounts();
      if(list.some(a=> a.user===user)) throw new Error('Utilisateur déjà existant');
      const ph = await sha256(pass);
      list.push({user, passHash: ph, createdAt: Date.now()});
      setAccounts(list);
      localStorage.setItem(LS_CURRENT, user);
      state.user = user; loadUserData(); showApp(); render();
    }
    function logout(){ localStorage.removeItem(LS_CURRENT); state.user=null; showAuth(); }

    // ======= UI Events =======
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.id==='btnAdd') return addClient();
      if(t.id==='btnReset'){
        if(confirm('Tout supprimer pour ce compte ?')){
          const keys = userKeys();
          localStorage.removeItem(keys.LS_CLIENTS);
          localStorage.removeItem(keys.LS_CREDITS);
          localStorage.removeItem(keys.LS_COST);
          localStorage.removeItem(keys.LS_PRICE);
          localStorage.removeItem(keys.LS_SALE);
          loadUserData(); render(); flash('Réinitialisé.');
        }
      }
      if(t.id==='btnExport'){
        const data = { user: state.user, clients: state.clients, credits: state.credits, cost: state.cost, price: state.price, saleDefault: state.saleDefault };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `iptv_${state.user}_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
      }
      if(t.id==='btnImport') $('#fileImport').click();
      if(t.dataset && t.dataset.act==='del'){
        const id = t.dataset.id;
        const i = state.clients.findIndex(c=> c.id===id);
        if(i>-1 && confirm('Supprimer ce client ?')){
          state.credits += state.cost; // rendre le crédit
          state.clients.splice(i,1);
          render();
        }
      }
      if(t.dataset && t.dataset.act==='toggle'){
        const id = t.dataset.id; const c = state.clients.find(x=> x.id===id);
        if(c){ c.paid = c.paid==='yes'?'no':'yes'; render(); }
      }
      if(t.id==='btnClear'){ $('#search').value=''; state.search=''; render(); }
      if(t.id==='btnLogout') logout();
      if(t.id==='tabLogin'){ $('#tabLogin').classList.add('active'); $('#tabSignup').classList.remove('active'); $('#loginForm').classList.remove('hidden'); $('#signupForm').classList.add('hidden'); }
      if(t.id==='tabSignup'){ $('#tabSignup').classList.add('active'); $('#tabLogin').classList.remove('active'); $('#signupForm').classList.remove('hidden'); $('#loginForm').classList.add('hidden'); }
      if(t.id==='btnLogin') (async()=>{ $('#authMsg').textContent=''; try{ await login($('#authUser').value.trim(), $('#authPass').value); }catch(err){ $('#authMsg').textContent = err.message; } 
    const btnAddClient = document.getElementById('btnAddClient');
    const clientForm = document.getElementById('clientForm');
    if(btnAddClient && clientForm){
      btnAddClient.addEventListener('click', ()=>{
        const visible = clientForm.style.display === 'block';
        clientForm.style.display = visible ? 'none' : 'block';
        if(!visible){
          clientForm.scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    }

})();
      if(t.id==='btnSignup') (async()=>{ $('#suMsg').textContent=''; try{ await signup($('#suUser').value.trim(), $('#suPass').value, $('#suPass2').value); }catch(err){ $('#suMsg').textContent = err.message; } })();
    });

    $('#fileImport').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(data.user && data.user!==state.user) return alert('Ce backup est pour un autre utilisateur.');
          if(Array.isArray(data.clients)) state.clients = data.clients; else throw new Error('format');
          if(typeof data.credits==='number') state.credits = data.credits;
          if(typeof data.cost==='number') state.cost = data.cost;
          if(typeof data.price==='number') state.price = data.price;
          if(typeof data.saleDefault==='number') state.saleDefault = data.saleDefault;
          $('#inputCredits').value = state.credits; $('#inputCost').value = state.cost; $('#inputPrice').value = state.price; $('#inputSale').value = state.saleDefault;
          render(); flash('Import réussi');
        }catch{ alert('Fichier invalide'); }
      };
      reader.readAsText(f);
    });

    // Inputs live (per-user)
    $('#inputCredits').addEventListener('input', (e)=>{ const v = parseInt(e.target.value||'0',10); state.credits = isNaN(v)?0:v; updateTotals(); saveUserData(); });
    $('#inputCost').addEventListener('input', (e)=>{ const v = parseInt(e.target.value||'12',10); state.cost = Math.max(1, isNaN(v)?12:v); updateTotals(); saveUserData(); });
    $('#inputPrice').addEventListener('input', (e)=>{ const v = parseInt(e.target.value||'60',10); state.price = Math.max(0, isNaN(v)?60:v); updateTotals(); saveUserData(); render(); });
    $('#inputSale').addEventListener('input', (e)=>{ const v = parseInt(e.target.value||'300',10); state.saleDefault = Math.max(0, isNaN(v)?300:v); updateTotals(); saveUserData(); render(); });
    $('#search').addEventListener('input', (e)=>{ state.search = e.target.value; render(); });

    function addClient(){
      const name = $('#name').value.trim();
      const username = $('#username').value.trim();
      const start = $('#start').value;
      const type = $('#type').value;
      const sale = parseInt($('#sale').value || state.saleDefault, 10);
      const mac = $('#mac').value.trim();
if(!name || !username || !start || !mac){ return flash('Remplissez tous les champs (y compris MAC)', true); }
      if(state.credits < state.cost){ return flash(`Crédits insuffisants. Restants: ${state.credits}, requis: ${state.cost}.`, true); }
      const client = { id: crypto.randomUUID(), name, username, code: username, start, end: computeEnd(start,type), type, paid:'no', price: state.price, sale: isNaN(sale)?state.saleDefault:sale , paiement: (document.getElementById('paiement')?.value || 'Espece'), device: ($('#device')?.value || 'Eagle Pro (code)'),
      mac,
      country: ($('#country')?.value || '')
    };
      state.clients.unshift(client);
      state.credits -= state.cost; // décrémenter les crédits
      // clear search so the newly added client is visible
      const qEl = document.getElementById('search'); if(qEl){ qEl.value=''; }
      state.search = '';
      $('#name').value=''; $('#username').value=''; $('#start').value=''; $('#type').value='1y'; $('#sale').value='';
      $('#mac').value='';
      render();
      flash('Client ajouté. Crédits & totaux mis à jour.');
    }

    function computeEnd(start, type){ const d = new Date(start); if(type==='1y') d.setFullYear(d.getFullYear()+1); else if(type==='6m') d.setMonth(d.getMonth()+6); else if(type==='3m') d.setMonth(d.getMonth()+3); return d.toISOString().slice(0,10);}

    // ======= Boot =======
    (function init(){
      const current = localStorage.getItem(LS_CURRENT);
      if(current){ state.user = current; loadUserData(); showApp(); }
      else { showAuth(); }
      const today = new Date().toISOString().slice(0,10); const start = document.getElementById('start'); if(start) start.value = today;
      if(state.user) render();
    })();
  
  // === Tools dropdown & Settings toggle ===
  (function(){
    const btnTools = document.getElementById('btnTools');
    const menu = document.getElementById('toolsMenu');
    const fileInput = document.getElementById('fileImport');
    const btnImport = document.getElementById('btnImport');
    const btnSettings = document.getElementById('btnSettings');
    const settingsCard = document.getElementById('settingsCard');

    if(btnTools && menu){
      btnTools.addEventListener('click', (e)=>{
        e.stopPropagation();
        const open = menu.style.display === 'block';
        menu.style.display = open ? 'none' : 'block';
        menu.setAttribute('aria-hidden', open ? 'true' : 'false');
      });
      // Close when clicking outside
      window.addEventListener('click', (e)=>{
        if(!menu) return;
        if(menu.style.display !== 'block') return;
        if(menu.contains(e.target) || e.target === btnTools) return;
        menu.style.display = 'none';
        menu.setAttribute('aria-hidden', 'true');
      });
    }

    if(btnImport && fileInput){
      btnImport.addEventListener('click', ()=> fileInput.click());
    }

    if(btnSettings && settingsCard){
      btnSettings.addEventListener('click', ()=>{
        const hidden = settingsCard.classList.contains('hidden');
        if(hidden){
          settingsCard.classList.remove('hidden');
          settingsCard.scrollIntoView({behavior:'smooth', block:'start'});
        } else {
          settingsCard.classList.add('hidden');
          // Optionally scroll back to top
          window.scrollTo({top:0, behavior:'smooth'});
        }
      });
    }
  })();


// === Add Client Modal Logic ===
(function(){
  const openBtn = document.getElementById('btnAddClientOpen');
  const modal = document.getElementById('addClientModal');
  const closeBtn = document.getElementById('btnModalClose');
  const addBtn = document.getElementById('btnModalAdd');

  // modal fields
  const m_name = document.getElementById('m_name');
  const m_username = document.getElementById('m_username');
  const m_mac = document.getElementById('m_mac');
  const m_country = document.getElementById('m_country');
  const m_start = document.getElementById('m_start');
  const m_type = document.getElementById('m_type');
  const m_sale = document.getElementById('m_sale');

  // original hidden form fields
  const f_name = document.getElementById('name');
  const f_username = document.getElementById('username');
  const f_mac = document.getElementById('mac');
  const f_country = document.getElementById('country');
  const f_start = document.getElementById('start');
  const f_type = document.getElementById('type');
  const f_sale = document.getElementById('sale');
  const f_add = document.getElementById('btnAdd');

  function openModal(){
    // prefill start date to today (YYYY-MM-DD)
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    m_start.value = `${yyyy}-${mm}-${dd}`;
    if(document.getElementById('m_sale')){ document.getElementById('m_sale').value = (window.state?.saleDefault ?? 300); }
modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    m_name.focus();
  }
  function closeModal(){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  if(openBtn && modal){
    openBtn.addEventListener('click', openModal);
  }
  if(closeBtn){
    closeBtn.addEventListener('click', closeModal);
  }
  // close on backdrop click
  modal?.addEventListener('click', (e)=>{
    if(e.target === modal) closeModal();
  });
  // Esc key
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modal?.style.display === 'flex') closeModal();
  });

  if(addBtn && f_add){
    addBtn.addEventListener('click', ()=>{
      // copy values to original form
      if(f_name) f_name.value = m_name.value.trim();
      if(f_username) f_username.value = m_username.value.trim();
      if(f_start) f_start.value = m_start.value;
      if(f_type) f_type.value = m_type.value;
      if(f_sale) f_sale.value = m_sale.value;
      if(f_mac) f_mac.value = (m_mac ? m_mac.value.trim() : '');
      if(f_country) f_country.value = (m_country ? m_country.value.trim() : '');
      // trigger original add logic
      closeModal();
    });
  }
})();


    // Function to perform full backup
    function handleFullBackup() {
      
      const data = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        data[key] = value;
      }

      const backup = {
        meta: {
          exportedAt: new Date().toISOString(),
          user: localStorage.getItem('iptv_current_user_v1') || 'unknown'
        },
        data
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup_iptv_${backup.meta.user}_${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Function to restore full backup
    function handleFullRestore(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const backup = JSON.parse(e.target.result);
          const entries = backup.data || {};
          for (const key in entries) {
            localStorage.setItem(key, entries[key]);
          }
          alert("✅ Restore complete. Please refresh the page.");
        } catch (err) {
          alert("❌ Error during restore: " + err.message);
        }
      };
      reader.readAsText(file);
    }

    document.getElementById('btnFullBackup').addEventListener('click', handleFullBackup);
    document.getElementById('btnFullRestore').addEventListener('click', () => {
      document.getElementById('restoreInput').click();
    });
    document.getElementById('restoreInput').addEventListener('change', handleFullRestore);
    
// === MOBILE FULL TOOLS BUTTONS ===
document.getElementById('mobileFullRestore')?.addEventListener('click', () => {
  document.getElementById('btnFullRestore')?.click();
});
document.getElementById('mobileFullBackup')?.addEventListener('click', () => {
  document.getElementById('btnFullBackup')?.click();
});
document.getElementById('mobileResetData')?.addEventListener('click', () => {
  document.getElementById('btnResetData')?.click();
});

// === SYNC CURRENT USER TO MOBILE MENU ===
const currentClientEl = document.getElementById('currentClient');
const currentClientMobileEl = document.getElementById('currentClientMobile');
if (currentClientEl && currentClientMobileEl) {
  currentClientMobileEl.textContent = currentClientEl.textContent || '—';
}
  </script>
<!-- Monthly earnings flyout -->
<div aria-hidden="true" id="monthlyPanel">
<div class="panel-content">
<h3>
     Historique — Monthly Earning
     <button aria-label="Fermer" class="monthly-close" id="closeMonthly">
      ×
     </button>
</h3>
<div class="monthly-summary" id="monthlySummary">
</div>
<ul class="month-list" id="monthlyList">
</ul>
<div class="hint">
     Montants affichés = somme des profits (vente − achat) par mois.
    </div>
</div>
</div>
<script>
   (function(){
  // Fallback query helper if needed
  if(typeof window.$ !== 'function'){
    window.$ = (sel, root=document) => root.querySelector(sel);
  }

  const MONTHS_FR = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];

  
  function monthlyEarnings(){
    try{
      let rowsData = [];
      // Primary: from state.clients
      const clients = (window.state && Array.isArray(window.state.clients)) ? window.state.clients : [];
      if(clients.length > 0){
        const priceDefault = (typeof window.state.price==='number') ? window.state.price : 0;
        const saleDefault  = (typeof window.state.saleDefault==='number') ? window.state.saleDefault : 0;
        for(const c of clients){
          if(!c || !c.start) continue;
          let d = new Date(c.start);
          // If start appears as DD/MM/YYYY, normalize
          if(isNaN(d) && /\d{2}\/\d{2}\/\d{4}/.test(c.start)){
            const [dd,mm,yy] = c.start.split('/').map(x=>parseInt(x,10));
            d = new Date(yy, mm-1, dd);
          }
          if(isNaN(d)) continue;
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          const sale  = (typeof c.sale  === 'number') ? c.sale  : saleDefault;
          const price = (typeof c.price === 'number') ? c.price : priceDefault;
          const profit = (sale - price);
          rowsData.push({key, y:d.getFullYear(), m:d.getMonth()+1, amount: profit});
        }
      } else {
        // Fallback: scrape rendered table (#tbody)
        const tbody = document.getElementById('tbody');
        if(tbody){
          const trs = Array.from(tbody.querySelectorAll('tr'));
          for(const tr of trs){
            const debutEl = tr.querySelector('.date-start');
            const profitEl = tr.querySelector('.col-profit');
            if(!debutEl || !profitEl) continue;
            const debutText = debutEl.textContent.trim();
            const profitText = profitEl.textContent.replace(/[^0-9-]/g,'').trim();
            const amt = parseInt(profitText||'0',10) || 0;
            // debutText could be DD/MM/YYYY
            let d;
            if(/\d{2}\/\d{2}\/\d{4}/.test(debutText)){
              const [dd,mm,yy] = debutText.split('/').map(x=>parseInt(x,10));
              d = new Date(yy, mm-1, dd);
            } else {
              d = new Date(debutText);
            }
            if(isNaN(d)) continue;
            const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            rowsData.push({key, y:d.getFullYear(), m:d.getMonth()+1, amount: amt});
          }
        }
      }
      
      /* RES-MONTHLY-RES: include reseller profits */
      try{
        const resellers = JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]')||[];
        for(const r of resellers){
          if(!r) continue;
          const buy = parseInt(r.buy??0,10)||0;
          const sell= parseInt(r.sell??0,10)||0;
          let p = (r.profit!=null) ? parseInt(r.profit,10) : (sell - buy);
          if(isNaN(p)) p = (sell - buy);
          if(!p) continue;
          const dstr = (r.date || r.createdAt || '').trim();
          if(!dstr) continue;
          let d = new Date(dstr);
          if(isNaN(d) && /\d{2}\/\d{2}\/\d{4}/.test(dstr)){
            const [dd,mm,yy] = dstr.split('/').map(x=>parseInt(x,10));
            d = new Date(yy, mm-1, dd);
          }
          if(isNaN(d)) continue;
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          rowsData.push({key, y:d.getFullYear(), m:d.getMonth()+1, amount: p});
        }
      }catch(_){}
    
      
      // Also include MAC entries (iptv_macs_v1): profit = salePrice - price
      try{
        const macs = JSON.parse(localStorage.getItem('iptv_macs_v1')||'[]') || [];
        for(const m of macs){
          const buy = parseInt(m.price||0,10)||0;
          const sell = parseInt(m.salePrice||0,10)||0;
          const p = sell - buy;
          const dstr = (m.date||'').trim();
          if(!dstr) continue;
          const d = new Date(dstr);
          if(!d || isNaN(d)) continue;
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          rowsData.push({key, y:d.getFullYear(), m:d.getMonth()+1, amount:p});
        }
      }catch(_){}
// Aggregate by month
      const map = new Map();
      for(const r of rowsData){
        map.set(r.key, (map.get(r.key)||0) + r.amount);
      }
      const rows = [...map.entries()].map(([key, amt])=>{
        const [y,m] = key.split('-').map(n=>parseInt(n,10));
        const name = `${MONTHS_FR[m-1]} ${y}`;
        return {key, y, m, name, amount: amt};
      }).sort((a,b)=> (b.y - a.y) || (b.m - a.m));
      return rows;
    }catch(err){
      console.error('monthlyEarnings error', err);
      return [];
    }
  }
function renderMonthlyPanel(){
    const list = $('#monthlyList'); if(!list) return;
    const rows = monthlyEarnings();
    list.innerHTML = '';
    if(rows.length === 0){
      const li = document.createElement('li');
      li.className = 'month-item';
      li.innerHTML = `<span class="m-name">—</span><span class="m-amt">0 DH</span>`;
      list.appendChild(li);
      return;
    }
    // Summary (total of all months)
    let total = 0;
    for(const r of rows){ total += (r.amount||0); }

    let summary = document.getElementById('monthlySummary');
    if(!summary){
      summary = document.createElement('div');
      summary.id = 'monthlySummary';
      summary.className = 'monthly-summary';
      const panel = document.getElementById('monthlyPanel');
      panel?.insertBefore(summary, list);
    }
    summary.innerHTML = `<span class="title">Total des profits</span><span class="value">${total} DH</span>`;

    for(const r of rows){
      const li = document.createElement('li');
      li.className = 'month-item';
      const cls = (r.amount >= 0) ? 'pos' : 'neg';
      li.innerHTML = `<span class="m-name">${r.name}</span><span class="m-amt ${cls}">${r.amount} DH</span>`;
      list.appendChild(li);
    }
  }

  function toggleMonthly(open){
    const panel = $('#monthlyPanel'); if(!panel) return;
    if(open){
      renderMonthlyPanel();
      panel.style.display = 'flex';
      panel.setAttribute('aria-hidden','false');
    } else {
      panel.style.display = 'none';
      panel.setAttribute('aria-hidden','true');
    }
  }

  // Hook up events once DOM is ready
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnMonthly');
    const closeBtn = document.getElementById('closeMonthly');
    if(btn){
  btn.addEventListener('click', ()=>{
    const panel = document.getElementById('monthlyPanel');
    const isOpen = panel && panel.getAttribute('aria-hidden') === 'false';
    toggleMonthly(!isOpen);
  });
}
    if(closeBtn){ closeBtn.addEventListener('click', ()=> toggleMonthly(false)); }

    // Close when clicking outside
    window.addEventListener('click', (e)=>{
      const p = document.getElementById('monthlyPanel');
      if(!p || p.getAttribute('aria-hidden')==='true') return;
      if(p.contains(e.target) || e.target===btn) return;
      toggleMonthly(false);
    });
  });
})();
  </script>
<script>
   (function(){
  const userInput = document.getElementById('authUser');
  const passInput = document.getElementById('authPass');
  const loginBtn  = document.getElementById('btnLogin');
  function hookEnter(el){
    if(!el) return;
    el.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        if(loginBtn) loginBtn.click();
      }
    });
  }
  hookEnter(userInput);
  hookEnter(passInput);
})();
  </script>
<script>
   (function(){
  const settingsOverlay = document.getElementById('settingsOverlay');
  const toolsOverlay = document.getElementById('toolsOverlay');
  const settingsCard = document.getElementById('settingsCard');
  const settingsMount = document.getElementById('settingsMount');
  const closeSettings = document.getElementById('closeSettings');
  const closeTools = document.getElementById('closeTools');
  const btnSettings = document.getElementById('btnSettings');
  const btnTools = document.getElementById('btnTools');
  const toolsMenu = document.getElementById('toolsMenu');

  const placeholder = document.createElement('div');
  placeholder.id = 'settingsPlaceholder';
  settingsCard?.parentNode?.insertBefore(placeholder, settingsCard.nextSibling);

  function openSettings(){
    if(!settingsOverlay || !settingsCard || !settingsMount) return;
    settingsMount.appendChild(settingsCard);
    settingsCard.classList.remove('hidden');
    settingsOverlay.style.display = 'flex';
    settingsOverlay.setAttribute('aria-hidden','false');
  }
  function closeSettingsPopup(){
    if(!settingsOverlay || !settingsCard || !placeholder) return;
    settingsOverlay.style.display = 'none';
    settingsOverlay.setAttribute('aria-hidden','true');
    placeholder.parentNode?.insertBefore(settingsCard, placeholder);
    settingsCard.classList.add('hidden');
  }
  function openTools(){
    if(toolsMenu){ toolsMenu.style.display = 'none'; toolsMenu.setAttribute('aria-hidden','true'); }
    toolsOverlay.style.display = 'flex';
    toolsOverlay.setAttribute('aria-hidden','false');
  }
  function closeToolsPopup(){
    toolsOverlay.style.display = 'none';
    toolsOverlay.setAttribute('aria-hidden','true');
  }
  btnSettings?.addEventListener('click', (e)=>{ e.preventDefault(); openSettings(); });
  btnTools?.addEventListener('click', (e)=>{ e.preventDefault(); openTools(); });
  closeSettings?.addEventListener('click', closeSettingsPopup);
  closeTools?.addEventListener('click', closeToolsPopup);
  settingsOverlay?.addEventListener('click', (e)=>{ if(e.target === settingsOverlay) closeSettingsPopup(); });
  toolsOverlay?.addEventListener('click', (e)=>{ if(e.target === toolsOverlay) closeToolsPopup(); });
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      if(settingsOverlay?.style.display === 'flex') closeSettingsPopup();
      if(toolsOverlay?.style.display === 'flex') closeToolsPopup();
    }
  });

  // Save button with toast
  const btnSaveSettings = document.getElementById('btnSaveSettings');
  const toast = document.getElementById('settingsToast');
  btnSaveSettings?.addEventListener('click', ()=>{
    try{
      if(typeof saveUserData === 'function'){ saveUserData(); }
      const old = btnSaveSettings.textContent;
      btnSaveSettings.textContent = 'Saved ✓';
      setTimeout(()=> btnSaveSettings.textContent = old, 1200);
      if (toast){
        toast.style.display = 'inline-block';
        setTimeout(()=>{ toast.style.display = 'none'; }, 1400);
      }
    }catch(err){
      alert('Erreur lors de l\'enregistrement');
    }
  });

  // Persist 'Paiement Par' select
  // live update for country input
  document.addEventListener('input', (e)=>{
    const t = e.target;
    if(t && t.classList && t.classList.contains('country-input')){
      const id = t.dataset.id;
      const c = state.clients.find(x=> x.id === id);
      if(c){ c.country = t.value.trim(); saveUserData(); }
    }
  });
  document.addEventListener('change', (e)=>{
  const t = e.target;
  // inline country editor (on change)
  if(t && t.classList && t.classList.contains('country-input')){
    const id = t.dataset.id;
    const c = state.clients.find(x=> x.id === id);
    if(c){ c.country = t.value.trim(); saveUserData(); }
  }
  // Paiement Par select
  if(t && t.classList && t.classList.contains('pay-select')){
    const id = t.dataset.id;
    const c = state.clients.find(x=> x.id === id);
    if(c){ c.paiement = t.value; saveUserData(); }
  }
  // Type select -> recompute end date
  if(t && t.classList && t.classList.contains('type-select')){
    const id = t.dataset.id;
    const c = state.clients.find(x=> x.id === id);
    if(c){
      c.type = t.value;
      c.end = computeEnd(c.start, c.type);
      saveUserData();
      render();
    }
  }
  // Device select
  if(t && t.classList && t.classList.contains('device-select')){
    const id = t.dataset.id;
    const c = state.clients.find(x=> x.id === id);
    if(c){ c.device = t.value; saveUserData(); }
  }
});
document.getElementById('toolsExport')?.addEventListener('click', ()=>{
  const data = { 
    user: state.user, 
    clients: state.clients, 
    credits: state.credits, 
    cost: state.cost, 
    price: state.price, 
    saleDefault: state.saleDefault 
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(blob); 
  a.download = `iptv_${state.user}_backup_${new Date().toISOString().slice(0,10)}.json`; 
  a.click();
});

document.getElementById('toolsImport')?.addEventListener('click', ()=>{
  document.getElementById('fileImport')?.click();
});

document.getElementById('toolsReset')?.addEventListener('click', ()=>{
  if(confirm('Tout supprimer pour ce compte ?')){
    const keys = userKeys();
    localStorage.removeItem(keys.LS_CLIENTS);
    localStorage.removeItem(keys.LS_CREDITS);
    localStorage.removeItem(keys.LS_COST);
    localStorage.removeItem(keys.LS_PRICE);
    localStorage.removeItem(keys.LS_SALE);
    loadUserData(); render(); alert('Réinitialisé ✓');
  }
});
  </script>
<script>
   // === Rewired Add Client Modal Logic (robust) ===
(function(){
  const openBtn = document.getElementById('btnAddClientOpen');
  const modal = document.getElementById('addClientModal');
  const closeBtn = document.getElementById('btnModalClose');
  const addBtn = document.getElementById('btnModalAdd');

  // modal fields
  const m_name = document.getElementById('m_name');
  const m_username = document.getElementById('m_username');
  const m_mac = document.getElementById('m_mac');
  const m_start = document.getElementById('m_start');
  const m_type = document.getElementById('m_type');
  const m_sale = document.getElementById('m_sale');

  // hidden/original form fields used by addClient()
  const f_name = document.getElementById('name');
  const f_username = document.getElementById('username');
  const f_mac = document.getElementById('mac');
  const f_start = document.getElementById('start');
  const f_type = document.getElementById('type');
  const f_sale = document.getElementById('sale');

  function openModal(){
    if(!modal) return;
    // prefill start with today
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    if(m_start) m_start.value = `${yyyy}-${mm}-${dd}`;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    m_name && m_name.focus();
  }
  function closeModal(){
    if(!modal) return;
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  openBtn && openBtn.addEventListener('click', openModal);
  closeBtn && closeBtn.addEventListener('click', closeModal);
  modal && modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal?.style.display === 'flex') closeModal(); });

  addBtn && addBtn.addEventListener('click', ()=>{
    // Copy values
    if(f_name) f_name.value = (m_name?.value || '').trim();
    if(f_username) f_username.value = (m_username?.value || '').trim();
    if(f_mac) f_mac.value = (m_mac?.value || '').trim();
    if(f_start) f_start.value = (m_start?.value || '');
    if(f_type) f_type.value = (m_type?.value || '1y');
    if(f_sale) f_sale.value = (m_sale?.value || '');

    const f_device = document.getElementById('device');
const m_device = document.getElementById('m_device');
if (f_device) f_device.value = (m_device?.value || 'Eagle Pro (code)');
const f_country = document.getElementById('country');
const m_country = document.getElementById('m_country');
if (f_country) f_country.value = (m_country?.value || '');
const f_paiement = document.getElementById('paiement');
const m_paiement = document.getElementById('m_paiement');
if (f_paiement) f_paiement.value = (m_paiement?.value || 'Espece');
// Call addClient() directly
    try{
      if(typeof addClient === 'function'){ addClient(); }
      closeModal();
    }catch(err){
      console.error('addClient error', err);
    }
  });
})();
  </script>
<script>
   // === Edit Client Modal Logic ===
(function(){
  const modal = document.getElementById('editClientModal');
  const closeBtn = document.getElementById('btnEditClose');
  const saveBtn = document.getElementById('btnEditSave');

  function openEdit(c){
    if(!modal) return;
    const e_name = document.getElementById('e_name');
    const e_username = document.getElementById('e_username');
    const e_mac = document.getElementById('e_mac');
    const e_country = document.getElementById('e_country');
    const e_device = document.getElementById('e_device');
    const e_paiement = document.getElementById('e_paiement');
    const e_start = document.getElementById('e_start');
    const e_type = document.getElementById('e_type');
    const e_sale = document.getElementById('e_sale');

    if(e_name) e_name.value = c.name || '';
    if(e_username) e_username.value = c.username || c.code || '';
    if(e_mac) e_mac.value = c.mac || '';
    if(e_country) e_country.value = c.country || '';
    if(e_device) e_device.value = c.device || 'Eagle Pro (code)';
    if(e_paiement) e_paiement.value = c.paiement || 'Espece';
    if(e_start) e_start.value = c.start || '';
    if(e_type) e_type.value = c.type || '1y';
    if(e_sale) e_sale.value = (typeof c.sale==='number' ? c.sale : (window.state?.saleDefault ?? 300));

    modal.dataset.id = c.id;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    e_name && e_name.focus();
  }
  function closeEdit(){
    if(!modal) return;
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
    modal.removeAttribute('data-id');
  }

  // open from table action
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.dataset && t.dataset.act === 'edit'){
      const id = t.dataset.id;
      const c = state.clients.find(x=> x.id === id);
      if(c){ openEdit(c); }
    }
  });

  saveBtn && saveBtn.addEventListener('click', ()=>{
    const id = modal?.dataset?.id;
    if(!id) return closeEdit();
    const c = state.clients.find(x=> x.id === id);
    if(!c) return closeEdit();

    const e_name = document.getElementById('e_name');
    const e_username = document.getElementById('e_username');
    const e_mac = document.getElementById('e_mac');
    const e_country = document.getElementById('e_country');
    const e_device = document.getElementById('e_device');
    const e_paiement = document.getElementById('e_paiement');
    const e_start = document.getElementById('e_start');
    const e_type = document.getElementById('e_type');
    const e_sale = document.getElementById('e_sale');

    c.name = (e_name?.value || '').trim();
    c.username = (e_username?.value || '').trim();
    c.code = c.username; // keep code == username convention
    c.mac = (e_mac?.value || '').trim();
    c.country = (e_country?.value || '').trim();
    c.device = (e_device?.value || c.device || 'Eagle Pro (code)');
    c.paiement = (e_paiement?.value || c.paiement || 'Espece');
    c.start = (e_start?.value || c.start);
    c.type  = (e_type?.value || c.type || '1y');
    c.sale  = parseInt(e_sale?.value || c.sale || (window.state?.saleDefault ?? 300), 10);
    c.end   = (typeof computeEnd==='function') ? computeEnd(c.start, c.type) : c.end;

    saveUserData();
    render();
    closeEdit();
  });

  closeBtn && closeBtn.addEventListener('click', closeEdit);
  modal && modal.addEventListener('click', (e)=>{ if(e.target === modal) closeEdit(); });
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal?.style.display === 'flex') closeEdit(); });
})();
  </script>
<script>
   (function(){
  function openSettingsPopup(){
    try{
      var settingsOverlay = document.getElementById('settingsOverlay');
      var settingsCard = document.getElementById('settingsCard');
      var settingsMount = document.getElementById('settingsMount');
      if(settingsMount && settingsCard && settingsCard.parentNode !== settingsMount){
        settingsMount.appendChild(settingsCard);
      }
      if(settingsCard){ settingsCard.classList.remove('hidden'); }
      if(settingsOverlay){
        settingsOverlay.style.display = 'flex';
        settingsOverlay.setAttribute('aria-hidden','false');
      }
    }catch(e){ console.warn('settings popup error', e); }
  }
  function openToolsOverlay(){
    var overlay = document.getElementById('toolsOverlay');
    if(overlay){
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden','false');
    } else {
      var btnTools = document.getElementById('btnTools');
      if(btnTools) btnTools.click();
    }
  }
  function closeMobileMenu(){
    var mm = document.getElementById('mobileMenu');
    if(mm){ mm.classList.remove('show'); mm.setAttribute('aria-hidden','true'); }
    var mt = document.getElementById('menuToggle');
    if(mt){ mt.setAttribute('aria-expanded','false'); }
  }

  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('menuToggle');
    var menu = document.getElementById('mobileMenu');
    var mobileAdd = document.getElementById('mobileAddClient');
    var mobileTools = document.getElementById('mobileTools');
    var mobileSettings = document.getElementById('mobileSettings');
    var mobileLogout = document.getElementById('mobileLogout');

    btn && btn.addEventListener('click', function(e){
      e.stopPropagation();
      var open = menu && menu.classList.contains('show');
      if(menu){
        if(open){ menu.classList.remove('show'); menu.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false'); }
        else { menu.classList.add('show'); menu.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true'); }
      }
    });

    mobileAdd && mobileAdd.addEventListener('click', function(){
      var a = document.getElementById('btnAddClientOpen');
      if(a) a.click();
      closeMobileMenu();
    });
    mobileTools && mobileTools.addEventListener('click', function(){
      openToolsOverlay();
      closeMobileMenu();
    });
    mobileSettings && mobileSettings.addEventListener('click', function(){
      openSettingsPopup();
      closeMobileMenu();
    });
    mobileLogout && mobileLogout.addEventListener('click', function(e){
      e.preventDefault();
      var ok = confirm('Voulez-vous vraiment vous déconnecter ?');
      if(ok){
        if(typeof logout === 'function'){ try{ logout(); return; }catch(_){} }
        var auth = document.getElementById('auth');
        var app  = document.getElementById('app');
        if(auth && app){
          auth.classList.remove('hidden');
          app.classList.add('hidden');
          try{ localStorage.removeItem('iptv_current_user_v1'); }catch(_){}
          return;
        }
        window.location.reload();
      }
    });

    // Close on outside click
    window.addEventListener('click', function(e){
      if(!menu) return;
      if(menu.classList.contains('show') && !menu.contains(e.target) && e.target !== btn){
        closeMobileMenu();
      }
    });
    // Esc to close
    
  // Save gains from the modal inputs
  document.addEventListener('click', function(e){
    if(!e.target || e.target.id !== 'btnSaveGains') return;
    var tbody = document.getElementById('resellerGainTbody'); if(!tbody) return;
    var rows = Array.from(tbody.querySelectorAll('tr'));
    var list = loadRes();
    var pm = (window.__priceMapLoad && __priceMapLoad()) || {};
    rows.forEach(function(tr){
      var name = (tr.querySelector('.rg-name')?.value||'').trim();
      var buy = parseInt(tr.querySelector('.rg-buy')?.value||'0',10)||0;
      var sell = parseInt(tr.querySelector('.rg-sell')?.value||'0',10)||0;
      var profit = sell - buy;
      if(!name) return;
      // Update list by name
      var idx = list.findIndex(function(x){ return (x.name||'').trim()===name; });
      if(idx>=0){ list[idx].buy = buy; list[idx].sell = sell; list[idx].profit = profit; }
      // Update price map
      pm[name] = {buy:buy, sell:sell, profit:profit};
    });
    try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
    if(window.__priceMapSave) __priceMapSave(pm);
    // Re-render the modal
    renderList();
  });

  // (désactivé) Live compute pour rg-buy/rg-sell — supprimé
// Save gains from the modal inputs (ensure handler)
  document.addEventListener('click', function(e){
    if(!e.target || e.target.id !== 'btnSaveGains') return;
    var tbody = document.getElementById('resellerGainTbody'); if(!tbody) return;
    var rows = Array.from(tbody.querySelectorAll('tr'));
    var list = (window.loadRes ? loadRes() : []);
    var pm = (window.__priceMapLoad && __priceMapLoad()) || {};
    rows.forEach(function(tr){
      var name = (tr.querySelector('.rg-name')?.value||'').trim();
      var buy = parseInt(tr.querySelector('.rg-buy')?.value||'0',10)||0;
      var sell = parseInt(tr.querySelector('.rg-sell')?.value||'0',10)||0;
      var profit = sell - buy;
      if(!name) return;
      // Update by name in the main list
      var idx = list.findIndex(function(x){ return (x.name||'').trim()===name; });
      if(idx>=0){ list[idx].buy = buy; list[idx].sell = sell; list[idx].profit = profit; }
      // Update price map
      pm[name] = {buy:buy, sell:sell, profit:profit};
    });
    if(window.save) try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
    if(window.__priceMapSave) __priceMapSave(pm);
    // Refresh view
    renderList();
  });
window.addEventListener('keydown', function(e){
      if(e.key === 'Escape') closeMobileMenu();
    });
  });
})();
  </script>
<script>
   // === Settings popup actions: close + save ===
document.addEventListener('DOMContentLoaded', function(){
  const closeBtn = document.getElementById('closeSettings');
  const saveBtn = document.getElementById('btnSaveSettings');
  const settingsOverlay = document.getElementById('settingsOverlay');

  function closeSettings(){
    if (settingsOverlay){
      settingsOverlay.style.display = 'none';
      settingsOverlay.setAttribute('aria-hidden','true');
    }
  }

  if (closeBtn && !closeBtn.__bound){
    closeBtn.addEventListener('click', function(e){
      e.preventDefault();
      closeSettings();
    });
    closeBtn.__bound = true;
  }

  if (saveBtn && !saveBtn.__bound){
    saveBtn.addEventListener('click', function(e){
      e.preventDefault();
      try {
        const credits = document.getElementById('inputCredits')?.value || 0;
        const cost    = document.getElementById('inputCost')?.value || 0;
        const price   = document.getElementById('inputPrice')?.value || 0;
        const sale    = document.getElementById('inputSale')?.value || 0;

        const settings = { 
          credits: Number(credits), 
          cost: Number(cost), 
          price: Number(price), 
          sale: Number(sale) 
        };
        localStorage.setItem("iptv_settings", JSON.stringify(settings));

        alert("Paramètres enregistrés ✅");
        closeSettings();
        // Optionally, update UI/state if app provides functions
        if (typeof loadUserData === 'function') { try { loadUserData(); } catch(_){} }
        if (typeof render === 'function') { try { render(); } catch(_){} }
      } catch(err){
        console.error(err);
        alert("Erreur lors de l'enregistrement !");
      }
    });
    saveBtn.__bound = true;
  }
});
  </script>
<script>
   // === Robust Tools Actions (Export / Import / Reset) ===
document.addEventListener('DOMContentLoaded', function(){
  const btnExport = document.getElementById('toolsExport');
  const btnImport = document.getElementById('toolsImport');
  const btnReset  = document.getElementById('toolsReset');
  const fileInput = document.getElementById('fileImport');

  function getKeys(){
    try{
      if (typeof userKeys === 'function') return userKeys();
    }catch(_){}
    // Fallback keys
    return {
      LS_CLIENTS: 'iptv_clients',
      LS_CREDITS: 'iptv_credits',
      LS_COST: 'iptv_cost',
      LS_PRICE: 'iptv_price',
      LS_SALE: 'iptv_saleDefault',
      LS_USER: 'iptv_current_user_v1'
    };
  }

  function exportData(){
    const keys = getKeys();
    let data = {};
    try{
      // Prefer in-memory state if present
      if (window.state){
        data = {
          user:  state.user ?? null,
          clients: state.clients ?? [],
          credits: state.credits ?? 0,
          cost: state.cost ?? 0,
          price: state.price ?? 0,
          saleDefault: state.saleDefault ?? 0
        };
      } else {
        // Fallback to localStorage
        data = {
          user:  localStorage.getItem(keys.LS_USER),
          clients: JSON.parse(localStorage.getItem(keys.LS_CLIENTS) || '[]'),
          credits: Number(localStorage.getItem(keys.LS_CREDITS) || 0),
          cost: Number(localStorage.getItem(keys.LS_COST) || 0),
          price: Number(localStorage.getItem(keys.LS_PRICE) || 0),
          saleDefault: Number(localStorage.getItem(keys.LS_SALE) || 0),
        };
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const uname = (data && (data.user || 'user')) || 'user';
      a.download = `iptv_${uname}_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    }catch(err){
      console.error(err);
      alert('Export a échoué.');
    }
  }

  function importData(file){
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const obj = JSON.parse(e.target.result);
        const keys = getKeys();
        // Save to localStorage
        if (obj.clients) localStorage.setItem(keys.LS_CLIENTS, JSON.stringify(obj.clients));
        if ('credits' in obj) localStorage.setItem(keys.LS_CREDITS, Number(obj.credits));
        if ('cost' in obj)    localStorage.setItem(keys.LS_COST, Number(obj.cost));
        if ('price' in obj)   localStorage.setItem(keys.LS_PRICE, Number(obj.price));
        if ('saleDefault' in obj) localStorage.setItem(keys.LS_SALE, Number(obj.saleDefault));
        if ('user' in obj && obj.user) localStorage.setItem(keys.LS_USER, obj.user);

        // Try to push into in-memory state if available
        if (window.state){
          if (obj.clients) state.clients = obj.clients;
          if ('credits' in obj) state.credits = Number(obj.credits);
          if ('cost' in obj) state.cost = Number(obj.cost);
          if ('price' in obj) state.price = Number(obj.price);
          if ('saleDefault' in obj) state.saleDefault = Number(obj.saleDefault);
          if ('user' in obj && obj.user) state.user = obj.user;
        }

        // Re-render if app provides methods
        if (typeof loadUserData === 'function') try{ loadUserData(); }catch(e){}
        if (typeof render === 'function') try{ render(); }catch(e){}

        alert('Import effectué ✅');
      }catch(err){
        console.error(err);
        alert('Fichier invalide.');
      }
    };
    reader.readAsText(file);
  }

  function resetData(){
    if (!confirm('Tout supprimer pour ce compte ?')) return;
    const keys = getKeys();
    try{
      localStorage.removeItem(keys.LS_CLIENTS);
      localStorage.removeItem(keys.LS_CREDITS);
      localStorage.removeItem(keys.LS_COST);
      localStorage.removeItem(keys.LS_PRICE);
      localStorage.removeItem(keys.LS_SALE);
      // Ne supprimez pas l'utilisateur par défaut إلا إذا بغيتي
      // localStorage.removeItem(keys.LS_USER);

      if (window.state){
        state.clients = [];
        state.credits = 0;
        state.cost = 0;
        state.price = 0;
        state.saleDefault = 0;
      }

      if (typeof loadUserData === 'function') try{ loadUserData(); }catch(e){}
      if (typeof render === 'function') try{ render(); }catch(e){}

      alert('Réinitialisé ✓');
    }catch(err){
      console.error(err);
      alert('Reset a échoué.');
    }
  }

  if (btnExport && !btnExport.__bound){ btnExport.addEventListener('click', function(e){ e.preventDefault(); exportData(); }); btnExport.__bound = true; }
  if (btnImport && !btnImport.__bound){ btnImport.addEventListener('click', function(e){ e.preventDefault(); if(fileInput) fileInput.click(); }); btnImport.__bound = true; }
  if (fileInput && !fileInput.__bound){ fileInput.addEventListener('change', function(){ if(this.files && this.files[0]) importData(this.files[0]); this.value = ''; }); fileInput.__bound = true; }
  if (btnReset && !btnReset.__bound){ btnReset.addEventListener('click', function(e){ e.preventDefault(); resetData(); }); btnReset.__bound = true; }
});
  </script>
<script>
   // === Close Tools Overlay with × button ===
document.addEventListener('DOMContentLoaded', function(){
  const closeBtn = document.getElementById('closeTools');
  const toolsOverlay = document.getElementById('toolsOverlay');

  if (closeBtn && toolsOverlay && !closeBtn.__bound){
    closeBtn.addEventListener('click', function(e){
      e.preventDefault();
      toolsOverlay.style.display = 'none';
      toolsOverlay.setAttribute('aria-hidden','true');
    });
    closeBtn.__bound = true;
  }
});
  </script>
<script>
   // === Desktop Settings (⚙️) opens same popup as mobile ===
document.addEventListener('DOMContentLoaded', function(){
  const btnSettings = document.getElementById('btnSettings');
  const settingsOverlay = document.getElementById('settingsOverlay');
  const settingsCard = document.getElementById('settingsCard');
  const settingsMount = document.getElementById('settingsMount');

  function openSettings(){
    try {
      if (settingsMount && settingsCard && settingsCard.parentNode !== settingsMount){
        settingsMount.appendChild(settingsCard);
      }
      if (settingsCard){ settingsCard.classList.remove('hidden'); }
      if (settingsOverlay){
        settingsOverlay.style.display = 'flex';
        settingsOverlay.setAttribute('aria-hidden','false');
      }
    } catch(e){
      console.warn('openSettings error', e);
    }
  }

  if (btnSettings && !btnSettings.__bound){
    btnSettings.addEventListener('click', function(e){
      e.preventDefault();
      openSettings();
    }, true);
    btnSettings.__bound = true;
  }
});
  </script>
<script>
   document.addEventListener('DOMContentLoaded', function(){
  var settingsOverlay = document.getElementById('settingsOverlay');
  var settingsCard = document.getElementById('settingsCard');
  var settingsMount = document.getElementById('settingsMount');
  var closeSettings = document.getElementById('closeSettings');
  var saveBtn = document.getElementById('btnSaveSettings');
  var btnSettings = document.getElementById('btnSettings');
  var mobileSettings = document.getElementById('mobileSettings');

  function openSettings(){
    if (settingsMount && settingsCard && settingsCard.parentNode !== settingsMount){
      settingsMount.appendChild(settingsCard);
    }
    if (settingsCard) settingsCard.classList.remove('hidden');
    if (settingsOverlay){
      settingsOverlay.style.display = 'flex';
      settingsOverlay.setAttribute('aria-hidden','false');
    }
  }
  function closeSettingsFn(){
    if (settingsOverlay){
      settingsOverlay.style.display = 'none';
      settingsOverlay.setAttribute('aria-hidden','true');
    }
  }

  if (btnSettings && !btnSettings.__openBound){
    btnSettings.addEventListener('click', function(e){ e.preventDefault(); openSettings(); });
    btnSettings.__openBound = true;
  }
  if (mobileSettings && !mobileSettings.__openBound){
    mobileSettings.addEventListener('click', function(e){ e.preventDefault(); openSettings(); });
    mobileSettings.__openBound = true;
  }
  if (closeSettings && !closeSettings.__closeBound){
    closeSettings.addEventListener('click', function(e){ e.preventDefault(); closeSettingsFn(); });
    closeSettings.__closeBound = true;
  }
  if (settingsOverlay && !settingsOverlay.__backdropClose){
    settingsOverlay.addEventListener('click', function(e){
      if (e.target === settingsOverlay) closeSettingsFn();
    });
    settingsOverlay.__backdropClose = true;
  }
  if (saveBtn && !saveBtn.__saveBound){
    saveBtn.addEventListener('click', function(e){
      e.preventDefault();
      try {
        var credits = document.getElementById('inputCredits')?.value || 0;
        var cost    = document.getElementById('inputCost')?.value || 0;
        var price   = document.getElementById('inputPrice')?.value || 0;
        var sale    = document.getElementById('inputSale')?.value || 0;
        var settings = { credits: Number(credits), cost: Number(cost), price: Number(price), sale: Number(sale) };
        localStorage.setItem("iptv_settings", JSON.stringify(settings));
        alert("Paramètres enregistrés ✅");
        if (typeof render === 'function') try{ render(); }catch(_){}
        closeSettingsFn();
      } catch(err){
        console.error(err);
        alert("Erreur lors de l'enregistrement !");
      }
    });
    saveBtn.__saveBound = true;
  }
});
  </script>
<script>
   // === Row Actions Dropdown Logic ===
(function(){
  // Close all dropdowns helper
  function closeAll(){
    document.querySelectorAll('.actions-dropdown.open').forEach(d=> d.classList.remove('open'));
    document.querySelectorAll('.actions-menu').forEach(m=> m.classList.add('hidden'));
  }
  // Delegate clicks
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.actions-btn');
    const isInsideDropdown = !!e.target.closest('.actions-dropdown');
    // Toggle on button click
    if(btn){
      e.preventDefault();
      const dd = btn.closest('.actions-dropdown');
      const menu = dd?.querySelector('.actions-menu');
      const willOpen = !dd.classList.contains('open');
      closeAll();
      if(willOpen){
        dd.classList.add('open');
        menu?.classList.remove('hidden');
      }
      return;
    }
    // Close if clicking outside any dropdown
    if(!isInsideDropdown){
      closeAll();
    }
  }, true);

  // Also close on Escape
  window.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){ closeAll(); }
  });

  // Re-close dropdowns after any action (edit/toggle/del) to keep UX clean
  document.addEventListener('click', function(e){
    const act = e.target?.dataset?.act;
    if(act==='edit' || act==='toggle' || act==='del'){
      closeAll();
    }
  });
})();
  </script>
<!-- Reseller Feature Script (injected) -->
<script id="reseller-script">
   (function(){
  if(window.__resellerFeatureLoaded){ return; }
  window.__resellerFeatureLoaded = true;

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  function readInt(el){ const n = el ? parseInt((el.textContent||el.value||'').replace(/[^\d-]/g,''),10) : NaN; return isNaN(n) ? 0 : n; }
  function setInt(el, val){ if(!el) return; el.textContent = String(val); }

  const LS_KEY = 'iptv_resellers_v1';
  function loadResellers(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
  function saveResellers(list){ localStorage.setItem(LS_KEY, JSON.stringify(list||[])); }

  function getMainCreditsEl(){ return document.getElementById('creditsLeft'); }

  // Header buttons (Add Reseller + Reseller List)
  const toolsWrap = document.querySelector('.tools-wrap');
  if(toolsWrap){
    if(!$('#btnAddResellerOpen', toolsWrap)){
      const btn = document.createElement('button');
      btn.className = 'btn-brown'; btn.id = 'btnAddResellerOpen'; btn.textContent = 'Add Reseller';
      toolsWrap.appendChild(btn);
    }
    if(!$('#btnResellerListToggle', toolsWrap)){
      const btn2 = document.createElement('button');
      btn2.className = 'btn-brown'; btn2.id = 'btnResellerListToggle'; btn2.textContent = 'Reseller List';
      toolsWrap.appendChild(btn2);
    }
  }

    // Add/Edit Reseller Modal
  if(!$('#resellerModal')){
    const modal = document.createElement('div');
    modal.className = 'generic-modal'; modal.id = 'resellerModal'; modal.setAttribute('aria-hidden','true');
    modal.innerHTML = [
      '<div class="gm-content" style="max-width:520px;min-width:420px">',
        '<div class="gm-header">',
          '<h3 class="gm-title" id="resellerModalTitle">Add Reseller</h3>',
          '<button class="gm-close" id="closeReseller">×</button>',
        '</div>',
        '<div class="row" style="margin-top:6px">',
          '<div class="field">',
            '<label>Nom du reseller</label>',
            '<input class="input" id="r_name" placeholder="ex: Ahmed"/>',
          '</div>',
          '<div class="field">',
            '<label>Crédits attribués</label>',
            '<input class="input" id="r_credits" type="number" min="0" step="1" placeholder="ex: 10"/>',
          '</div>',
        '</div>',
        '<div class="actions">',
          '<button class="btn-outline" id="btnResellerCancel">Annuler</button>',
          '<button class="btn-save" id="btnResellerSave">Save</button>',
        '</div>',
        '<div class="hint" id="r_msg"></div>',
      '</div>'
    ].join('');
    document.body.appendChild(modal);
  }// Reseller List Modal
  if(!$('#resellerListModal')){
    const modal = document.createElement('div');
    modal.className = 'generic-modal'; modal.id = 'resellerListModal'; modal.setAttribute('aria-hidden','true');
    modal.innerHTML = [
      '<div class="gm-content" style="max-width:900px;min-width:600px">',
        '<div class="gm-header">',
          '<h3 class="gm-title">Reseller Tools</h3>',
          '<button class="gm-close" id="closeResellerList">×</button>',
        '</div>',
        '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin:10px 0">',
          '<h2>Reseller List</h2>',
          '<span class="tag">Total: <strong id="resellerCount">0</strong></span>',
        '</div>',
        '<div style="overflow:auto;max-height:60vh;border-radius:12px;border:1px solid rgba(255,255,255,.08);margin-top:8px">',
          '<table style="width:100%">',
            '<thead>',
              '<tr>',
                '<th>#</th>',
                '<th>Reseller</th>',
                '<th>Crédits attribués</th><th>Date</th><th>Statut</th>',
                '<th>Actions</th>',
              '</tr>',
            '</thead>',
            '<tbody id="resellersTbody"></tbody>',
          '</table>',
        '</div>',
        '<div class="hint"></div>',
      '</div>'
    ].join('');
    document.body.appendChild(modal);
  }

  // Render list
  function renderResellers(){
    const tbody = $('#resellersTbody'); const countEl = $('#resellerCount');
    if(!tbody) return;
    tbody.innerHTML = '';
    const list = loadResellers().map((r,i)=> ({...r, idx:i+1}));
    if(countEl) countEl.textContent = String(list.length);
    if(list.length===0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4; td.textContent = 'Aucun reseller.'; td.style.color='#cbd5e1'; td.style.padding='16px';
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    for(const r of list){
      const tr = document.createElement('tr');
      tr.innerHTML = [
        '<td style="padding:8px">', r.idx, '</td>',
        '<td style="padding:8px"><strong>', escapeHtml(r.name), '</strong></td>',
        '<td style="padding:8px">', r.credits, '</td>',
        '<td style="padding:8px">', (r.date || '-'), '</td>',
        '<td style="padding:8px">',
          (r.status==='paid' ? '<span class="pill pill-green">Payé</span>' : '<span class="pill pill-grey">Non payé</span>'),
        '</td>',
        '<td style="padding:8px">',
          '<button class="btn-outline actions-btn" data-rid="', r.id, '">⚙️ Actions</button>',
        '</td>'
      ].join('');
      tbody.appendChild(tr);
    }
  }

  // Open/Close helpers
  const addBtn   = $('#btnAddResellerOpen');
  const listBtn  = $('#btnResellerListToggle');
  const rModal   = $('#resellerModal');
  const listModal= $('#resellerListModal');
  const titleEl  = $('#resellerModalTitle');
  const r_name   = $('#r_name'); const r_cred = $('#r_credits'); const r_msg = $('#r_msg');
  const btnClose = $('#closeReseller'); const btnCancel = $('#btnResellerCancel'); const btnSave = $('#btnResellerSave');
  const btnListClose = $('#closeResellerList');
  let editId = null;

  function openAddEdit(mode, data){
    editId = (mode==='edit' && data) ? data.id : null;
    if(titleEl) titleEl.textContent = editId ? 'Edit Reseller' : 'Add Reseller';
    const _rname = document.getElementById('r_name'); if(_rname) _rname.value = (data && data.name) || '';
    const r_buy = document.getElementById('r_buy');
    const r_sell = document.getElementById('r_sell');
    if(r_buy) r_buy.value = (data && typeof data.buy==='number') ? data.buy : (function(){ try{var pm=__priceMapLoad?__priceMapLoad():{}; var k=(data&&data.name)||''; if(pm[k]) return pm[k].buy||''; }catch(_){} return ''; })();
    if(r_sell) r_sell.value = (data && typeof data.sell==='number') ? data.sell : (function(){ try{var pm=__priceMapLoad?__priceMapLoad():{}; var k=(data&&data.name)||''; if(pm[k]) return pm[k].sell||''; }catch(_){} return ''; })();
    const _rcred = document.getElementById('r_credits'); if(_rcred) _rcred.value = (data && typeof data.credits==='number') ? data.credits : '';
    if(r_msg){ r_msg.textContent=''; r_msg.style.color=''; }
    if(rModal){ rModal.style.display='flex'; rModal.setAttribute('aria-hidden','false'); rModal.dataset.rid = editId || ''; window.__currentEditRid = editId || ''; }
  }
  function closeAddEdit(){
    if(rModal){ rModal.style.display='none'; rModal.setAttribute('aria-hidden','true'); }
    editId = null;
  }

  addBtn && addBtn.addEventListener('click', ()=> openAddEdit('add'));
  btnClose && btnClose.addEventListener('click', closeAddEdit);
  btnCancel && btnCancel.addEventListener('click', closeAddEdit);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && rModal && rModal.style.display==='flex') closeAddEdit(); });

  // List modal open/close
  listBtn && listBtn.addEventListener('click', ()=>{ renderResellers(); listModal.style.display='flex'; listModal.setAttribute('aria-hidden','false'); });
  btnListClose && btnListClose.addEventListener('click', ()=>{ listModal.style.display='none'; listModal.setAttribute('aria-hidden','true'); });

  // Save (add / edit)
  function err(msg){ if(r_msg){ r_msg.textContent=msg; r_msg.style.color='var(--danger)'; } }
  function ok(msg){ if(r_msg){ r_msg.textContent=msg; r_msg.style.color='var(--accent)'; } }

  
  // Delegated Save (add / edit) to ensure elements exist
  document.addEventListener('click', function(e){
    if(!e.target || e.target.id !== 'btnResellerSave') return;
    const r_name_el = document.getElementById('r_name');
    const r_cred_el = document.getElementById('r_credits');
    const name = (r_name_el && r_name_el.value || '').trim();
    const credits = parseInt(r_cred_el && r_cred_el.value || '0', 10);
    const buy = parseInt((document.getElementById('r_buy')?.value || '0'), 10) || 0;
    const sell = parseInt((document.getElementById('r_sell')?.value || '0'), 10) || 0;
    const profit = sell - buy;
    (function(){ const pm=window.__priceMapLoad?__priceMapLoad():{}; if(name){ pm[name]={buy,sell,profit}; if(window.__priceMapSave) __priceMapSave(pm);} })();
    
    if(!name){ if(r_msg){ r_msg.textContent='Reseller name obligatoire.'; r_msg.style.color='var(--danger)'; } return; }
    if(isNaN(credits) || credits<0){ if(r_msg){ r_msg.textContent='Crédits invalides.'; r_msg.style.color='var(--danger)'; } return; }

    const mainEl = getMainCreditsEl(); let main = readInt(mainEl);
    const list = loadResellers();

    if(!editId){
      if(main < credits){ if(r_msg){ r_msg.textContent='Crédits insuffisants. Restants: '+main; r_msg.style.color='var(--danger)'; } return; }
      list.unshift({ id: crypto.randomUUID(), name, credits, buy, sell, profit, date: new Date().toISOString().slice(0,10), status: 'unpaid' });
      saveResellers(list); (function(){ const pm=window.__priceMapLoad?__priceMapLoad():{}; if(name){ pm[name]={buy:sell?buy:buy, sell:sell, profit:profit}; if(window.__priceMapSave) __priceMapSave(pm);} })(); try{}catch(_){}
      main -= credits; setInt(mainEl, main);
      if(r_msg){ r_msg.textContent='Reseller ajouté ✓'; r_msg.style.color='var(--accent)'; }
      closeAddEdit(); renderResellers();
      return;
    }

    const idx = list.findIndex(x=> x.id===editId);
    if(idx<0){ closeAddEdit(); return; }
    const prev = list[idx].credits||0; const delta = credits - prev;
    if(delta>0){
      if(main < delta){ if(r_msg){ r_msg.textContent='Crédits insuffisants pour +'+delta+'. Restants: '+main; r_msg.style.color='var(--danger)'; } return; }
      main -= delta;
    } else if(delta<0){
      main += Math.abs(delta);
    }
    list[idx].name = name; list[idx].credits = credits; list[idx].buy = buy; list[idx].sell = sell; list[idx].profit = profit;
    saveResellers(list); (function(){ const pm=window.__priceMapLoad?__priceMapLoad():{}; if(name){ pm[name]={buy:sell?buy:buy, sell:sell, profit:profit}; if(window.__priceMapSave) __priceMapSave(pm);} })(); try{}catch(_){} setInt(mainEl, main);
    if(r_msg){ r_msg.textContent='Modifié ✓'; r_msg.style.color='var(--accent)'; }
    closeAddEdit(); renderResellers();
  });
;

  // Floating actions menu
  (function floatingActions(){
    function $all(s, r){ return Array.from((r||document).querySelectorAll(s)); }
    function closeMenus(){ $all('.reseller-floating-menu').forEach(m=> m.remove()); }

    document.addEventListener('click', function(e){
      const isMenu = !!e.target.closest('.reseller-floating-menu');
      const isBtn  = !!e.target.closest('.actions-btn');
      if(!isMenu && !isBtn){ closeMenus(); }
    }, true);

    document.addEventListener('click', function(e){
      const btn = e.target.closest('.actions-btn'); if(!btn) return;
      e.preventDefault(); e.stopPropagation(); closeMenus();
      const rid = btn.dataset.rid; if(!rid) return;
      const rect = btn.getBoundingClientRect();
      const menu = document.createElement('div');
      menu.className = 'reseller-floating-menu';
      menu.innerHTML = '<button class="menu-item" data-ract="edit" data-rid="'+rid+'">Modifier</button>' +
                       '<button class="menu-item" data-ract="extend" data-rid="'+rid+'">Extend</button>' +
                       '<button class="menu-item danger" data-ract="del" data-rid="'+rid+'">Supprimer</button>';
      document.body.appendChild(menu);
      const margin = 6;
      let top = rect.bottom + margin;
      let left = rect.right - menu.offsetWidth;
      const vw = window.innerWidth, vh = window.innerHeight;
      if(left + menu.offsetWidth > vw - 8) left = vw - menu.offsetWidth - 8;
      if(left < 8) left = 8;
      if(top + menu.offsetHeight > vh - 8) top = rect.top - menu.offsetHeight - margin;
      if(top < 8) top = 8;
      menu.style.top = top + 'px'; menu.style.left = left + 'px';
    });

    window.addEventListener('resize', closeMenus);
    window.addEventListener('scroll', closeMenus, true);

    // Handle menu item clicks (edit/extend/delete)
    document.addEventListener('click', function(e){
      const mi = e.target.closest('.menu-item'); if(!mi) return;
      const act = mi.dataset.ract; const id = mi.dataset.rid;
      const list = loadResellers(); const r = list.find(x=> x.id===id); if(!r) return;

      if(act==='edit'){
        // Close list modal first so edit popup is on top
        if(listModal){ listModal.style.display='none'; listModal.setAttribute('aria-hidden','true'); }
        openAddEdit('edit', r);
      } else if(act==='extend'){
        alert('Extend: bientôt (placeholder)');
      } else if(act==='del'){
        if(confirm('Supprimer '+r.name+' ? Ses '+r.credits+' crédits seront retournés au principal.')){
          const mainEl = getMainCreditsEl(); let main = readInt(mainEl);
          main += (r.credits||0); setInt(mainEl, main);
          const rest = list.filter(x=> x.id!==id); saveResellers(rest); renderResellers();
        }
      }
    });
  })();

  document.addEventListener('DOMContentLoaded', renderResellers);
  renderResellers();
})();

  // Post-Save patcher: ensure buy/sell/profit persist correctly (covers any older handlers overriding data)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnResellerSave');
    if(!btn) return;
    // Run after the main save handler
    setTimeout(function(){
      try {
        const nameEl = document.getElementById('r_name');
        const creditsEl = document.getElementById('r_credits');
        const buyEl = document.getElementById('r_buy');
        const sellEl = document.getElementById('r_sell');
        const modal = document.getElementById('resellerModal');

        const name = (nameEl && nameEl.value || '').trim();
        const credits = parseInt(creditsEl && creditsEl.value || '0', 10) || 0;
        const buy = parseInt(buyEl && buyEl.value || '0', 10) || 0;
        const sell = parseInt(sellEl && sellEl.value || '0', 10) || 0;
        const profit = sell - buy;
        const rid = (modal && modal.dataset.rid) || (window.__currentEditRid || '');

        const list = loadResellers();
        if(!Array.isArray(list)) return;

        if(rid){
          const idx = list.findIndex(x => x.id === rid);
          if(idx >= 0){
            list[idx].buy = buy; list[idx].sell = sell; list[idx].profit = profit;
            saveResellers(list); (function(){ const pm=window.__priceMapLoad?__priceMapLoad():{}; if(name){ pm[name]={buy:sell?buy:buy, sell:sell, profit:profit}; if(window.__priceMapSave) __priceMapSave(pm);} })(); try{}catch(_){}
          }
        } else {
          // Newly added: find most likely entry
          let idx = list.findIndex(x => (x.name||'').trim() === name && Number(x.credits||0) === credits);
          if(idx < 0){
            // fallback: first item lacking buy/sell or the most recent (index 0)
            idx = list.findIndex(x => !x.buy && !x.sell);
            if(idx < 0) idx = 0;
          }
          if(list[idx]){
            list[idx].buy = buy; list[idx].sell = sell; list[idx].profit = profit;
            saveResellers(list); (function(){ const pm=window.__priceMapLoad?__priceMapLoad():{}; if(name){ pm[name]={buy:sell?buy:buy, sell:sell, profit:profit}; if(window.__priceMapSave) __priceMapSave(pm);} })(); try{}catch(_){}
          }
        }
      } catch(_) {}
    }, 0);
  }, true);
  </script>
<!-- Extend Reseller Credits Modal (injected) -->
<div aria-hidden="true" class="generic-modal" id="extendResellerModal">
<div class="gm-content" style="max-width:520px;min-width:420px">
<div class="gm-header">
<h3 class="gm-title">
      Extend Credits
     </h3>
<button class="gm-close" id="closeExtend">
      ×
     </button>
</div>
<div class="row" style="margin-top:6px">
<div class="field">
<label>
       Crédits à ajouter
      </label>
<input class="input" id="ext_credits" min="1" placeholder="ex: 5" step="1" type="number"/>
</div>
</div>
<div class="actions">
<button class="btn-outline" id="btnExtendCancel">
      Annuler
     </button>
<button class="btn-save" id="btnExtendSave">
      Save
     </button>
</div>
</div>
</div>
<div class="hint" id="ext_msg">
</div>
<script id="extend-reseller-logic">
   (function(){
  if(window.__extendResellerLogicLoaded) return;
  window.__extendResellerLogicLoaded = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function readInt(el){ const n = el ? parseInt((el.textContent||el.value||'').replace(/[^\d-]/g,''),10) : NaN; return isNaN(n) ? 0 : n; }
  function setInt(el, val){ if(!el) return; el.textContent = String(val); }
  function getMainCreditsEl(){ return document.getElementById('creditsLeft'); }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  const modal = $('#extendResellerModal');
  const closeBtn = $('#closeExtend');
  const cancelBtn = $('#btnExtendCancel');
  const saveBtn = $('#btnExtendSave');
  const nameEl = $('#ext_name');
  const creditsEl = $('#ext_credits');
  const msgEl = $('#ext_msg');

  let extendId = null;

  function openExtend(reseller){
    extendId = reseller?.id || null;
    if(nameEl) nameEl.value = reseller ? reseller.name : '';
    if(creditsEl) creditsEl.value = '';
    if(msgEl){ msgEl.textContent = ''; msgEl.style.color=''; }
    if(modal){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    setTimeout(()=>{ try{ creditsEl && creditsEl.focus(); }catch{} }, 0);
  }
  function closeExtend(){
    if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    extendId = null;
  }
  function err(t){ if(msgEl){ msgEl.textContent = t; msgEl.style.color='var(--danger)'; } }
  function ok(t){ if(msgEl){ msgEl.textContent = t; msgEl.style.color='var(--accent)'; } }

  closeBtn && closeBtn.addEventListener('click', closeExtend);
  cancelBtn && cancelBtn && cancelBtn.addEventListener('click', closeExtend);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal && modal.style.display==='flex') closeExtend(); });
  modal && modal.addEventListener('click', (e)=>{ if(e.target===modal) closeExtend(); });

  // Hook into existing floating menu "Extend" action
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="extend"]');
    if(!mi) return;
    const rid = mi.dataset.rid;
    const list = load();
    const r = list.find(x=> x.id===rid);
    if(!r) return;
    // close the list modal if open so extend modal shows clearly
    const listModal = document.getElementById('resellerListModal');
    if(listModal){ listModal.style.display = 'none'; listModal.setAttribute('aria-hidden','true'); }
    openExtend(r);
  });

  // Save extend
  saveBtn && saveBtn.addEventListener('click', function(){
    const add = parseInt(creditsEl && creditsEl.value || '0', 10);
    if(isNaN(add) || add <= 0) return err('Entrer un nombre > 0.');

    const mainEl = getMainCreditsEl();
    let main = readInt(mainEl);
    if(main < add) return err('Crédits insuffisants. Restants: '+main);

    const list = load();
    const idx = list.findIndex(x=> x.id===extendId);
    if(idx < 0) return closeExtend();

    // apply
    list[idx].credits = (list[idx].credits||0) + add;
    try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
    main -= add; setInt(mainEl, main);
    ok('Crédits ajoutés ✓');
    closeExtend();

    // trigger re-render if function exists
    try{ if(typeof renderResellers === 'function') renderResellers(); }catch{}
  });
})();
  </script>
<script id="extend-intercept-capture">
   (function(){
  if(window.__extendInterceptCaptureLoaded) return;
  window.__extendInterceptCaptureLoaded = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }

  // Capture-phase listener to preempt older 'alert' handler
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="extend"]');
    if(!mi) return;
    e.preventDefault(); e.stopPropagation();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();

    const rid = mi.dataset.rid;
    const list = load();
    const r = list.find(x=> x.id===rid);
    if(!r) return;

    // Close Reseller List modal if open
    const listModal = document.getElementById('resellerListModal');
    if(listModal){ listModal.style.display = 'none'; listModal.setAttribute('aria-hidden','true'); }

    // Open Extend modal directly
    const modal = document.getElementById('extendResellerModal');
    const nameEl = document.getElementById('ext_name');
    const creditsEl = document.getElementById('ext_credits');
    const msgEl = document.getElementById('ext_msg');

    if(nameEl) nameEl.value = r.name || '';
    if(creditsEl) creditsEl.value = '';
    if(msgEl){ msgEl.textContent=''; msgEl.style.color=''; }

    if(modal){
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=>{ try{ creditsEl && creditsEl.focus(); }catch{} }, 0);
    }
  }, true); // <== capture phase
})();
  </script>
<script id="extend-reseller-logic-override-OLD">
   (function(){
  if(window.__extendResellerOverrideLoaded) return;
  window.__extendResellerOverrideLoaded = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function readInt(el){ const n = el ? parseInt((el.textContent||el.value||'').replace(/[^\d-]/g,''),10) : NaN; return isNaN(n) ? 0 : n; }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  function getMainCredits(){
    if(window.state && typeof window.state.credits === 'number') return window.state.credits;
    const leftEl = document.getElementById('creditsLeft');
    return readInt(leftEl);
  }
  function setMainCredits(val){
    if(window.state && typeof window.state.credits === 'number'){
      window.state.credits = val;
      try{ if(typeof window.saveUserData === 'function') window.saveUserData(); }catch{}
      try{ if(typeof window.updateTotals === 'function') window.updateTotals(); }catch{}
    } else {
      const leftEl = document.getElementById('creditsLeft');
      if(leftEl) leftEl.textContent = String(val);
    }
  }

  // Rebind the Extend Save to use state.credits
  const saveBtn = document.getElementById('btnExtendSave');
  const creditsEl = document.getElementById('ext_credits');
  const nameEl = document.getElementById('ext_name');
  const msgEl = document.getElementById('ext_msg');
  const modal = document.getElementById('extendResellerModal');

  function err(t){ if(msgEl){ msgEl.textContent = t; msgEl.style.color='var(--danger)'; } }
  function closeExtend(){ if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } }

  // We need to track the currently selected reseller id; we can store it on the modal dataset from the intercept
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="extend"]');
    if(!mi) return;
    const rid = mi.dataset.rid;
    const m = document.getElementById('extendResellerModal');
    if(m){ m.dataset.rid = rid || ''; }
  }, true);

  function getCurrentRid(){
    const m = document.getElementById('extendResellerModal');
    return m ? (m.dataset.rid || '') : '';
  }

  if(saveBtn){
    // Replace any previous click by cloning
    const clone = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(clone, saveBtn);
    clone.addEventListener('click', function(){
      const add = parseInt(creditsEl && creditsEl.value || '0', 10);
      if(isNaN(add) || add <= 0) return err('Entrer un nombre > 0.');
      let main = getMainCredits();
      if(main < add) return err('Crédits insuffisants. Restants: '+main);

      const rid = getCurrentRid();
      const list = load();
      const idx = list.findIndex(x=> x.id===rid);
      if(idx < 0) return closeExtend();

      list[idx].credits = (list[idx].credits||0) + add;
      try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}

      setMainCredits(main - add);

      // refresh list if available
      try{ if(typeof window.renderResellers === 'function') window.renderResellers(); }catch{}

      closeExtend();
    });
  }
})();
  </script>
<script id="extend-reseller-logic-override">
   (function(){
  if(window.__extendResellerOverride2Loaded) return;
  window.__extendResellerOverride2Loaded = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  const saveBtn = document.getElementById('btnExtendSave');
  const creditsEl = document.getElementById('ext_credits');
  const modal = document.getElementById('extendResellerModal');
  const msgEl = document.getElementById('ext_msg');

  function err(t){ if(msgEl){ msgEl.textContent=t; msgEl.style.color='var(--danger)'; } }
  function closeExtend(){ if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } }

  // Ensure dataset.rid is set on opening extend (keep from intercept)
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="extend"]');
    if(!mi) return;
    const m = document.getElementById('extendResellerModal');
    if(m){ m.dataset.rid = mi.dataset.rid || ''; }
  }, true);

  function getRid(){
    const m = document.getElementById('extendResellerModal'); return m ? (m.dataset.rid || '') : '';
  }

  if(saveBtn){
    const clone = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(clone, saveBtn);
    clone.addEventListener('click', function(){
      const add = parseInt(creditsEl && creditsEl.value || '0', 10);
      if(isNaN(add) || add <= 0) return err('Entrer un nombre > 0.');

      // mutate true app state if available
      try{
        if(typeof state !== 'undefined'){
          if(state.credits < add) return err('Crédits insuffisants. Restants: '+state.credits);
        }
      }catch(_){}

      const rid = getRid();
      const list = load();
      const idx = list.findIndex(x=> x.id===rid);
      if(idx < 0) return closeExtend();

      list[idx].credits = (list[idx].credits||0) + add;
      try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}

      // Deduct from state.credits if possible; else fallback to LS directly
      let deducted = false;
      try{
        if(typeof state !== 'undefined'){
          state.credits = (state.credits||0) - add;
          if(typeof saveUserData === 'function') saveUserData();
          if(typeof updateTotals === 'function') updateTotals();
          deducted = true;
        }
      }catch(_){}

      if(!deducted){
        // Fallback: write to LS_CREDITS key and update UI
        try{
          if(typeof userKeys === 'function'){
            const keys = userKeys();
            if(keys && keys.LS_CREDITS){
              const cur = parseInt(localStorage.getItem(keys.LS_CREDITS) || '0', 10);
              const next = Math.max(0, cur - add);
              localStorage.setItem(keys.LS_CREDITS, String(next));
              // Try reload just credits
              if(typeof loadUserData === 'function') loadUserData();
              if(typeof updateTotals === 'function') updateTotals();
            }
          }
        }catch(_){}
      }

      try{ if(typeof renderResellers === 'function') renderResellers(); }catch(_){}
      closeExtend();
    });
  }
})();
  </script>
<script id="extend-save-capture-fix">
   (function(){
  if(window.__extendSaveCaptureFixLoaded) return;
  window.__extendSaveCaptureFixLoaded = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function readInt(el){ const n = el ? parseInt((el.textContent||el.value||'').replace(/[^\d-]/g,''),10) : NaN; return isNaN(n) ? 0 : n; }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  function getKeys(){
    try{ return typeof userKeys === 'function' ? userKeys() : null; }catch(_){ return null; }
  }

  function getRid(){
    const m = document.getElementById('extendResellerModal');
    return m ? (m.dataset.rid || '') : '';
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnExtendSave');
    if(!btn) return;

    // Take over
    e.preventDefault();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();
    e.stopPropagation();

    const creditsEl = $('#ext_credits');
    const msgEl = $('#ext_msg');
    function err(t){ if(msgEl){ msgEl.textContent=t; msgEl.style.color='var(--danger)'; } }

    const add = parseInt(creditsEl && creditsEl.value || '0', 10);
    if(isNaN(add) || add <= 0) return err('Entrer un nombre > 0.');

    // Check and deduct from main credits
    let mainCredits = null;
    try{
      if(typeof state !== 'undefined' && typeof state.credits === 'number'){
        mainCredits = state.credits;
      } else {
        const keys = getKeys();
        if(keys && keys.LS_CREDITS){
          mainCredits = parseInt(localStorage.getItem(keys.LS_CREDITS) || '0', 10);
        } else {
          const el = document.getElementById('creditsLeft');
          mainCredits = readInt(el);
        }
      }
    }catch(_){}

    if(mainCredits === null) return err('Impossible de lire les crédits.');
    if(mainCredits < add) return err('Crédits insuffisants. Restants: '+mainCredits);

    // Update reseller
    const rid = getRid();
    const list = load();
    const idx = list.findIndex(x=> x.id===rid);
    if(idx < 0) return err('Reseller introuvable.');
    list[idx].credits = (list[idx].credits||0) + add;
    try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}

    // Deduct and persist
    try{
      if(typeof state !== 'undefined' && typeof state.credits === 'number'){
        state.credits -= add;
        if(typeof saveUserData === 'function') saveUserData();
        if(typeof updateTotals === 'function') updateTotals();
      } else {
        const keys = getKeys();
        if(keys && keys.LS_CREDITS){
          localStorage.setItem(keys.LS_CREDITS, String(Math.max(0, mainCredits - add)));
        }
        // fallback UI update
        const leftEl = document.getElementById('creditsLeft');
        if(leftEl) leftEl.textContent = String(Math.max(0, mainCredits - add));
      }
    }catch(_){}

    // Re-render list if available
    try{ if(typeof renderResellers === 'function') renderResellers(); }catch(_){}

    // Close modal
    const modal = document.getElementById('extendResellerModal');
    if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
  }, true); // capture
})();
  </script>
<script id="extend-track-rid-fix">
   (function(){
  if(window.__extendTrackRidFixLoaded) return;
  window.__extendTrackRidFixLoaded = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }

  // On any Extend menu click, record RID globally and on modal dataset
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="extend"]');
    if(!mi) return;
    const rid = mi.dataset.rid || '';
    window.__currentExtendRid = rid;
    const m = document.getElementById('extendResellerModal');
    if(m){ m.dataset.rid = rid; }
  }, true);

  // When opening Extend modal by any means, if dataset.rid missing, try to infer by name
  function ensureRidFromName(){
    const m = document.getElementById('extendResellerModal');
    const nameEl = document.getElementById('ext_name');
    if(!m || (m.dataset.rid && m.dataset.rid.length)) return;
    const name = (nameEl && nameEl.value || '').trim();
    if(!name) return;
    const list = load();
    const found = list.filter(x=> (x.name||'').trim().toLowerCase() === name.toLowerCase());
    if(found.length === 1){
      m.dataset.rid = found[0].id;
      window.__currentExtendRid = found[0].id;
    }
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnExtendSave');
    if(!btn) return;
    ensureRidFromName();
  }, true);

  // Also run when modal opens (focus event on credits input)
  document.addEventListener('focusin', function(e){
    if(e.target && e.target.id === 'ext_credits'){ ensureRidFromName(); }
  });
})();
  </script>
<script id="reseller-credits-rules">
   (function(){
  if(window.__resellerCreditsRulesLoaded) return;
  window.__resellerCreditsRulesLoaded = true;

  // Helpers
  function $(s, r){ return (r||document).querySelector(s); }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }
  function adjustMainCredits(delta){
    try{
      if(typeof state !== 'undefined' && typeof state.credits === 'number'){
        state.credits = Math.max(0, (state.credits||0) + delta);
        if(typeof saveUserData === 'function') saveUserData();
        if(typeof updateTotals === 'function') updateTotals();
        return;
      }
    }catch(_){}
    // Fallback via LS_CREDITS
    try{
      const keys = typeof userKeys === 'function' ? userKeys() : null;
      if(keys && keys.LS_CREDITS){
        const cur = parseInt(localStorage.getItem(keys.LS_CREDITS)||'0',10);
        const nxt = Math.max(0, cur + delta);
        localStorage.setItem(keys.LS_CREDITS, String(nxt));
        if(typeof loadUserData === 'function') loadUserData();
        if(typeof updateTotals === 'function') updateTotals();
      } else {
        const el = document.getElementById('creditsLeft');
        if(el){ el.textContent = String(Math.max(0, parseInt((el.textContent||'0'),10) + delta)); }
      }
    }catch(_){}
  }

  // Track current Edit/Extend target IDs
  document.addEventListener('click', function(e){
    const miEdit = e.target.closest('.menu-item[data-ract="edit"]');
    if(miEdit){
      const rid = miEdit.dataset.rid || '';
      window.__currentEditRid = rid;
      const modal = document.getElementById('resellerModal');
      if(modal) modal.dataset.rid = rid;
    }
    const miExt = e.target.closest('.menu-item[data-ract="extend"]');
    if(miExt){
      const rid = miExt.dataset.rid || '';
      window.__currentExtendRid = rid;
      const modal = document.getElementById('extendResellerModal');
      if(modal) modal.dataset.rid = rid;
    }
  }, true);

  // DELETE (capture — single source of truth)
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="del"]');
    if(!mi) return;
    e.preventDefault(); if(e.stopImmediatePropagation) e.stopImmediatePropagation(); e.stopPropagation();

    const rid = mi.dataset.rid || '';
    const list = load();
    const r = list.find(x=> x.id===rid);
    if(!r) return;

    if(confirm(`Supprimer ${r.name} ? Ses ${r.credits||0} crédits seront retournés au principal.`)){
      adjustMainCredits(+ (r.credits||0));
      const rest = list.filter(x=> x.id!==rid);
      save(rest);
      try{ if(typeof renderResellers === 'function') renderResellers(); }catch(_){}
      // close any menus
      document.querySelectorAll('.reseller-floating-menu').forEach(m=>m.remove());
    }
  }, true);

  // EDIT SAVE (capture)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnResellerSave');
    if(!btn) return;
    const title = ($('#resellerModalTitle')?.textContent||'').trim().toLowerCase();
    if(title !== 'edit reseller') return; // let "Add Reseller" follow original path

    e.preventDefault(); if(e.stopImmediatePropagation) e.stopImmediatePropagation(); e.stopPropagation();

    const r_name = $('#r_name'); const r_cred = $('#r_credits'); const r_date = document.getElementById('r_date'); const msg = $('#r_msg');
    const name = (r_name && r_name.value || '').trim();
    const credits = parseInt(r_cred && r_cred.value || '0', 10);
    const buy = parseInt((document.getElementById('r_buy')?.value || '0'), 10) || 0;
    const sell = parseInt((document.getElementById('r_sell')?.value || '0'), 10) || 0;
    const profit = sell - buy;
    if(!name){ if(msg){ msg.textContent='Reseller name obligatoire.'; msg.style.color='var(--danger)'; } return; }
    if(isNaN(credits) || credits<0){ if(msg){ msg.textContent='Crédits invalides.'; msg.style.color='var(--danger)'; } return; }

    const rid = (document.getElementById('resellerModal')?.dataset.rid || window.__currentEditRid || '');
    const list = load();
    const idx = list.findIndex(x=> x.id===rid);
    if(idx<0){ if(msg){ msg.textContent='Reseller introuvable.'; msg.style.color='var(--danger)'; } return; }

    const prev = list[idx].credits||0;
    const delta = credits - prev;  // Positive => need to deduct from main, Negative => return to main

    // Check sufficiency if increasing
    try{
      if(delta>0){
        const can = (typeof state!=='undefined' && typeof state.credits==='number') ? state.credits : Infinity;
        if(can < delta){ if(msg){ msg.textContent='Crédits insuffisants pour +'+delta; msg.style.color='var(--danger)'; } return; }
      }
    }catch(_){}

    list[idx].name = name;
    list[idx].credits = credits;
    if(r_date){ list[idx].date = r_date.value || list[idx].date || ''; }
    try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}

    // Apply to main: subtract delta (which adds if negative)
    adjustMainCredits(-delta);

    // Close popup & refresh
    const modal = document.getElementById('resellerModal');
    if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    try{ if(typeof forceRenderResellersWithStatus === 'function') forceRenderResellersWithStatus(); else if(typeof renderResellers === 'function') renderResellers(); }catch(_){}
  }, true);

  // EXTEND SAVE (capture — always deduct from main)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnExtendSave');
    if(!btn) return;
    e.preventDefault(); if(e.stopImmediatePropagation) e.stopImmediatePropagation(); e.stopPropagation();

    const creditsEl = $('#ext_credits'); const nameEl = $('#ext_name'); const msgEl = $('#ext_msg');
    const add = parseInt(creditsEl && creditsEl.value || '0', 10);
    if(isNaN(add) || add <= 0){ if(msgEl){ msgEl.textContent='Entrer un nombre > 0.'; msgEl.style.color='var(--danger)'; } return; }

    const rid = (document.getElementById('extendResellerModal')?.dataset.rid || window.__currentExtendRid || '');
    const list = load();
    const idx = list.findIndex(x=> x.id===rid);
    if(idx<0){ if(msgEl){ msgEl.textContent='Reseller introuvable.'; msgEl.style.color='var(--danger)'; } return; }

    // Check sufficiency
    try{
      const avail = (typeof state!=='undefined' && typeof state.credits==='number') ? state.credits : Infinity;
      if(avail < add){ if(msgEl){ msgEl.textContent='Crédits insuffisants. Restants: '+avail; msgEl.style.color='var(--danger)'; } return; }
    }catch(_){}

    list[idx].credits = (list[idx].credits||0) + add;
    try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
    adjustMainCredits(-add);

    // close extend modal
    const modal = document.getElementById('extendResellerModal');
    if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    try{ if(typeof renderResellers === 'function') renderResellers(); }catch(_){}
  }, true);
})();
  </script>
<script id="reseller-credits-rules-persist-fix">
   (function(){
  if(window.__resellerCreditsRulesPersistFixLoaded) return;
  window.__resellerCreditsRulesPersistFixLoaded = true;

  function persistMainCreditsAbsolute(newVal){
    try{
      if(typeof state !== 'undefined'){
        state.credits = Math.max(0, parseInt(newVal||'0',10));
        if(typeof saveUserData === 'function') saveUserData();
        if(typeof updateTotals === 'function') updateTotals();
      }
    }catch(_){}
    try{
      if(typeof userKeys === 'function'){
        const keys = userKeys();
        if(keys && keys.LS_CREDITS){
          localStorage.setItem(keys.LS_CREDITS, String(Math.max(0, parseInt(newVal||'0',10))));
        }
      }
    }catch(_){}
    const leftEl = document.getElementById('creditsLeft');
    if(leftEl) leftEl.textContent = String(Math.max(0, parseInt(newVal||'0',10)));
  }

  // Override adjustMainCredits to ALWAYS persist to LS and UI
  if(typeof window.adjustMainCredits === 'function'){
    const prev = window.adjustMainCredits;
    window.adjustMainCredits = function(delta){
      try{ prev(delta); }catch(_){}
      // After previous logic, force persist using current state value (if any) else DOM
      let base = null;
      try{ base = (typeof state!=='undefined' ? state.credits : null); }catch(_){}
      if(base==null){
        const el = document.getElementById('creditsLeft');
        base = el ? parseInt((el.textContent||'0'),10) : 0;
      }
      persistMainCreditsAbsolute(base);
    };
  } else {
    // define it if not present
    window.adjustMainCredits = function(delta){
      let base = null;
      try{ base = (typeof state!=='undefined' ? state.credits : null); }catch(_){}
      if(base==null){
        const el = document.getElementById('creditsLeft');
        base = el ? parseInt((el.textContent||'0'),10) : 0;
      }
      base = Math.max(0, base + (parseInt(delta||'0',10)));
      persistMainCreditsAbsolute(base);
    };
  }

  // After every renderResellers, ensure floating menus are closed
  const closeMenus = ()=> document.querySelectorAll('.reseller-floating-menu').forEach(m=>m.remove());
  document.addEventListener('click', function(e){
    const acted = e.target.closest('.menu-item[data-ract="del"], .menu-item[data-ract="edit"], #btnResellerSave, #btnExtendSave');
    if(acted) setTimeout(closeMenus, 0);
  }, true);

  // Also ensure that after delete we keep list modal interactive without refresh
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="del"]');
    if(!mi) return;
    // After delete, force re-render and re-focus the list modal
    setTimeout(function(){
      try{ if(typeof renderResellers === 'function') renderResellers(); }catch(_){}
      const lm = document.getElementById('resellerListModal');
      if(lm && lm.getAttribute('aria-hidden')==='false'){
        // noop; stays open
      }
    }, 50);
  }, true);

})();
  </script>
<script id="credits-consistency-fix">
   (function(){
  if(window.__creditsConsistencyFixLoaded) return;
  window.__creditsConsistencyFixLoaded = true;

  // --- Single Source of Truth helpers ---
  function getKeysSafe(){
    try{ return (typeof userKeys==='function') ? userKeys() : null; }catch(_){ return null; }
  }
  function readLS(key, def){
    try{ const v = localStorage.getItem(key); return (v==null ? def : v); }catch(_){ return def; }
  }
  function writeLS(key, val){
    try{ localStorage.setItem(key, String(val)); }catch(_){}
  }

  // We'll maintain a global fallback key if userKeys() not ready
  const GLOBAL_CREDITS_KEY = 'iptv_credits_v4_global';

  function getMainCredits(){
    // Prefer state.credits if available
    try{
      if(typeof state!=='undefined' && typeof state.credits==='number'){
        return state.credits;
      }
    }catch(_){}
    // Else prefer user-scoped LS
    const keys = getKeysSafe();
    if(keys && keys.LS_CREDITS){
      const v = parseInt(readLS(keys.LS_CREDITS, '500'), 10);
      return isNaN(v) ? 0 : v;
    }
    // Else fallback to global
    const g = parseInt(readLS(GLOBAL_CREDITS_KEY, '500'), 10);
    return isNaN(g) ? 0 : g;
  }

  function setMainCreditsAbs(newVal){
    const v = Math.max(0, parseInt(newVal||'0',10));
    // 1) state.credits
    try{
      if(typeof state!=='undefined'){
        state.credits = v;
      }
    }catch(_){}
    // 2) user-scoped LS (if available)
    const keys = getKeysSafe();
    if(keys && keys.LS_CREDITS){
      writeLS(keys.LS_CREDITS, v);
    }
    // 3) global fallback
    writeLS(GLOBAL_CREDITS_KEY, v);
    // 4) update UI
    try{
      const leftEl = document.getElementById('creditsLeft');
      if(leftEl) leftEl.textContent = String(v);
      if(typeof saveUserData==='function') saveUserData();
      if(typeof updateTotals==='function') updateTotals();
    }catch(_){}
    return v;
  }

  function addToMainCredits(delta){
    const base = getMainCredits();
    return setMainCreditsAbs(base + Number(delta||0));
  }

  // --- Sync on load (prevents revert after refresh) ---
  function syncCreditsOnLoad(){
    // If userKeys() available => prefer user-scoped LS, else global
    const keys = getKeysSafe();
    let stored = null;
    if(keys && keys.LS_CREDITS){
      stored = parseInt(readLS(keys.LS_CREDITS, ''), 10);
    }
    if(stored==null || isNaN(stored)){
      stored = parseInt(readLS(GLOBAL_CREDITS_KEY, ''), 10);
    }
    if(stored!=null && !isNaN(stored)){
      setMainCreditsAbs(stored);
    }else{
      // Initialize from current state/DOM into LS to unify
      setMainCreditsAbs(getMainCredits());
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', syncCreditsOnLoad);
  } else {
    syncCreditsOnLoad();
  }

  // --- Wire unified rules for actions (capture phase to override older listeners) ---
  function loadResellers(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function saveResellers(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  // DELETE: return all credits to main, persist
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="del"]');
    if(!mi) return;
    e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();
    const rid = mi.dataset.rid||'';
    const list = loadResellers();
    const r = list.find(x=> x.id===rid);
    if(!r) return;
    if(confirm(`Supprimer ${r.name} ? Ses ${r.credits||0} crédits seront retournés au principal.`)){
      // return to main
      addToMainCredits(+ (r.credits||0));
      // remove
      const rest = list.filter(x=> x.id!==rid);
      saveResellers(rest);
      // refresh list + close floating menu
      try{ if(typeof renderResellers==='function') renderResellers(); }catch(_){}
      document.querySelectorAll('.reseller-floating-menu').forEach(m=>m.remove());
    }
  }, true);

  // EDIT SAVE: delta -> main
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnResellerSave');
    if(!btn) return;
    const title = (document.getElementById('resellerModalTitle')?.textContent||'').trim().toLowerCase();
    if(title !== 'edit reseller') return; // skip for Add Reseller
    e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();

    const r_name = document.getElementById('r_name');
    const r_cred = document.getElementById('r_credits');
    const msg = document.getElementById('r_msg');
    const rid = (document.getElementById('resellerModal')?.dataset.rid || window.__currentEditRid || '');

    const name = (r_name && r_name.value || '').trim();
    const credits = parseInt(r_cred && r_cred.value || '0', 10);
    const buy = parseInt((document.getElementById('r_buy')?.value || '0'), 10) || 0;
    const sell = parseInt((document.getElementById('r_sell')?.value || '0'), 10) || 0;
    const profit = sell - buy;
    if(!name){ if(msg){ msg.textContent='Reseller name obligatoire.'; msg.style.color='var(--danger)'; } return; }
    if(isNaN(credits) || credits<0){ if(msg){ msg.textContent='Crédits invalides.'; msg.style.color='var(--danger)'; } return; }

    const list = loadResellers();
    const idx = list.findIndex(x=> x.id===rid);
    if(idx<0){ if(msg){ msg.textContent='Reseller introuvable.'; msg.style.color='var(--danger)'; } return; }

    const prev = list[idx].credits||0;
    const delta = credits - prev;

    // If increasing, ensure enough credits
    if(delta>0){
      const avail = getMainCredits();
      if(avail < delta){ if(msg){ msg.textContent='Crédits insuffisants pour +'+delta; msg.style.color='var(--danger)'; } return; }
    }

    list[idx].name = name;
    list[idx].credits = credits;
    saveResellers(list); (function(){ const pm=window.__priceMapLoad?__priceMapLoad():{}; if(name){ pm[name]={buy:sell?buy:buy, sell:sell, profit:profit}; if(window.__priceMapSave) __priceMapSave(pm);} })(); try{}catch(_){}

    // Apply delta to main (subtract when positive, add when negative)
    addToMainCredits(-delta);

    // Close modal + refresh list
    const modal = document.getElementById('resellerModal');
    if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    try{ if(typeof renderResellers==='function') renderResellers(); }catch(_){}
  }, true);

  // EXTEND SAVE: always subtract from main
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnExtendSave');
    if(!btn) return;
    e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();

    const creditsEl = document.getElementById('ext_credits');
    const msgEl = document.getElementById('ext_msg');
    const rid = (document.getElementById('extendResellerModal')?.dataset.rid || window.__currentExtendRid || '');

    const add = parseInt(creditsEl && creditsEl.value || '0', 10);
    if(isNaN(add) || add <= 0){ if(msgEl){ msgEl.textContent='Entrer un nombre > 0.'; msgEl.style.color='var(--danger)'; } return; }

    const avail = getMainCredits();
    if(avail < add){ if(msgEl){ msgEl.textContent='Crédits insuffisants. Restants: '+avail; msgEl.style.color='var(--danger)'; } return; }

    const list = loadResellers();
    const idx = list.findIndex(x=> x.id===rid);
    if(idx<0){ if(msgEl){ msgEl.textContent='Reseller introuvable.'; msgEl.style.color='var(--danger)'; } return; }

    list[idx].credits = (list[idx].credits||0) + add;
    saveResellers(list); (function(){ const pm=window.__priceMapLoad?__priceMapLoad():{}; if(name){ pm[name]={buy:sell?buy:buy, sell:sell, profit:profit}; if(window.__priceMapSave) __priceMapSave(pm);} })(); try{}catch(_){}

    // Deduct from main and persist
    addToMainCredits(-add);

    // Close modal + refresh list
    const modal = document.getElementById('extendResellerModal');
    if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    try{ if(typeof renderResellers==='function') renderResellers(); }catch(_){}
  }, true);

  // Ensure Edit / Extend modals set the proper RID on open
  document.addEventListener('click', function(e){
    const miE = e.target.closest('.menu-item[data-ract="edit"]');
    if(miE){
      const rid = miE.dataset.rid || '';
      window.__currentEditRid = rid;
      const m = document.getElementById('resellerModal'); if(m){ m.dataset.rid = rid; }
    }
    const miX = e.target.closest('.menu-item[data-ract="extend"]');
    if(miX){
      const rid = miX.dataset.rid || '';
      window.__currentExtendRid = rid;
      const m2 = document.getElementById('extendResellerModal'); if(m2){ m2.dataset.rid = rid; }
    }
  }, true);

})();
  </script>
<script id="add-reseller-persist-fix">
   (function(){
  if(window.__addResellerPersistFixLoaded) return;
  window.__addResellerPersistFixLoaded = true;

  // Reuse helpers from the credits-consistency-fix if present; otherwise define minimal ones
  function readLS(key, def){ try{ const v = localStorage.getItem(key); return (v==null?def:v); }catch(_){ return def; } }
  function writeLS(key, val){ try{ localStorage.setItem(key, String(val)); }catch(_){ } }
  function getKeysSafe(){ try{ return (typeof userKeys==='function') ? userKeys() : null; }catch(_){ return null; } }
  const GLOBAL_CREDITS_KEY = 'iptv_credits_v4_global';

  function getMainCredits(){
    try{ if(typeof state!=='undefined' && typeof state.credits==='number') return state.credits; }catch(_){}
    const keys = getKeysSafe();
    if(keys && keys.LS_CREDITS){
      const v = parseInt(readLS(keys.LS_CREDITS, '500'), 10);
      return isNaN(v) ? 0 : v;
    }
    const g = parseInt(readLS(GLOBAL_CREDITS_KEY, '500'), 10);
    return isNaN(g) ? 0 : g;
  }
  function setMainCreditsAbs(v){
    v = Math.max(0, parseInt(v||'0',10));
    try{ if(typeof state!=='undefined') state.credits = v; }catch(_){}
    const keys = getKeysSafe();
    if(keys && keys.LS_CREDITS) writeLS(keys.LS_CREDITS, v);
    writeLS(GLOBAL_CREDITS_KEY, v);
    try{ if(typeof saveUserData==='function') saveUserData(); }catch(_){}
    try{ if(typeof updateTotals==='function') updateTotals(); }catch(_){}
    const el = document.getElementById('creditsLeft'); if(el) el.textContent = String(v);
    return v;
  }
  function addToMainCredits(delta){ return setMainCreditsAbs(getMainCredits() + Number(delta||0)); }

  // Capture-phase handler for "Add Reseller" save
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnResellerSave');
    if(!btn) return;

    const title = (document.getElementById('resellerModalTitle')?.textContent||'').trim().toLowerCase();
    if(title !== 'add reseller') return; // only for Add flow

    e.preventDefault(); e.stopPropagation(); if(e.stopImmediatePropagation) e.stopImmediatePropagation();

    const nameEl = document.getElementById('r_name');
    const credEl = document.getElementById('r_credits');
    const msgEl  = document.getElementById('r_msg');
    const listModal = document.getElementById('resellerModal');

    const name = (nameEl && nameEl.value || '').trim();
    const credits = parseInt(credEl && credEl.value || '0', 10);

    if(!name){ if(msgEl){ msgEl.textContent='Reseller name obligatoire.'; msgEl.style.color='var(--danger)'; } return; }
    if(isNaN(credits) || credits<0){ if(msgEl){ msgEl.textContent='Crédits invalides.'; msgEl.style.color='var(--danger)'; } return; }

    // Check main balance and deduct persistently
    const avail = getMainCredits();
    if(avail < credits){ if(msgEl){ msgEl.textContent='Crédits insuffisants. Restants: '+avail; msgEl.style.color='var(--danger)'; } return; }

    // Save reseller in store
    let list;
    try{ list = JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch(_){ list = []; }
    const dateVal = (document.getElementById('r_date') ? document.getElementById('r_date').value : '');
    const item = { id: crypto.randomUUID(), name, credits, status: 'non_paye', date: dateVal };
    list.unshift(item);
    localStorage.setItem('iptv_resellers_v1', JSON.stringify(list));

    // Deduct main credits and persist
    addToMainCredits(-credits);

    // close modal & re-render list if opened later
    if(listModal){ listModal.style.display='none'; listModal.setAttribute('aria-hidden','true'); }
    try{ if(typeof renderResellers==='function') renderResellers(); }catch(_){}
  }, true);
})();
  </script>
<script id="reseller-delete-window-capture-fix">
   (function(){
  if(window.__resellerDeleteWindowCaptureFixLoaded) return;
  window.__resellerDeleteWindowCaptureFixLoaded = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  // Same addToMainCredits used before; if absent, define minimal version
  function getKeysSafe(){ try{ return (typeof userKeys==='function') ? userKeys() : null; }catch(_){ return null; } }
  function readLS(key, def){ try{ const v = localStorage.getItem(key); return (v==null?def:v); }catch(_){ return def; } }
  const GLOBAL_CREDITS_KEY = 'iptv_credits_v4_global';
  function getMainCredits(){
    try{ if(typeof state!=='undefined' && typeof state.credits==='number') return state.credits; }catch(_){}
    const keys = getKeysSafe();
    if(keys && keys.LS_CREDITS){
      const v = parseInt(readLS(keys.LS_CREDITS, '500'), 10); return isNaN(v)?0:v;
    }
    const g = parseInt(readLS(GLOBAL_CREDITS_KEY, '500'), 10); return isNaN(g)?0:g;
  }
  function setMainCreditsAbs(v){
    v = Math.max(0, parseInt(v||'0',10));
    try{ if(typeof state!=='undefined') state.credits = v; }catch(_){}
    const keys = getKeysSafe();
    if(keys && keys.LS_CREDITS){ localStorage.setItem(keys.LS_CREDITS, String(v)); }
    localStorage.setItem(GLOBAL_CREDITS_KEY, String(v));
    const el = document.getElementById('creditsLeft'); if(el) el.textContent = String(v);
    try{ if(typeof saveUserData==='function') saveUserData(); }catch(_){}
    try{ if(typeof updateTotals==='function') updateTotals(); }catch(_){}
    return v;
  }
  function addToMainCredits(delta){ return setMainCreditsAbs(getMainCredits() + Number(delta||0)); }

  window.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="del"]');
    if(!mi) return;

    // Prevent other handlers; we'll perform full delete with immediate UI
    e.preventDefault();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();
    e.stopPropagation();

    const rid = mi.dataset.rid || '';
    const tr = mi.closest('tr');
    const tbody = tr && tr.parentElement;
    const list = load();
    const r = list.find(x=> x.id===rid);
    if(!r) return;

    if(confirm(`Supprimer ${r.name} ? Ses ${r.credits||0} crédits seront retournés au principal.`)){
      // 1) return credits to main
      addToMainCredits(+ (r.credits||0));
      // 2) remove from storage
      const rest = list.filter(x=> x.id!==rid);
      save(rest);
      // 3) immediate DOM removal
      if(tr && tbody){
        tr.remove();
        // Update count if present
        const countEl = document.getElementById('resellerCount');
        if(countEl){
          const current = parseInt(countEl.textContent || '0', 10) || 0;
          countEl.textContent = String(Math.max(0, current - 1));
        }
        // If table empty, show "Aucun reseller."
        if(!tbody.querySelector('tr')){
          const trEmpty = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4; td.textContent = 'Aucun reseller.'; td.style.color='#cbd5e1'; td.style.padding='16px';
          trEmpty.appendChild(td); tbody.appendChild(trEmpty);
        }
      } else {
        // fallback re-render
        try{ if(typeof renderResellers==='function') renderResellers(); }catch(_){}
      }
      // 4) close any floating menu
      document.querySelectorAll('.reseller-floating-menu').forEach(m=>m.remove());
    }
  }, true);
})();
  </script>
<script id="reseller-delete-row-finder-fix">
   (function(){
  if(window.__resellerDeleteRowFinderFixLoaded) return;
  window.__resellerDeleteRowFinderFixLoaded = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  // Helper to find the row for a given rid reliably
  function findRowByRid(rid){
    const tbody = document.getElementById('resellersTbody');
    if(!tbody) return null;
    const btn = tbody.querySelector('[data-rid="'+rid+'"]');
    return btn ? btn.closest('tr') : null;
  }

  // Override existing window-level delete if present by capturing and replacing behavior
  window.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="del"]');
    if(!mi) return;

    e.preventDefault();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();
    e.stopPropagation();

    const rid = mi.dataset.rid || '';
    const listRaw = localStorage.getItem('iptv_resellers_v1') || '[]';
    let list; try{ list = JSON.parse(listRaw); }catch(_){ list = []; }
    const r = list.find(x=> x.id===rid);
    if(!r) return;

    if(confirm(`Supprimer ${r.name} ? Ses ${r.credits||0} crédits seront retournés au principal.`)){
      // Return credits
      try{
        const evt = new CustomEvent('reseller:returnCredits',{detail:{amount:(r.credits||0)}});
        window.dispatchEvent(evt);
      }catch(_){}
      // Fallback: directly adjust if event not handled
      try{
        if(typeof addToMainCredits === 'function'){ addToMainCredits(+ (r.credits||0)); }
      }catch(_){}

      // Remove from storage
      const rest = list.filter(x=> x.id!==rid);
      localStorage.setItem('iptv_resellers_v1', JSON.stringify(rest));

      // Remove row from DOM by rid
      const tr = findRowByRid(rid);
      const tbody = document.getElementById('resellersTbody');
      if(tr && tbody){
        tr.remove();
        const countEl = document.getElementById('resellerCount');
        if(countEl){
          const current = parseInt(countEl.textContent || '0', 10) || 0;
          countEl.textContent = String(Math.max(0, current - 1));
        }
        if(!tbody.querySelector('tr')){
          const trEmpty = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4; td.textContent = 'Aucun reseller.'; td.style.color='#cbd5e1'; td.style.padding='16px';
          trEmpty.appendChild(td); tbody.appendChild(trEmpty);
        }
      } else {
        // As a backup, re-render the list if function exists
        try{ if(typeof renderResellers === 'function') renderResellers(); }catch(_){}
      }
      // Close floating menu
      document.querySelectorAll('.reseller-floating-menu').forEach(m=>m.remove());
    }
  }, true);
})();
  </script>
<script id="reseller-force-render">
   (function(){
  if(window.__resellerForceRenderLoaded) return;
  window.__resellerForceRenderLoaded = true;

  window.forceRenderResellers = function(){
    const tbody = document.getElementById('resellersTbody');
    const countEl = document.getElementById('resellerCount');
    if(!tbody) return;
    // Load from storage
    let list; try{ list = JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch(_){ list = []; }
    tbody.innerHTML = '';
    if(countEl) countEl.textContent = String(list.length);
    if(list.length===0){
      const trEmpty = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4; td.textContent = 'Aucun reseller.'; td.style.color='#cbd5e1'; td.style.padding='16px';
      trEmpty.appendChild(td); tbody.appendChild(trEmpty);
      return;
    }
    list.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = [
        '<td style="padding:8px">', r.idx, '</td>',
        '<td style="padding:8px"><strong>', escapeHtml(r.name), '</strong></td>',
        '<td style="padding:8px">', r.credits, '</td>',
        '<td style="padding:8px">', (r.date || '-'), '</td>',
        '<td style="padding:8px">',
          (r.status==='paid' ? '<span class="pill pill-green">Payé</span>' : '<span class="pill pill-grey">Non payé</span>'),
        '</td>',
        '<td style="padding:8px">',
          '<button class="btn-outline actions-btn" data-rid="', r.id, '">⚙️ Actions</button>',
        '</td>'
      ].join('');
      tbody.appendChild(tr);
    });
  };

  // Re-render when list modal opens
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnResellerListToggle');
    if(btn){ setTimeout(()=>{ try{ window.forceRenderResellers(); }catch(_){ } }, 0); }
  }, true);
})();
  </script>
<script id="reseller-delete-pointerdown-final">
   (function(){
  if(window.__resellerDeletePointerdownFinalLoaded) return;
  window.__resellerDeletePointerdownFinalLoaded = true;

  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }
  function getKeysSafe(){ try{ return (typeof userKeys==='function') ? userKeys() : null; }catch(_){ return null; } }
  function readLS(key, def){ try{ const v = localStorage.getItem(key); return (v==null?def:v); }catch(_){ return def; } }
  const GLOBAL_CREDITS_KEY = 'iptv_credits_v4_global';
  function getMainCredits(){
    try{ if(typeof state!=='undefined' && typeof state.credits==='number') return state.credits; }catch(_){}
    const keys = getKeysSafe();
    if(keys && keys.LS_CREDITS){
      const v = parseInt(readLS(keys.LS_CREDITS, '500'), 10); return isNaN(v)?0:v;
    }
    const g = parseInt(readLS(GLOBAL_CREDITS_KEY, '500'), 10); return isNaN(g)?0:g;
  }
  function setMainCreditsAbs(v){
    v = Math.max(0, parseInt(v||'0',10));
    try{ if(typeof state!=='undefined') state.credits = v; }catch(_){}
    const keys = getKeysSafe();
    if(keys && keys.LS_CREDITS){ localStorage.setItem(keys.LS_CREDITS, String(v)); }
    localStorage.setItem(GLOBAL_CREDITS_KEY, String(v));
    const el = document.getElementById('creditsLeft'); if(el) el.textContent = String(v);
    try{ if(typeof saveUserData==='function') saveUserData(); }catch(_){}
    try{ if(typeof updateTotals==='function') updateTotals(); }catch(_){}
    return v;
  }

  function rebuildList(){
    const modal = document.getElementById('resellerListModal');
    const tbody = modal ? modal.querySelector('#resellersTbody') : document.getElementById('resellersTbody');
    const countEl = document.getElementById('resellerCount');
    if(!tbody) return;
    const list = load();
    tbody.innerHTML = '';
    if(countEl) countEl.textContent = String(list.length);
    if(list.length===0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4; td.textContent = 'Aucun reseller.'; td.style.color='#cbd5e1'; td.style.padding='16px';
      tr.appendChild(td); tbody.appendChild(tr);
      return;
    }
    list.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = '<td style="padding:8px">'+(i+1)+'</td>' +
                     '<td style="padding:8px"><strong>'+ String(r.name||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])) +'</strong></td>'+
                     '<td style="padding:8px">'+r.credits+'</td>'+
                     '<td style="padding:8px"><button class="btn-outline actions-btn" data-rid="'+r.id+'">⚙️ Actions</button></td>';
      tbody.appendChild(tr);
    });
  }

  // Preempt with pointerdown capture
  window.addEventListener('pointerdown', function(e){
    const mi = e.target.closest('.menu-item[data-ract="del"]');
    if(!mi) return;
    e.preventDefault();
    if(e.stopImmediatePropagation) e.stopImmediatePropagation();
    e.stopPropagation();

    const rid = mi.dataset.rid || '';
    const list = load();
    const r = list.find(x=> x.id===rid);
    if(!r) return;

    // Do confirm here (pointerdown is fine)
    const ok = confirm(`Supprimer ${r.name} ? Ses ${r.credits||0} crédits seront retournés au principal.`);
    if(!ok) return;

    // Return credits
    const newMain = Math.max(0, getMainCredits() + (r.credits||0));
    setMainCreditsAbs(newMain);

    // Remove reseller
    const rest = list.filter(x=> x.id!==rid);
    save(rest);

    // Close any floating menu
    document.querySelectorAll('.reseller-floating-menu').forEach(m=>m.remove());

    // Rebuild list immediately
    if(window.forceRenderResellersWithStatus){ window.forceRenderResellersWithStatus(); } else { rebuildList(); }
  }, true);
})();
  </script>
<!-- Reseller Status Column + Paid/Unpaid Actions (injected) -->
<style id="reseller-status-tags">
   .tag.green{ background:#064e3b; color:#34d399; font-weight:700; }
  .tag.red{ background:#7f1d1d; color:#f87171; font-weight:700; }
  </style>
<script id="reseller-status-logic">
   (function(){
  if(window.__resellerStatusLogicLoadedSafe2) return;
  window.__resellerStatusLogicLoadedSafe2 = true;

  function $(s, r){ return (r||document).querySelector(s); }
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  function getModalParts(){
    const modal = document.getElementById('resellerListModal');
    if(!modal) return {};
    const thead = modal.querySelector('thead');
    const tbody = modal.querySelector('#resellersTbody');
    const countEl = modal.querySelector('#resellerCount') || document.getElementById('resellerCount');
    return { modal, thead, tbody, countEl };
  }

  function ensureHeaderWithDate(){
    const { thead } = getModalParts();
    if(!thead) return;
    const tr = thead.querySelector('tr'); if(!tr) return;
    const ths = Array.from(tr.querySelectorAll('th'));
    const hasStatut = ths.some(th => /statut/i.test(th.textContent||''));
    const hasDate = ths.some(th => /^date$/i.test((th.textContent||'').trim()));
    if(!hasDate){
      const thDate = document.createElement('th');
      thDate.textContent = 'Date';
      const thStatut = ths.find(th => /statut/i.test(th.textContent||''));
      const thActions = ths[ths.length-1];
      tr.insertBefore(thDate, thStatut || thActions);
    }
    if(!hasStatut){
      const thActions2 = tr.querySelector('th:last-child');
      const thStatutNew = document.createElement('th');
      thStatutNew.textContent = 'Statut';
      tr.insertBefore(thStatutNew, thActions2);
    }
  }

  function fmtDate(val){
    if(!val) return '';
    if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
    const d = new Date(val);
    if(isNaN(d.getTime())) return '';
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function forceRenderResellersWithStatus(){
    const { tbody, countEl } = getModalParts();
    if(!tbody) return;
    ensureHeaderWithDate();
    const list = load();
    tbody.innerHTML = '';
    if(countEl) countEl.textContent = String(list.length);
    if(list.length===0){
      const trEmpty = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6; td.textContent = 'Aucun reseller.'; td.style.color='#cbd5e1'; td.style.padding='16px';
      trEmpty.appendChild(td); tbody.appendChild(trEmpty);
      return;
    }
    list.forEach((r,i)=>{
      const status = (r.status === 'paye') ? 'paye' : 'non_paye';
      const statusHtml = status==='paye'
        ? '<span class="tag green">Payé</span>'
        : '<span class="tag red">Non payé</span>';
      const safeName = String(r.name||'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]));
      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td style="padding:8px">'+(i+1)+'</td>'+
        '<td style="padding:8px"><strong>'+ safeName +'</strong></td>'+
        '<td style="padding:8px">'+ (r.credits||0) +'</td>'+
        '<td style="padding:8px" class="date-cell" data-rid="'+r.id+'">'+ fmtDate(r.date||'') +'</td>'+
        '<td style="padding:8px" class="status-cell" data-rid="'+r.id+'">'+ statusHtml +'</td>'+
        '<td style="padding:8px"><button class="btn-outline actions-btn" data-rid="'+r.id+'">⚙️ Actions</button></td>';
      tbody.appendChild(tr);
    });
  }
  window.forceRenderResellersWithStatus = forceRenderResellersWithStatus;

  document.addEventListener('click', function(e){
    const openBtn = e.target.closest('#btnResellerListToggle');
    if(!openBtn) return;
    setTimeout(()=>{ try{ forceRenderResellersWithStatus(); }catch(_){} }, 0);
  }, true);

  document.addEventListener('click', function(e){
    const ab = e.target.closest('.actions-btn'); if(!ab) return;
    const rid = ab.dataset.rid;
    setTimeout(()=> {
      const menus = document.querySelectorAll('.reseller-floating-menu');
      const menu = menus[menus.length-1];
      if(menu && !menu.querySelector('[data-ract="markpaid"]')){
        const btnPaid = document.createElement('button');
        btnPaid.className = 'menu-item';
        btnPaid.dataset.ract = 'markpaid';
        btnPaid.dataset.rid = rid;
        btnPaid.textContent = 'Marké comme payé';

        const btnUnpaid = document.createElement('button');
        btnUnpaid.className = 'menu-item';
        btnUnpaid.dataset.ract = 'markunpaid';
        btnUnpaid.dataset.rid = rid;
        btnUnpaid.textContent = 'Marké comme non payé';

        const danger = menu.querySelector('.menu-item.danger');
        if(danger){
          menu.insertBefore(btnPaid, danger);
          menu.insertBefore(btnUnpaid, danger);
        } else {
          menu.appendChild(btnPaid);
          menu.appendChild(btnUnpaid);
        }
      }
    }, 0);
  }, true);

  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="markpaid"], .menu-item[data-ract="markunpaid"]');
    if(!mi) return;
    e.preventDefault(); e.stopPropagation();
    const rid = mi.dataset.rid;
    const list = load();
    const idx = list.findIndex(x=> x.id===rid);
    if(idx<0) return;
    list[idx].status = mi.dataset.ract === 'markpaid' ? 'paye' : 'non_paye';
    try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
    // Full re-render to keep indices & columns consistent
    try{ forceRenderResellersWithStatus(); }catch(_){}
  }, true);

  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnResellerSave'); if(!btn) return;
    const title = ($('#resellerModalTitle')?.textContent||'').trim().toLowerCase();
    if(title !== 'add reseller') return;
    setTimeout(()=>{
      const list = load();
      if(list && list.length){
        if(typeof list[0].status === 'undefined'){
          list[0].status = 'non_paye';
          try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
        }
      }
    }, 0);
  }, true);
})();
  </script>
<script id="reseller-mobile-menu">
   (function(){
  if(window.__resellerMobileMenuLoaded) return;
  window.__resellerMobileMenuLoaded = true;

  function $(s, r){ return (r||document).querySelector(s); }

  function ensureMobileItems(){
    const menu = $('#mobileMenu');
    if(!menu) return;
    // Avoid duplicates
    if(!$('#mobileAddReseller', menu)){
      const addBtn = document.createElement('button');
      addBtn.className = 'mobile-item';
      addBtn.id = 'mobileAddReseller';
      addBtn.textContent = 'Add Reseller';
      // Insert after "Add Client" if present, else append
      const after = $('#mobileAddClient', menu);
      if(after && after.nextSibling){
        menu.insertBefore(addBtn, after.nextSibling);
      } else if(after){
        menu.appendChild(addBtn);
      } else {
        menu.insertBefore(addBtn, menu.firstChild);
      }
    }
    if(!$('#mobileResellerList', menu)){
      const listBtn = document.createElement('button');
      listBtn.className = 'mobile-item';
      listBtn.id = 'mobileResellerList';
      listBtn.textContent = 'Reseller List';
      const tools = $('#mobileTools', menu);
      if(tools){
        menu.insertBefore(listBtn, tools);
      } else {
        menu.appendChild(listBtn);
      }
    }
  }

  // Initial try
  document.addEventListener('DOMContentLoaded', ensureMobileItems);
  // In case the menu is rendered later, observe body for the #mobileMenu
  const obs = new MutationObserver(()=>{
    if($('#mobileMenu')){
      ensureMobileItems();
    }
  });
  obs.observe(document.body, {childList:true, subtree:true});

  // Wiring: open respective modals
  document.addEventListener('click', function(e){
    const add = e.target.closest('#mobileAddReseller');
    if(add){
      // Open Add Reseller modal
      const btn = document.getElementById('btnAddResellerOpen');
      if(btn){ btn.click(); }
      return;
    }
    const list = e.target.closest('#mobileResellerList');
    if(list){
      // Open Reseller List modal and render with status
      const btn2 = document.getElementById('btnResellerListToggle');
      if(btn2){ btn2.click(); }
      // If our renderer is available, call it
      try{ if(typeof window.forceRenderResellersWithStatus === 'function') window.forceRenderResellersWithStatus(); }catch(_){}
      return;
    }
  }, true);
})();
  </script>
<script id="reseller-date-field">
   (function(){
  if(window.__resellerDateFieldLoaded) return;
  window.__resellerDateFieldLoaded = true;

  // Ensure the Date field exists in the Reseller modal
  function ensureDateField(){
    const modal = document.getElementById('resellerModal');
    if(!modal) return;
    // already there?
    if(modal.querySelector('#r_date')) return;

    // Find the .row that holds inputs
    const row = modal.querySelector('.row');
    if(!row) return;

    const field = document.createElement('div');
    field.className = 'field';
    field.innerHTML = [
      '<label>Date</label>',
      '<input class="input" id="r_date" type="date"/>'
    ].join('');
    row.appendChild(field);
  }

  // Helpers for storage
  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  // Wire: when opening Add Reseller, clear date field
  document.addEventListener('click', function(e){
    const openAdd = e.target.closest('#btnAddResellerOpen');
    if(!openAdd) return;
    setTimeout(()=>{
      ensureDateField();
      const dateEl = document.getElementById('r_date');
      if(dateEl) dateEl.value = '';
    }, 0);
  }, true);

  // Wire: when opening Edit (via menu), load date for that reseller
  document.addEventListener('click', function(e){
    const mi = e.target.closest('.menu-item[data-ract="edit"]');
    if(!mi) return;
    const rid = mi.dataset.rid || '';
    // Wait the edit modal to open
    setTimeout(()=>{
      ensureDateField();
      const dateEl = document.getElementById('r_date');
      if(!dateEl) return;
      const list = load();
      const r = list.find(x=> x.id===rid);
      if(r && r.date){
        // Normalize to yyyy-mm-dd if needed
        try{
          // If already yyyy-mm-dd, keep as is
          if(/^\d{4}-\d{2}-\d{2}$/.test(r.date)){
            dateEl.value = r.date;
          } else {
            const d = new Date(r.date);
            if(!isNaN(d.getTime())){
              const yyyy = d.getFullYear();
              const mm = String(d.getMonth()+1).padStart(2,'0');
              const dd = String(d.getDate()).padStart(2,'0');
              dateEl.value = `${yyyy}-${mm}-${dd}`;
            } else {
              dateEl.value = '';
            }
          }
        }catch(_){
          dateEl.value = '';
        }
      } else {
        dateEl.value = '';
      }
      // also store rid on modal for safety
      const modal = document.getElementById('resellerModal');
      if(modal){ modal.dataset.rid = rid; }
    }, 0);
  }, true);

  // Persist date on Save (Add + Edit)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnResellerSave');
    if(!btn) return;
    // Run after existing save handlers to avoid conflicts
    setTimeout(()=>{
      ensureDateField();
      const dateEl = document.getElementById('r_date');
      const dateVal = dateEl ? (dateEl.value || '') : '';
      const title = (document.getElementById('resellerModalTitle')?.textContent||'').trim().toLowerCase();
      const list = load();

      if(title === 'add reseller'){
        // We unshift new reseller at index 0 in previous logic
        if(list && list.length){
          // Find the most recent by lack of id timestamp; safest is index 0 as implemented
          list[0].date = dateVal;
          try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
        }
      } else if(title === 'edit reseller'){
        // Need rid to find correct reseller
        const modal = document.getElementById('resellerModal');
        const rid = (modal?.dataset.rid) || window.__currentEditRid || '';
        if(rid){
          const idx = list.findIndex(x=> x.id===rid);
          if(idx >= 0){
            list[idx].date = dateVal;
            try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
          }
        }
      }
    }, 0);
  }, true);

  // Ensure date field is present if modal is inserted after load
  document.addEventListener('DOMContentLoaded', ensureDateField);
  const obs = new MutationObserver(()=>{
    const m = document.getElementById('resellerModal');
    if(m) ensureDateField();
  });
  obs.observe(document.body, {childList:true, subtree:true});
})();
  </script>
<script id="reseller-date-save-fix">
   (function(){
  if(window.__resellerDateSaveFixLoaded) return;
  window.__resellerDateSaveFixLoaded = true;

  function load(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }

  function normalizeYMD(val){
    if(!val) return '';
    if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
    const d = new Date(val);
    if(isNaN(d.getTime())) return '';
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  // After SAVE click in the Reseller modal, persist date reliably and re-render list
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btnResellerSave'); if(!btn) return;

    const title = (document.getElementById('resellerModalTitle')?.textContent||'').trim().toLowerCase();
    const nameEl = document.getElementById('r_name');
    const creditsEl = document.getElementById('r_credits');
    const dateEl = document.getElementById('r_date');

    // Run shortly AFTER the main save logic executed
    setTimeout(function(){
      const list = load();
      const dateVal = normalizeYMD(dateEl ? dateEl.value : '');

      if(title === 'edit reseller'){
        const rid = (document.getElementById('resellerModal')?.dataset.rid || window.__currentEditRid || '');
        if(rid){
          const idx = list.findIndex(x=> x.id===rid);
          if(idx >= 0){
            list[idx].date = dateVal;
            try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
          }
        }
      } else if(title === 'add reseller'){
        const targetName = (nameEl && nameEl.value || '').trim();
        const targetCredits = parseInt(creditsEl && creditsEl.value || '0', 10);

        // Prefer an exact match on newly added item with missing/empty date
        let idx = list.findIndex(x => (x.name||'').trim() === targetName && Number(x.credits||0) === targetCredits);
        if(idx < 0){
          // Fallback: first item without date
          idx = list.findIndex(x => !x.date);
        }
        if(idx >= 0){
          list[idx].date = dateVal;
          try{ localStorage.setItem('iptv_resellers_v1', JSON.stringify(list||[])); }catch(_){}
        }
      }

      // Re-render the Reseller List if open so Date appears immediately
      try{
        if(typeof window.forceRenderResellersWithStatus === 'function'){
          window.forceRenderResellersWithStatus();
        }
      }catch(_){}
    }, 60);
  }, true);
})();
  </script>
<script>
   // === Reseller Gains: button in .stats + modal ===
(function(){
  function $(s, r){ return (r||document).querySelector(s); }
  function $all(s, r){ return Array.from((r||document).querySelectorAll(s)); }
  function loadRes(){ try{ return JSON.parse(localStorage.getItem('iptv_resellers_v1')||'[]'); }catch{ return []; } }

  // Add button to .stats bar
  document.addEventListener('DOMContentLoaded', function(){
    var stats = document.querySelector('.stats');
    if(stats && !document.getElementById('btnResellerGain')){
      var btn = document.createElement('button');
      btn.id = 'btnResellerGain';
      btn.className = 'btn-brown pill'; // keep chip look + brown color
      btn.textContent = '$ Resellers Price $';
      stats.appendChild(btn);
    }
  });

  // Create modal lazily
  function ensureModal(){
    var modal = document.getElementById('resellerGainModal');
    if(modal) return modal;
    modal = document.createElement('div');
    modal.id = 'resellerGainModal';
    modal.className = 'generic-modal';
    modal.setAttribute('aria-hidden','true');
    modal.innerHTML = '<div class="gm-content" style="max-width:760px;min-width:520px">\
      <div class="gm-header">\
        <h3 class="gm-title">Reseller Gains</h3>\
        <button class="gm-close" id="closeResellerGain">×</button>\
      </div>\
      <div style="overflow:auto;max-height:60vh;border-radius:12px;border:1px solid rgba(255,255,255,.08);margin-top:8px">\
        <table style="width:100%">\
          <thead>\
            <tr>\
              <th>#</th>\
              <th>Reseller</th>\
              <th>Date</th>\
              <th>Prix d\'achat</th>\
              <th>Prix de vente</th>\
              <th>Profit (DH)</th>\
            </tr>\
          </thead>\
          <tbody id="resellerGainTbody"></tbody>\
        </table>\
      </div>\
      <div class="actions" style="margin-top:12px;justify-content:flex-end">\
        <button class="btn-save" id="btnSaveGains">Save</button>\
      </div>\
      <div class="hint">Profit = Prix de vente − Prix d\'achat (par reseller).</div>\
    </div>';
    document.body.appendChild(modal);
    return modal;
  }

  function openModal(){
    var modal = ensureModal();
    renderList();
    modal.style.display='flex';
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    var modal = document.getElementById('resellerGainModal');
    if(!modal) return;
    modal.style.display='none';
    modal.setAttribute('aria-hidden','true');
  }

  function renderList(){
    var tbody = document.getElementById('resellerGainTbody');
    if(!tbody) return;
    var list = loadRes().map((r,i)=>{
      var buy = (r.buy!=null ? parseInt(r.buy,10) : 0) || 0;
      var sell = (r.sell!=null ? parseInt(r.sell,10) : 0) || 0;
      var profit = (r.profit!=null ? parseInt(r.profit,10) : (sell - buy)) || (sell - buy);
      try{ var pm = (window.__priceMapLoad && __priceMapLoad()) || {}; var k=(r.name||'').trim(); if(k && (!buy || !sell)){ if(pm[k]){ buy = pm[k].buy||buy; sell = pm[k].sell||sell; profit = (typeof pm[k].profit==='number')? pm[k].profit : (sell - buy); } } }catch(_){ }
      if(!profit && (sell||buy)) profit = sell - buy; var date = r.date || (r.createdAt||''); return { idx:i+1, name:r.name||'—', date, buy, sell, profit };
    });
    tbody.innerHTML = '';
    if(list.length===0){
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.colSpan = 5; td.textContent = 'Aucun reseller.'; td.style.color='#cbd5e1'; td.style.padding='16px';
      tr.appendChild(td); tbody.appendChild(tr); return;
    }
    for(const r of list){
      var tr = document.createElement('tr');
      tr.innerHTML = '<td style="padding:8px">'+r.idx+'</td>' +
                     '<td style="padding:8px"><strong>'+r.name.replace(/[&<>]/g,'')+'</strong></td>' + '<td style="padding:8px">'+(r.date||'—')+'</td>' + '<input type="hidden" class="rg-name" value="'+r.name.replace(/["'<>]/g,'')+'"/>' +
                     '<td style="padding:8px"><input class="input rg-buy" type="number" min="0" step="1" value="'+r.buy+'" style="max-width:120px"/> </td>' +
                     '<td style="padding:8px"><input class="input rg-sell" type="number" min="0" step="1" value="'+r.sell+'" style="max-width:120px"/> </td>' +
                     '<td style="padding:8px;font-weight:800" data-rprofit="1">'+r.profit+' DH</td>';
      tbody.appendChild(tr);
    }
  }

  document.addEventListener('click', function(e){
    if(e.target && e.target.id === 'btnResellerGain'){ openModal(); }
    if(e.target && e.target.id === 'closeResellerGain'){ closeModal(); }
  });
  window.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){ closeModal(); }
  });
})();
  </script>
<script>
   // === Reseller Price Map (robust persistence for buy/sell/profit) ===
(function(){
  const PRICE_KEY = 'iptv_reseller_prices_v1';
  window.__priceMapLoad = function(){ try{ return JSON.parse(localStorage.getItem(PRICE_KEY)||'{}'); }catch{ return {}; } };
  window.__priceMapSave = function(map){ try{ localStorage.setItem(PRICE_KEY, JSON.stringify(map||{})); }catch{} };
})();
  </script>
<script>
   /*RES-MONTH-REFRESH*/
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'btnSaveGains'){
    setTimeout(function(){
      try { if(typeof renderMonthlyPanel==='function') renderMonthlyPanel(); } catch(_){}
    }, 0);
  }
});
  </script>
<script>
   /*RES-SAVE-ENHANCED*/
(function(){
  document.addEventListener('click', function(e){
    if(!(e && e.target && e.target.id === 'btnSaveGains')) return;
    try {
      var tbody = document.getElementById('resellerGainTbody');
      if(!tbody) return;
      if(e.stopImmediatePropagation) e.stopImmediatePropagation();
      if(e.preventDefault) e.preventDefault();

      var rows = Array.from(tbody.querySelectorAll('tr'));
      var old = [];
      try { old = JSON.parse(localStorage.getItem('iptv_resellers_v1') || '[]') || []; } catch(_){ old = []; }
      function findByName(name){
        var nm = (name||'').trim();
        return old.find(function(x){ return ((x && (x.name||'').trim()) === nm); });
      }
      var next = [];
      rows.forEach(function(tr, i){
        var name = (tr.querySelector('.rg-name')?.value || '').trim();
        var buy  = parseInt(tr.querySelector('.rg-buy')?.value || '0', 10) || 0;
        var sell = parseInt(tr.querySelector('.rg-sell')?.value || '0', 10) || 0;
        var profit = sell - buy;
        if(!name) return;
        var existed = findByName(name) || {};
        var id = existed.id || (crypto && crypto.randomUUID ? crypto.randomUUID() : ('res_'+Date.now()+'_'+i));
        var credits = (typeof existed.credits === 'number') ? existed.credits : 0;
        var dateStr = existed.date || existed.createdAt || '';
        next.push({ id, name, credits, buy, sell, profit, date: dateStr });
      });
      localStorage.setItem('iptv_resellers_v1', JSON.stringify(next));
      // Refresh UI
      try { if(typeof renderList === 'function') renderList(); } catch(_){}
      try { if(typeof updateTotals === 'function') updateTotals(); /*RES-SAVE-REINSTATE-CALL*/ } catch(_){}
      try { if(typeof renderMonthlyPanel === 'function') renderMonthlyPanel(); } catch(_){}
    } catch(err) {
      console.error('btnSaveGains enhanced error', err);
    }
  }, true);
})();
  </script>
<script>
   /*RES-SAVE-REINSTATE*/
(function(){
  document.addEventListener('click', function(e){
    if(!(e && e.target && e.target.id === 'btnSaveGains')) return;
    try{
      var tbody = document.getElementById('resellerGainTbody');
      if(!tbody) return;
      if(e.stopImmediatePropagation) e.stopImmediatePropagation();
      if(e.preventDefault) e.preventDefault();

      // Read existing storage
      var old = [];
      try { old = JSON.parse(localStorage.getItem('iptv_resellers_v1') || '[]') || []; } catch(_){ old = []; }
      function findByName(name){
        var nm = (name||'').trim();
        return old.find(function(x){ return ((x && (x.name||'').trim()) === nm); });
      }

      // Collect rows
      var rows = Array.from(tbody.querySelectorAll('tr'));
      var next = [];
      rows.forEach(function(tr, i){
        // name from hidden input or from cell text
        var name = (tr.querySelector('.rg-name')?.value || '').trim();
        if(!name){
          var strong = tr.querySelector('td strong');
          if(strong) name = (strong.textContent||'').trim();
        }
        var buy  = parseInt(tr.querySelector('.rg-buy')?.value || '0', 10) || 0;
        var sell = parseInt(tr.querySelector('.rg-sell')?.value || '0', 10) || 0;
        var profit = sell - buy;
        if(!name) return;
        var existed = findByName(name) || {};
        var id = existed.id || (crypto && crypto.randomUUID ? crypto.randomUUID() : ('res_'+Date.now()+'_'+i));
        var credits = (typeof existed.credits === 'number') ? existed.credits : 0;
        // keep any existing date if present
        var dateStr = existed.date || existed.createdAt || (tr.querySelector('.rg-date')?.value || '');
        next.push({ id, name, credits, buy, sell, profit, date: dateStr });
      });

      // Persist
      localStorage.setItem('iptv_resellers_v1', JSON.stringify(next));

      // UI refresh
      try { if(typeof renderList === 'function') renderList(); } catch(_){}
      try { if(typeof updateTotals === 'function') updateTotals(); /*RES-SAVE-REINSTATE-CALL*/ } catch(_){}
      try { if(typeof renderMonthlyPanel === 'function') renderMonthlyPanel(); } catch(_){}
    }catch(err){
      console.error('RES-SAVE-REINSTATE error', err);
    }
  }, true);
})();
  </script>
<script>
   /*RES-LIVE-STATS*/
// (désactivé) Live compute pour rg-buy/rg-sell — supprimé
const gainEl = document.getElementById('gainTotal');
    if(gainEl){
      const totalVenteClients = state.clients.reduce((s,c)=> s + (c.sale ?? state.saleDefault), 0);
      gainEl.textContent = ((totalVenteClients - totalAchatClients) + resProfit) + ' DH';
    }
    const payEl = document.getElementById('totalToPay');
    if(payEl){
      payEl.textContent = (totalAchatClients + resBuy) + ' DH';
    }
  }catch(_){}
}, true);
  </script>
<script>
   /* BACKUP / RESTORE (GLOBAL) */
(function(){
  function getPerUserKeys(user){
    if(!user) return [];
    const pref = [
      'iptv_clients_v4',
      'iptv_credits_v4',
      'iptv_cost_v4',
      'iptv_price_v4',
      'iptv_sale_default_v4'
    ];
    return pref.map(p => `${p}__${user}`);
  }
  function collectAll(){
    const now = new Date().toISOString();
    const user = (window.state && state.user) || (localStorage.getItem('iptv_current_user_v1')||'').replace(/^"+|"+$/g,'');
    const perUser = getPerUserKeys(user);
    const keys = [
      'iptv_accounts_v1',
      'iptv_current_user_v1',
      'iptv_resellers_v1',
      'iptv_reseller_prices_v1',
      ...perUser
    ];
    const out = { meta:{ exportedAt: now, user }, data:{} };
    keys.forEach(k => { try{ out.data[k] = localStorage.getItem(k); }catch(_){ out.data[k]=null; } });
    return out;
  }
  function downloadJSON(obj, filename){
    const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
  function restoreFrom(obj){
    if(!obj || !obj.data) return false;
    Object.keys(obj.data).forEach(k => {
      const v = obj.data[k];
      if(v == null) return;
      try{ localStorage.setItem(k, v); }catch(_){}
    });
    // reload in-memory state & UI
    try{ if(typeof loadUserData==='function') loadUserData(); }catch(_){}
    try{ if(typeof updateTotals==='function') updateTotals(); }catch(_){}
    try{ if(typeof renderMonthlyPanel==='function') renderMonthlyPanel(); }catch(_){}
    try{ if(typeof renderResellers==='function') renderResellers(); }catch(_){}
    try{ if(typeof renderList==='function') renderList(); }catch(_){}
    return true;
  }

  // Wire buttons
  document.addEventListener('click', function(e){
    if(e.target && e.target.id==='btnBackup'){
      e.preventDefault?.();
      const payload = collectAll();
      downloadJSON(payload, `backup_iptv_${(payload.meta.user||'user')}_${new Date().toISOString().slice(0,10)}.json`);
    }
    if(e.target && e.target.id==='btnRestore'){
      e.preventDefault?.();
      const inp = document.getElementById('restoreFile'); if(inp) inp.click();
    }
  }, true);
  document.addEventListener('change', function(e){
    if(e.target && e.target.id==='restoreFile' && e.target.files && e.target.files[0]){
      const f = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(){
        try{
          const obj = JSON.parse(String(reader.result||'{}'));
          const ok = restoreFrom(obj);
          alert(ok ? 'Restore terminé ✅' : 'Restore non appliqué.');
        }catch(err){
          alert('Fichier invalide ❌');
        }
      };
      reader.readAsText(f);
      e.target.value = ''; // reset input
    }
  }, true);
})();
  </script>
<script>
   /* TOOLS: Backup/Restore wiring (Tools menu only) */
(function(){
  function getPerUserKeys(user){
    if(!user) return [];
    const pref = [
      'iptv_clients_v4',
      'iptv_credits_v4',
      'iptv_cost_v4',
      'iptv_price_v4',
      'iptv_sale_default_v4'
    ];
    return pref.map(p => `${p}__${user}`);
  }
  function collectAll(){
    const now = new Date().toISOString();
    const user = (window.state && state.user) || (localStorage.getItem('iptv_current_user_v1')||'').replace(/^"+|"+$/g,'');
    const perUser = getPerUserKeys(user);
    const keys = [
      'iptv_accounts_v1',
      'iptv_current_user_v1',
      'iptv_resellers_v1',
      'iptv_reseller_prices_v1',
      ...perUser
    ];
    const out = { meta:{ exportedAt: now, user }, data:{} };
    keys.forEach(k => { try{ out.data[k] = localStorage.getItem(k); }catch(_){ out.data[k]=null; } });
    return out;
  }
  function downloadJSON(obj, filename){
    const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
  function restoreFrom(obj){
    if(!obj || !obj.data) return false;
    Object.keys(obj.data).forEach(k => {
      const v = obj.data[k];
      if(v == null) return;
      try{ localStorage.setItem(k, v); }catch(_){}
    });
    try{ if(typeof loadUserData==='function') loadUserData(); }catch(_){}
    try{ if(typeof updateTotals==='function') updateTotals(); }catch(_){}
    try{ if(typeof renderMonthlyPanel==='function') renderMonthlyPanel(); }catch(_){}
    try{ if(typeof renderResellers==='function') renderResellers(); }catch(_){}
    try{ if(typeof renderList==='function') renderList(); }catch(_){}
    return true;
  }

  // Bind Tools buttons
  document.addEventListener('click', function(e){
    if(e.target && e.target.id==='btnBackup'){
      e.preventDefault?.();
      const payload = collectAll();
      downloadJSON(payload, `backup_iptv_${(payload.meta.user||'user')}_${new Date().toISOString().slice(0,10)}.json`);
    }
    if(e.target && e.target.id==='btnRestore'){
      e.preventDefault?.();
      document.getElementById('restoreFile')?.click();
    }
  }, true);

  document.addEventListener('change', function(e){
    if(e.target && e.target.id==='restoreFile' && e.target.files && e.target.files[0]){
      const f = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(){
        try{
          const obj = JSON.parse(String(reader.result||'{}'));
          const ok = restoreFrom(obj);
          alert(ok ? 'Restore terminé ✅' : 'Restore non appliqué.');
        }catch(err){
          alert('Fichier invalide ❌');
        }
      };
      reader.readAsText(f);
      e.target.value = '';
    }
  }, true);
})();
  </script>
<!-- MOBILE-TOOLS BAR -->
<script>
   /* MOBILE-TOOLS JS */
(function(){
  document.addEventListener('click', function(e){
    if(e.target && e.target.id === 'mBtnBackup'){
      e.preventDefault?.();
      const btn = document.getElementById('btnBackup');
      if(btn){ btn.click(); }
      else { console.warn('btnBackup not found'); }
    }
    if(e.target && e.target.id === 'mBtnRestore'){
      e.preventDefault?.();
      const btn = document.getElementById('btnRestore');
      if(btn){ btn.click(); }
      else { console.warn('btnRestore not found'); }
    }
  }, true);
})();
  </script>
<script>
   /* MOBILE-MENU BR */
(function(){
  document.addEventListener('click', function(e){
    if(e.target && e.target.id==='mobileBackup'){
      e.preventDefault?.();
      const btn=document.getElementById('btnBackup');
      if(btn) btn.click();
    }
    if(e.target && e.target.id==='mobileRestore'){
      e.preventDefault?.();
      const btn=document.getElementById('btnRestore');
      if(btn) btn.click();
    }
  }, true);
})();
  </script>
<script>
   /* RESET-INJECT: ensure resellers are cleared too */
(function(){
  document.addEventListener('click', function(e){
    if(!(e && e.target && (e.target.id==='btnReset' || e.target.id==='toolsReset'))) return;
    // If page already handles reset, just ensure resellers are removed too
    try{
      localStorage.removeItem('iptv_resellers_v1');
      localStorage.removeItem('iptv_reseller_prices_v1');
    }catch(_){}
    // Refresh UI to reflect empty reseller list
    try{ if(typeof renderResellers==='function') renderResellers(); }catch(_){}
    try{ if(typeof renderList==='function') renderList(); }catch(_){}
    try{ if(typeof updateTotals==='function') updateTotals(); }catch(_){}
    try{ if(typeof renderMonthlyPanel==='function') renderMonthlyPanel(); }catch(_){}
  }, true);
})();
  </script>
<!-- === MACS FEATURE (Header-integrated buttons / Add Mac / Mac List / Profit / Total à payer) === -->
<style>
   .btn-mauve{
    background: linear-gradient(135deg,#8b5cf6,#7c3aed);
    color:#fff; border:none; border-radius:12px; padding:8px 14px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 16px rgba(124,58,237,.35); transition:transform .2s ease, box-shadow .2s ease;
  }
  .btn-mauve:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(124,58,237,.5); }
  .btn-yellow{ background:#fde047; color:#111827; border:none; border-radius:12px; padding:8px 14px; font-weight:800; cursor:pointer; }
  .btn-yellow:hover{ filter:brightness(0.95); }
  .btn-outline{ background:transparent; color:#e2e8f0; border:1px solid rgba(226,232,240,.25); border-radius:12px; padding:6px 10px; font-weight:600; cursor:pointer; }
  .btn-outline:hover{ border-color:rgba(226,232,240,.45); }
  .btn-danger{ border-color:rgba(239,68,68,.45); color:#fecaca; }
  .btn-danger:hover{ border-color:rgba(239,68,68,.8); color:#fff; }
  .generic-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:100002; padding:20px; }
  .generic-modal .gm-content{ background:rgba(17,24,39,.98); color:#e5e7eb; margin:40px auto; border-radius:16px; padding:16px 16px 18px; border:1px solid rgba(255,255,255,.06); }
  .generic-modal .gm-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:4px 2px 10px; border-bottom:1px solid rgba(255,255,255,.06); }
  .generic-modal .gm-title{ margin:0; font-size:1.05rem; font-weight:800; }
  .generic-modal .gm-close{ background:transparent; color:#94a3b8; border:none; font-size:20px; line-height:1; cursor:pointer; }
  .generic-modal .gm-close:hover{ color:#e2e8f0; }
  .generic-modal .row{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px; }
  .generic-modal .field label{ display:block; font-size:.9rem; color:#cbd5e1; margin-bottom:6px; }
  .generic-modal .input, .generic-modal select{ width:100%; background:#0b1220; color:#e5e7eb; border:1px solid rgba(148,163,184,.3); border-radius:12px; padding:10px 12px; outline:none; }
  .generic-modal .input:focus, .generic-modal select:focus{ border-color:#8b5cf6; box-shadow:0 0 0 3px rgba(139,92,246,.25); }
  .generic-modal .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
  .generic-modal .hint{ color:#94a3b8; font-size:.9rem; margin-top:6px; }
  .simple-table{ width:100%; border-collapse:collapse; }
  .simple-table th, .simple-table td{ padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08); white-space:nowrap; text-align:left; }
  .toast-success{ background:#16a34a; color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; box-shadow:0 8px 24px rgba(22,163,74,.35); }
  .mac-total{ font-weight:900; }
  /* Responsive layout for header tools */
  .tools-wrap, .header-tools {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  @media (max-width: 768px) {
    .tools-wrap, .header-tools {
      width: 100%;
      justify-content: flex-start;
      gap: 6px;
    }
    .tools-wrap .btn-mauve, .header-tools .btn-mauve {
      width: auto;
    }
  }
  </style>
<!-- === MACS FEATURE (Header + MobileMenu buttons / Add Mac / Mac List / Profit / Total à payer) === -->
<style>
   .btn-mauve{
    background: linear-gradient(135deg,#8b5cf6,#7c3aed);
    color:#fff; border:none; border-radius:12px; padding:8px 14px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 16px rgba(124,58,237,.35); transition:transform .2s ease, box-shadow .2s ease;
  }
  .btn-mauve:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(124,58,237,.5); }
  .btn-yellow{ background:#fde047; color:#111827; border:none; border-radius:12px; padding:8px 14px; font-weight:800; cursor:pointer; }
  .btn-yellow:hover{ filter:brightness(0.95); }
  .btn-outline{ background:transparent; color:#e2e8f0; border:1px solid rgba(226,232,240,.25); border-radius:12px; padding:6px 10px; font-weight:600; cursor:pointer; }
  .btn-outline:hover{ border-color:rgba(226,232,240,.45); }
  .btn-danger{ border-color:rgba(239,68,68,.45); color:#fecaca; }
  .btn-danger:hover{ border-color:rgba(239,68,68,.8); color:#fff; }
  .generic-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:100002; padding:20px; }
  .generic-modal .gm-content{ background:rgba(17,24,39,.98); color:#e5e7eb; margin:40px auto; border-radius:16px; padding:16px 16px 18px; border:1px solid rgba(255,255,255,.06); }
  .generic-modal .gm-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:4px 2px 10px; border-bottom:1px solid rgba(255,255,255,.06); }
  .generic-modal .gm-title{ margin:0; font-size:1.05rem; font-weight:800; }
  .generic-modal .gm-close{ background:transparent; color:#94a3b8; border:none; font-size:20px; line-height:1; cursor:pointer; }
  .generic-modal .gm-close:hover{ color:#e2e8f0; }
  .generic-modal .row{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px; }
  .generic-modal .field label{ display:block; font-size:.9rem; color:#cbd5e1; margin-bottom:6px; }
  .generic-modal .input, .generic-modal select{ width:100%; background:#0b1220; color:#e5e7eb; border:1px solid rgba(148,163,184,.3); border-radius:12px; padding:10px 12px; outline:none; }
  .generic-modal .input:focus, .generic-modal select:focus{ border-color:#8b5cf6; box-shadow:0 0 0 3px rgba(139,92,246,.25); }
  .generic-modal .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
  .generic-modal .hint{ color:#94a3b8; font-size:.9rem; margin-top:6px; }
  .simple-table{ width:100%; border-collapse:collapse; }
  .simple-table th, .simple-table td{ padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08); white-space:nowrap; text-align:left; }
  .toast-success{ background:#16a34a; color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; box-shadow:0 8px 24px rgba(22,163,74,.35); }
  .mac-total{ font-weight:900; }

  /* Responsive layout for header tools */
  .tools-wrap, .header-tools {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  /* Mobile menu buttons stack nicely */
  #mobileMenu .btn-mauve { width: 100%; margin-top: 8px; }
  </style>
<script id="macs-feature">
   (function(){
  if(window.__macsFeatureLoaded) return; window.__macsFeatureLoaded = true;

  const LS_MACS = 'iptv_macs_v1';
  const $ = (q)=> document.querySelector(q);
  const dh = (n)=> { const v=Number(n||0); return isNaN(v)?0:v; };
  const fmt = (n)=> dh(n) + ' DH';

  function load(){ try{ return JSON.parse(localStorage.getItem(LS_MACS)||'[]'); }catch{ return []; } }
  function save(list){ localStorage.setItem(LS_MACS, JSON.stringify(list||[])); }

  function insertAfter(referenceNode, newNode){
    if(!referenceNode || !referenceNode.parentNode){ return; }
    if(referenceNode.nextSibling){
      referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
    }else{
      referenceNode.parentNode.appendChild(newNode);
    }
  }
  function findByText(root, textList){
    if(!root) return null;
    const nodes = root.querySelectorAll('a,button,div,li,span');
    const norm = s => String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
    const goals = textList.map(t => norm(t));
    for(const n of nodes){
      const t = norm(n.textContent);
      if(goals.some(g => t.includes(g))) return n;
    }
    return null;
  }

  function placeButtons(){
    const header =
      document.querySelector('.tools-wrap') ||
      document.querySelector('.header-tools') ||
      (document.querySelector('header') ? document.querySelector('header') : null);

    if(header){
      if(!document.getElementById('btnAddMacOpen')){
        const b1 = document.createElement('button');
        b1.id='btnAddMacOpen'; b1.className='btn-mauve'; b1.type='button'; b1.textContent='Add Mac';
        header.appendChild(b1);
      }
      if(!document.getElementById('btnMacListOpen')){
        const b2 = document.createElement('button');
        b2.id='btnMacListOpen'; b2.className='btn-mauve'; b2.type='button'; b2.textContent='Mac List';
        header.appendChild(b2);
      }
    }

    const mobileMenu = document.getElementById('mobileMenu');
    if(mobileMenu){
      let addBtn = document.getElementById('btnAddMacOpenMobile');
      if(!addBtn){
        addBtn = document.createElement('button');
        addBtn.id='btnAddMacOpenMobile'; addBtn.className='btn-mauve'; addBtn.type='button'; addBtn.textContent='Add Mac';
      }
      let listBtn = document.getElementById('btnMacListOpenMobile');
      if(!listBtn){
        listBtn = document.createElement('button');
        listBtn.id='btnMacListOpenMobile'; listBtn.className='btn-mauve'; listBtn.type='button'; listBtn.textContent='Mac List';
      }

      const addClientAnchor = findByText(mobileMenu, ['add client', 'ajouter client', 'add-client']);
      const resellerListAnchor = findByText(mobileMenu, ['reseller list', 'liste revendeurs', 'resellers']);

      if(addClientAnchor){
        insertAfter(addClientAnchor, addBtn);
      }else if(!addBtn.isConnected){
        mobileMenu.insertBefore(addBtn, mobileMenu.firstChild);
      }

      if(resellerListAnchor){
        insertAfter(resellerListAnchor, listBtn);
      }else if(!listBtn.isConnected){
        mobileMenu.appendChild(listBtn);
      }

      addBtn.style.width = '100%';
      listBtn.style.width = '100%';
      addBtn.style.marginTop = '8px';
      listBtn.style.marginTop = '8px';
    }
  }

  function ensureTotal(){
    let stats = document.querySelector('.stats');
    if(!stats){
      stats = document.createElement('div'); stats.className='stats'; stats.style.margin='16px 0';
      const target = document.querySelector('main') || document.body;
      target.insertBefore(stats, target.firstChild);
    }
    if(!$('#macsTotalPay')){
      const pill = document.createElement('div');
      pill.className='pill';
      pill.innerHTML = 'Total Mac à payer : <strong class="yellow mac-total" id="macsTotalPay">0 DH</strong>';
      stats.appendChild(pill);
    }
  }
  function refreshTotal(){
    const sum = load().reduce((a,m)=> a + dh(m.price), 0);
    const el = $('#macsTotalPay'); if(el) el.textContent = fmt(sum);
  }

  function buildAdd(){
    if($('#macAddModal')) return;
    const wrap = document.createElement('div');
    wrap.className='generic-modal'; wrap.id='macAddModal'; wrap.setAttribute('aria-hidden','true');
    wrap.innerHTML = [
      '<div class="gm-content" style="max-width:980px;min-width:320px">',
        '<div class="gm-header"><h3 class="gm-title">Add MAC</h3><button class="gm-close" id="closeMacAdd">×</button></div>',
        '<div class="row">',
          '<div class="field"><label>Mac</label><input class="input" id="mac_mac" placeholder="AA:BB:CC:DD:EE:FF"/></div>',
          '<div class="field"><label>Date</label><input class="input" id="mac_date" type="date"/></div>',
          '<div class="field"><label>Prix d\'achat (DH)</label><input class="input" id="mac_price" type="number" min="0" step="1" placeholder="120"/></div>',
          '<div class="field"><label>App-Type</label><select id="mac_app" class="input"><option value="">-- choisir --</option><option>ibo Player Pro</option><option>ibo Player</option><option>Hot Player</option><option>SmartOne</option><option>Smart-iptv</option></select></div>',
          '<div class="field"><label>Prix de vente (DH)</label><input class="input" id="mac_sale" type="number" min="0" step="1" placeholder="160"/></div>',
        '</div>',
        '<div class="actions"><button class="btn-outline" id="macAddCancel">Annuler</button><button class="btn-yellow" id="macAddSave">Save</button></div>',
      '</div>'
    ].join('');
    document.body.appendChild(wrap);
  }

  function buildList(){
    if($('#macListModal')) return;
    const wrap = document.createElement('div');
    wrap.className='generic-modal'; wrap.id='macListModal'; wrap.setAttribute('aria-hidden','true');
    wrap.innerHTML = [
      '<div class="gm-content" style="max-width:1120px;min-width:320px">',
        '<div class="gm-header"><h3 class="gm-title">Mac List</h3><button class="gm-close" id="closeMacList">×</button></div>',
        '<div class="table-wrap" style="margin-top:8px;max-height:60vh;overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.08)">',
          '<table class="simple-table">',
            '<thead><tr><th>#</th><th>Adresse MAC</th><th>Date</th><th>Prix d\'achat</th><th>Prix de vente</th><th>Profit</th><th>App-Type</th><th>Actions</th></tr></thead>',
            '<tbody id="macsTbody"></tbody>',
          '</table>',
        '</div>',
      '</div>'
    ].join('');
    document.body.appendChild(wrap);
  }

  function profit(m){ return dh(m.salePrice) - dh(m.price); }

  function render(){
    const tb = document.getElementById('macsTbody'); if(!tb) return;
    const list = load();
    tb.innerHTML='';
    if(list.length===0){
      const tr = document.createElement('tr'); const td = document.createElement('td');
      td.colSpan=8; td.textContent='Aucune adresse MAC.'; td.style.color='#cbd5e1'; td.style.padding='16px';
      tr.appendChild(td); tb.appendChild(tr); return;
    }
    list.forEach((m,i)=>{
      const tr = document.createElement('tr');
      const esc = s => String(s||'').replace(/[&<>"']/g, c => ({'&':"&amp;",'<':"&lt;",'>':"&gt;",'"':"&quot;"}[c]));
      tr.innerHTML = [
        '<td>', (i+1), '</td>',
        '<td><strong>', esc(m.mac), '</strong></td>',
        '<td>', esc(m.date||''), '</td>',
        '<td>', fmt(m.price), '</td>',
        '<td>', (m.salePrice!=null && m.salePrice!=="" ? fmt(m.salePrice) : '-'), '</td>',
        '<td>', isNaN(profit(m))? '-' : fmt(profit(m)), '</td>',
        '<td>', esc(m.appType||'-'), '</td>',
        '<td><div style="display:flex;gap:8px">',
          '<button class="btn-outline btn-edit" data-id="', esc(m.id), '">Modifier</button>',
          '<button class="btn-outline btn-danger btn-delete" data-id="', esc(m.id), '">Supprimer</button>',
        '</div></td>'
      ].join('');
      tb.appendChild(tr);
    });
  }

  function openModal(id){ const m=document.getElementById(id); if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); } }
  function closeModal(id){ const m=document.getElementById(id); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }

  document.addEventListener('click', function(e){
    if(e.target.closest('#btnAddMacOpen')){ buildAdd(); openModal('macAddModal'); }
    if(e.target.closest('#btnMacListOpen')){ buildList(); openModal('macListModal'); render(); }
    if(e.target.closest('#btnAddMacOpenMobile')){ buildAdd(); openModal('macAddModal'); }
    if(e.target.closest('#btnMacListOpenMobile')){ buildList(); openModal('macListModal'); render(); }

    if(e.target.closest('#closeMacAdd') || e.target.closest('#macAddCancel')){
      const saveBtn = document.getElementById('macAddSave'); if(saveBtn) delete saveBtn.dataset.editingId;
      closeModal('macAddModal');
    }
    if(e.target.closest('#closeMacList')) closeModal('macListModal');

    if(e.target.classList.contains('btn-delete')){
      const id = e.target.getAttribute('data-id');
      if(!id) return;
      if(!confirm('Supprimer cette entrée ?')) return;
      const list = load().filter(m => m.id !== id);
      save(list); render(); refreshTotal(); return;
    }

    if(e.target.classList.contains('btn-edit')){
      const id = e.target.getAttribute('data-id');
      const item = load().find(m => m.id === id);
      if(!item) return;
      buildAdd(); openModal('macAddModal');
      document.getElementById('mac_mac').value = item.mac || '';
      document.getElementById('mac_date').value = item.date || '';
      document.getElementById('mac_price').value = dh(item.price||0);
      document.getElementById('mac_app').value = item.appType || '';
      document.getElementById('mac_sale').value = (item.salePrice!=null? dh(item.salePrice): '');
      const saveBtn = document.getElementById('macAddSave'); if(saveBtn) saveBtn.dataset.editingId = id;
    }

    if(e.target.closest('#macAddSave')){
      const saveBtn = e.target.closest('#macAddSave');
      const editingId = saveBtn?.dataset?.editingId;
      const mac  = (document.getElementById('mac_mac')?.value||'').trim();
      const date = (document.getElementById('mac_date')?.value||'').trim();
      const price= dh((document.getElementById('mac_price')?.value||'').trim());
      const app  = (document.getElementById('mac_app')?.value||'').trim();
      const sale = dh((document.getElementById('mac_sale')?.value||'').trim());
      if(!mac){ alert('Veuillez entrer l\'adresse MAC.'); return; }
      if(!date){ alert('Choisissez une date.'); return; }
      let list = load();
      if(editingId){
        list = list.map(m => m.id===editingId ? {...m, mac, date, price, appType:app, salePrice:sale} : m);
        delete saveBtn.dataset.editingId;
      }else{
        const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
        list.push({ id, mac, date, price, appType:app, salePrice:sale });
      }
      save(list); refreshTotal(); render(); try{ if(typeof updateTotals==='function') updateTotals(); }catch(_){}
      try{ if(typeof renderMonthlyPanel==='function') renderMonthlyPanel(); }catch(_){}
      closeModal('macAddModal');
    }
  }, true);

  function init(){
    placeButtons();
    ensureTotal();
    refreshTotal();
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
  </script>
<script>
   (function(){
  let fmenu;

  function closeF(){
    if(fmenu && fmenu.parentNode){ fmenu.parentNode.removeChild(fmenu); }
    fmenu = null;
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('.actions-btn[data-rid]');
    const insideResellerModal = e.target.closest('#resellerListModal');
    if(!insideResellerModal) return;

    if(!btn){
      if(!e.target.closest('.reseller-floating-menu')) closeF();
      return;
    }

    e.preventDefault();
    const rid = btn.getAttribute('data-rid');
    closeF();
    fmenu = document.createElement('div');
    fmenu.className = 'reseller-floating-menu';
    fmenu.innerHTML = `
      <button class="menu-item" data-act="edit" data-id="${rid}">Modifier</button>
      <button class="menu-item" data-act="toggle" data-id="${rid}">
      <button class="menu-item" data-act="invoice" data-id="{{ID}}">🧾 Générer la facture</button>
      <!-- bouton ajouté -->
      <!-- keep following -->
      <button style="display:none" data-act="toggle_hidden" data-id="${rid}">Marquer Payé / Non Payé</button>
      <button class="menu-item danger" data-act="del" data-id="${rid}">Supprimer</button>
    `;
    document.body.appendChild(fmenu);

    const r = btn.getBoundingClientRect();
    const top = Math.min(window.innerHeight - 10, r.bottom + 6);
    const left = Math.max(10, r.right - fmenu.offsetWidth);
    fmenu.style.top = top + 'px';
    fmenu.style.left = left + 'px';
  }, true);

  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeF(); });
  window.addEventListener('scroll', closeF, true);
  window.addEventListener('resize', closeF);
})();
  </script>
<!-- === BEGIN: Payments & History (robust) === -->
<style>
   /* === Minimal styles for new controls === */
.btn-yellow{
  background:#f59e0b; color:#0b1020; font-weight:800; border:none;
  padding:8px 12px; border-radius:10px; cursor:pointer;
}
.btn-yellow:hover{ filter:brightness(1.05); }
.btn-outline{
  background:transparent; color:#e2e8f0; border:1px solid rgba(226,232,240,.3);
  padding:8px 12px; border-radius:10px; cursor:pointer;
}
.btn-outline:hover{ background:rgba(226,232,240,.08); }
.btn-danger{
  background:#ef4444; color:#fff; border:none; padding:8px 12px; border-radius:10px; cursor:pointer;
}
.btn-danger:hover{ filter:brightness(1.05); }
  </style>
<script>
   (function(){
  if(window.__paymentsHistoryInjected__) return;
  window.__paymentsHistoryInjected__ = true;

  // ==== Payments & History (server + mac) ====
  const LOCALE = navigator.language || 'fr-FR';

  // per-user storage keys
  function payKeys(){
    try{
      if(!window.state || !state.user) return {LS:'iptv_payments_v1__default'};
      return { LS: `iptv_payments_v1__${state.user}` };
    }catch(_){ return {LS:'iptv_payments_v1__default'}; }
  }
  function getPayments(){
    try{
      const k = payKeys().LS; if(!k) return [];
      return JSON.parse(localStorage.getItem(k) || '[]') || [];
    }catch(_){ return []; }
  }
  function savePayments(list){
    const k = payKeys().LS; if(!k) return;
    localStorage.setItem(k, JSON.stringify(list||[]));
  }
  function addPayment(kind, amount){
    const list = getPayments();
    list.push({ kind, amount: Number(amount)||0, date: new Date().toISOString() });
    savePayments(list);
  }
  function sum(arr, fn){ let s=0; for(const x of arr) s += fn(x)||0; return s; }
  function paidTotal(kind){ return sum(getPayments().filter(p=>p.kind===kind), p=>p.amount); }

  // compute raw totals from data (fallbacks to what's shown initially)
  function computeRawServerToPay(){
    try{
      if(typeof totals==='function'){ const t=totals(); if(t&&typeof t.totalAchat!=='undefined') return (t.totalAchat||0); }
    }catch(_){}
    const t = document.getElementById('totalToPay')?.textContent || '0';
    const v = parseInt(t.replace(/[^\d-]/g,''),10)||0;
    return v + paidTotal('server');
  }
  function computeRawMacsToPay(){
    try{
      const macs = JSON.parse(localStorage.getItem('iptv_macs_v1')||'[]')||[];
      return macs.reduce((s,m)=> s + (parseInt(m.price||0,10)||0), 0);
    }catch(_){}
    const t = document.getElementById('macsTotalPay')?.textContent || '0';
    const v = parseInt(t.replace(/[^\d-]/g,''),10)||0;
    return v + paidTotal('mac');
  }

  function adjustForPayments(){
    const rawServer = computeRawServerToPay();
    const rawMacs   = computeRawMacsToPay();
    const netServer = Math.max(0, rawServer - paidTotal('server'));
    const netMacs   = Math.max(0, rawMacs   - paidTotal('mac'));
    const elServer = document.getElementById('totalToPay');
    const elMacs   = document.getElementById('macsTotalPay');
    if(elServer) elServer.textContent = `${netServer} DH`;
    if(elMacs)   elMacs.textContent   = `${netMacs} DH`;
  }

  // wrap updateTotals so offsets are always applied (if updateTotals exists)
  (function wrapUpdateTotals(){
    const orig = window.updateTotals;
    window.updateTotals = function(){
      try{ orig && orig(); }catch(_){}
      try{ adjustForPayments(); }catch(_){}
    };
  })();

  function makeBtn(txt,id,cls){
    const b = document.createElement('button');
    b.textContent = txt; b.id = id;
    b.className = cls||'btn-yellow';
    b.style.marginLeft = '8px';
    return b;
  }

  function injectPayButtons(){
    const serverPill = document.getElementById('totalToPay')?.closest('.pill');
    const macsPill   = document.getElementById('macsTotalPay')?.closest('.pill');
    if(serverPill && !document.getElementById('btnPayServer')){
      serverPill.appendChild(makeBtn('Payer','btnPayServer'));
    }
    if(macsPill && !document.getElementById('btnPayMac')){
      macsPill.appendChild(makeBtn('Payer','btnPayMac'));
    }
  }

  function placeHistoryButton(){
    if(document.getElementById('btnHistory')) return;
    const candidates = [
      ...document.querySelectorAll('.tools-wrap'),
      document.querySelector('header .tools-wrap'),
      document.querySelector('header .nav'),
      document.querySelector('header'),
      document.body
    ].filter(Boolean);
    const host = candidates.find(el => el && el.appendChild);
    if(!host) return;
    const b = makeBtn('History','btnHistory','btn-outline');
    b.style.fontWeight = '800';
    b.style.borderRadius = '12px';
    b.style.padding = '10px 14px';
    b.style.marginLeft = '8px';
    host.appendChild(b);
  }

  function ensureHistoryModal(){
    if(document.getElementById('historyModal')) return;
    const wrap = document.createElement('div');
    wrap.id = 'historyModal';
    wrap.style.position = 'fixed';
    wrap.style.inset = '0';
    wrap.style.display = 'none';
    wrap.style.alignItems = 'center';
    wrap.style.justifyContent = 'center';
    wrap.style.background = 'rgba(0,0,0,.6)';
    wrap.style.zIndex = '7000';
    wrap.innerHTML = `
      <div style="width:min(720px,95vw);max-height:80vh;overflow:auto;background:rgba(15,23,42,.96);
                  border:1px solid rgba(255,255,255,.14);border-radius:16px;padding:16px;
                  box-shadow:0 24px 80px rgba(0,0,0,.55);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <h3 style="margin:0;color:#22d3a3;font-weight:900">Historique des paiements</h3>
          <div style="display:flex;gap:8px">
            <button id="btnHistoryExport" class="btn-outline">Exporter</button>
            <button id="btnHistoryClear"  class="btn-danger">Vider</button>
            <button id="btnHistoryClose"  class="btn-outline">×</button>
          </div>
        </div>
        <div style="overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.08)">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;border-bottom:1px dashed rgba(255,255,255,.18)">Date</th>
                <th style="text-align:left;padding:8px;border-bottom:1px dashed rgba(255,255,255,.18)">Type</th>
                <th style="text-align:left;padding:8px;border-bottom:1px dashed rgba(255,255,255,.18)">Montant</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
        </div>
        <div class="hint" style="margin-top:8px"></div>
      </div>`;
    document.body.appendChild(wrap);
    wrap.addEventListener('click', (ev)=>{ if(ev.target===wrap) hideHistory(); });
    window.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') hideHistory(); });
  }

  function renderHistoryTable(){
    const tb = document.getElementById('historyTbody'); if(!tb) return;
    const list = getPayments().slice().reverse();
    tb.innerHTML = '';
    if(list.length===0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3; td.textContent = '— لا يوجد تاريخ للآن —';
      td.style.color = '#cbd5e1'; td.style.padding = '12px';
      tr.appendChild(td); tb.appendChild(tr); return;
    }
    for(const p of list){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.06)">${new Date(p.date).toLocaleString(LOCALE)}</td>
        <td style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.06)">${p.kind==='server'?'Fournisseur (serveur)':'Fournisseur-MACs'}</td>
        <td style="padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:800">${p.amount} DH</td>`;
      tb.appendChild(tr);
    }
  }
  function showHistory(){ renderHistoryTable(); const m=document.getElementById('historyModal'); if(m) m.style.display='flex'; }
  function hideHistory(){ const m=document.getElementById('historyModal'); if(m) m.style.display='none'; }

  // Global click handlers (single attachment)
  document.addEventListener('click', (e)=>{
    const id = e.target?.id;
    if(id === 'btnPayServer'){
      const cur = parseInt((document.getElementById('totalToPay')?.textContent||'0').replace(/[^\d-]/g,''),10)||0;
      if(cur>0){
        addPayment('server', cur);
        if(typeof updateTotals === 'function'){ updateTotals(); } else { adjustForPayments(); }
        alert('Paiement fournisseur enregistré ✅');
      } else {
        alert('لا يوجد مبلغ مستحق الآن ✅');
      }
    }
    if(id === 'btnPayMac'){
      const cur = parseInt((document.getElementById('macsTotalPay')?.textContent||'0').replace(/[^\d-]/g,''),10)||0;
      if(cur>0){
        addPayment('mac', cur);
        if(typeof updateTotals === 'function'){ updateTotals(); } else { adjustForPayments(); }
        alert('Paiement MACs enregistré ✅');
      } else {
        alert('لا يوجد مبلغ مستحق الآن ✅');
      }
    }
    if(id==='btnHistory'){ showHistory(); }
    if(id==='btnHistoryClose'){ hideHistory(); }
    if(id==='btnHistoryClear'){
      if(confirm('مسح السجل كامل؟')){ savePayments([]); if(typeof updateTotals==='function'){updateTotals();} else {adjustForPayments();} renderHistoryTable(); }
    }
    if(id==='btnHistoryExport'){
      const data = getPayments();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const user = (window.state?.user)||'user';
      a.download = `payments_${user}_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    }
  }, {once:false});

  // Initial runs
  function init(){
    try{ adjustForPayments(); }catch(_){}
    try{ injectPayButtons(); }catch(_){}
    try{ placeHistoryButton(); }catch(_){}
    try{ ensureHistoryModal(); }catch(_){}
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // MutationObserver to re-inject if DOM changes later
  const mo = new MutationObserver(()=>{
    injectPayButtons();
    placeHistoryButton();
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
  </script>
<!-- === END: Payments & History (robust) === -->
<!-- === BEGIN: Mobile History injection === -->
<script>
   (function(){
  if(window.__mobileHistoryInjected__) return;
  window.__mobileHistoryInjected__ = true;

  function placeHistoryMobileButton(){
    const mobileMenu = document.getElementById('mobileMenu');
    if(!mobileMenu) return;
    if(document.getElementById('btnHistoryMobile')) return;
    const logoutBtn = document.getElementById('mobileLogout');
    if(logoutBtn){
      const b = document.createElement('button');
      b.id = 'btnHistoryMobile';
      b.className = 'mobile-item';
      b.textContent = 'History';
      mobileMenu.insertBefore(b, logoutBtn);
    }
  }

  function initMobileHistory(){
    placeHistoryMobileButton();
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', initMobileHistory);
  } else {
    initMobileHistory();
  }

  // Extend click handler
  document.addEventListener('click',(e)=>{
    if(e.target?.id==='btnHistoryMobile'){ showHistory(); }
  });
})();
  </script>
<!-- === END: Mobile History injection === -->
<!-- === BEGIN: Mobile History click patch === -->
<script>
   (function(){
  if(window.__mobileHistoryClickPatch__) return;
  window.__mobileHistoryClickPatch__ = true;

  document.addEventListener('click', (e)=>{
    if(e.target?.id === 'btnHistoryMobile'){
      // Prefer triggering the existing header History logic
      const headerBtn = document.getElementById('btnHistory');
      if(headerBtn){ 
        headerBtn.click();
        return;
      }
      // Fallback: open modal directly if present
      const m = document.getElementById('historyModal');
      if(m){
        // Try to render table if available
        try{ (window.renderHistoryTable || function(){})() }catch(_){}
        m.style.display = 'flex';
        return;
      }
      // Last resort
      alert("History modal n'est pas encore prêt. Réessaie après le chargement.");
    }
  }, {once:false});
})();
  </script>
<!-- === END: Mobile History click patch === -->
<script>
   document.getElementById("btnResetData").addEventListener("click", () => {
    const confirmReset = confirm("🧨 واش متأكد بلي بغيتي تمسح جميع البيانات؟");
    if (confirmReset) {
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.toLowerCase().includes("account")) {
          localStorage.removeItem(key);
          i--; // adjust index after removal
        }
      }
      setTimeout(() => {
        alert("✅ All non-account data has been reset.");
      }, 100);
    }
  });
  </script>
<!-- Mobile menu reorder fix: ensure Reseller List appears right after Add Reseller
     and Mac List appears right after Add Mac (handles dynamic insertion) -->
<script>
   (function(){
  function reorderMobileMenu(){
    const menu = document.getElementById('mobileMenu');
    if(!menu) return;
    const addReseller = document.getElementById('mobileAddReseller');
    const listReseller = document.getElementById('mobileResellerList');
    if(addReseller && listReseller && addReseller.nextSibling !== listReseller){
      menu.insertBefore(listReseller, addReseller.nextSibling);
    }
    const addMac = document.getElementById('btnAddMacOpenMobile');
    const listMac = document.getElementById('btnMacListOpenMobile');
    if(addMac && listMac && addMac.nextSibling !== listMac){
      menu.insertBefore(listMac, addMac.nextSibling);
    }
  }

  function setupObserver(){
    const menu = document.getElementById('mobileMenu');
    if(!menu) return;
    const mo = new MutationObserver(() => reorderMobileMenu());
    mo.observe(menu, { childList: true, subtree: false });
  }

  document.addEventListener('DOMContentLoaded', function(){
    reorderMobileMenu();
    setupObserver();
    // extra safety: try again shortly in case menu is injected later
    setTimeout(reorderMobileMenu, 300);
    setTimeout(reorderMobileMenu, 800);
  });
})();
  </script>
<!-- Statistiques Modal (choropleth) -->
<div aria-hidden="true" class="generic-modal" id="statsModal">
<div class="gm-content">
<div class="gm-header">
<h3 class="gm-title">
      Statistiques Géographiques
     </h3>
<div style="display:flex;gap:12px;align-items:center">
<div id="mapLegend" title="Légende">
       Répartition des Clients Par Pays
      </div>
<button class="gm-close" id="closeStats">
       ×
      </button>
</div>
</div>
<div id="mapContainer" style="width:100%; height:640px;">
</div>
<h3 style="margin-top:20px; color:var(--accent);">
     📱 Applications vendues
    </h3>
<table id="deviceStatsTable" style="width:100%; border-collapse:collapse; margin-top:8px;">
<thead>
<tr>
<th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,.15);">
        Device/APP
       </th>
<th style="text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,.15);">
        Nombre de clients
       </th>
</tr>
</thead>
<tbody id="deviceStatsBody">
</tbody>
</table>
<div style="margin-top:8px; font-size:13px; color:var(--muted)">
</div>
</div>
</div>
<script>
   // ===== Statistiques (choropleth) =====
const GEOJSON_URL = "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"; // lightweight world geojson

function normalizeName(s){
  if(!s) return "";
  return s.toString().toLowerCase().trim()
    .replace(/\s*\(.*?\)\s*/g,'') // remove parenthesis
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove accents
    .replace(/[^a-z0-9]+/g,' ') // keep letters/numbers as separator
    .replace(/\s+/g,' ').trim();
}

// small manual mapping french -> english / common
const NAME_MAP = {
  'maroc': 'morocco',
  'royaume uni': 'united kingdom',
  'royaume-uni': 'united kingdom',
  'etats unis': 'united states',
  'etats-unis': 'united states',
  'etatsunisdamerica': 'united states',
  'usa': 'united states',
  'us': 'united states',
  'u.s.a': 'united states',
  'america': 'united states',
  'united states': 'united states',
  'united states of america': 'united states',
  'states': 'united states',
  'états unis': 'united states',
  'états-unis': 'united states',

  'cote d ivoire': 'ivory coast',
  "cote d'ivoire": 'ivory coast',
  'république démocratique du congo': 'democratic republic of congo',
  'rd congo': 'democratic republic of congo',
  'république du congo': 'congo',
  'emirats arabes unis': 'united arab emirates',
  'royaume des pays bas': 'netherlands',
  'royaume des pays-bas': 'netherlands',
  'coree du sud': 'south korea',
  'coree du nord': 'north korea',
  'ivory coast': 'ivory coast',
  'brasil': 'brazil',
  'brésil': 'brazil',
  'espagne': 'spain',
  'españa': 'spain'
};


let worldGeo = null;

async function loadWorldGeo(){
  if(worldGeo) return worldGeo;
  try{
    const r = await fetch(GEOJSON_URL);
    worldGeo = await r.json();
    return worldGeo;
  }catch(e){ console.error("Erreur chargement GeoJSON", e); return null; }
}

function computeCounts(){
  const counts = {};
  // Prefer to read from state.clients if present
  try{
    if(window.state && Array.isArray(window.state.clients) && window.state.clients.length){
      window.state.clients.forEach(c => {
        const raw = c.country || c.pays || c.m_country || c.countryText || c.country_input || '';
        const n = normalizeName(raw);
        if(!n) return;
        const mapped = NAME_MAP[n] || n;
        counts[mapped] = (counts[mapped]||0) + 1;
      });
    }else{
      // fallback: read DOM inputs with class country-input (cells)
      document.querySelectorAll("input.country-input, input[id$='_country'], input[id$='country']").forEach(inp => {
        const raw = inp.value || '';
        const n = normalizeName(raw);
        if(!n) return;
        const mapped = NAME_MAP[n] || n;
        counts[mapped] = (counts[mapped]||0) + 1;
      });
    }
  }catch(e){ console.warn(e); }
  return counts;
}

function getColorForValue(v, max){
  if(v <= 5) return '#38bdf8';     // Bleu ciel
  if(v <= 11) return '#a855f7';    // Mauve
  if(v <= 21) return '#f472b6';    // Rose
  return '#92400e';                // Marron
}

function styleFeature(feature, counts, maxCount, nameKeyCandidates){
  const props = feature.properties || {};
  // Try possible name properties
  let countryName = '';
  for(const k of nameKeyCandidates){
    if(props[k]) { countryName = props[k]; break; }
  }
  if(!countryName) countryName = props.name || props.ADMIN || props.NAME || '';
  const n = normalizeName(countryName);
  const mapped = NAME_MAP[n] || n;
  const val = counts[mapped] || 0;
  return {
    fillColor: val ? getColorForValue(val, maxCount) : '#0b1220',
    weight: 1,
    opacity: 0.8,
    color: val ? '#111' : 'rgba(255,255,255,0.06)',
    dashArray: '0',
    fillOpacity: val ? 0.85 : 0.05
  };
}

async function renderMap(){
  const geo = await loadWorldGeo();
  if(!geo) return;
  const counts = computeCounts();
  const maxCount = Object.values(counts).reduce((a,b)=>Math.max(a,b), 0) || 1;
  // prepare map
  const container = document.getElementById('mapContainer');
  container.innerHTML = ''; // clear
  const map = L.map(container).setView([20, 0], 2);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);
  container._leaflet_map = map;

  // ensure previous label group (if any) is removed so we don't duplicate labels
  if(window._labelLayerGroup){ try{ window._labelLayerGroup.clearLayers(); window._labelLayerGroup.remove(); }catch(e){} }
  window._labelLayerGroup = L.layerGroup().addTo(map);

  // Prepare geojson layer and attempt to match by different property names
  const nameKeys = ['name','NAME','ADMIN','admin','sovereignt'];
  const geoLayer = L.geoJson(geo, {
    style: feature => styleFeature(feature, counts, maxCount, nameKeys),
    onEachFeature: function(feature, layer){
      const props = feature.properties || {};
      let countryName = props.name || props.ADMIN || props.NAME || props.sovereignt || '';
      const n = normalizeName(countryName);
      const mapped = NAME_MAP[n] || n;
      const val = counts[mapped] || 0;
      const label = `<strong>${countryName || '—'}</strong><br/>${val} client(s)`;
      layer.bindPopup(label);
    }
  }).addTo(map);

  // Fit bounds to features that have values >0 if any
  const featuresWithVal = [];
  geo.features.forEach(f => {
    const props = f.properties || {};
    const countryName = props.name || props.ADMIN || props.NAME || '';
    const n = normalizeName(countryName);
    const mapped = NAME_MAP[n] || n;
    if(counts[mapped]) featuresWithVal.push(f);
  });
  if(featuresWithVal.length){
    try{
      const featureGroup = L.featureGroup(featuresWithVal.map(f => L.geoJson(f)));
      map.fitBounds(featureGroup.getBounds().pad(0.4));
    }catch(e){ /* ignore */ }
  }

  // Add legend (simple)
  const legend = L.control({position: 'bottomright'});
  legend.onAdd = function(map){
    const div = L.DomUtil.create('div', 'info legend'); div.style.background='rgba(20,20,30,0.85)'; div.style.color='#f1f5f9'; div.style.padding='8px 10px'; div.style.borderRadius='8px'; div.style.fontWeight='700';
    const grades = [1,6,12,22];
    div.innerHTML = '<div style="font-weight:900;margin-bottom:6px">Clients / pays</div>';
    const labels = [
      {range: '1–5', color: '#38bdf8'},
      {range: '6–11', color: '#a855f7'},
      {range: '12–21', color: '#f472b6'},
      {range: '22+', color: '#92400e'}
    ];
    labels.forEach(l => {
      div.innerHTML += `<div style="display:flex;gap:8px;align-items:center">
        <span style="width:18px;height:12px;background:${l.color};display:inline-block;border-radius:4px;border:1px solid rgba(0,0,0,.08)"></span> ${l.range}
      </div>`;
    });
    return div;
  };
  legend.addTo(map);

// ======== Ajouter étiquettes (labels) fixes sur la carte ========
Object.entries(counts).forEach(([country, count]) => {
  if (!count) return;
  // trouver le centre géographique (choisir le polygone principal) depuis le GeoJSON
  const feature = geo.features.find(f => {
    const props = f.properties || {};
    const n = normalizeName(props.name || props.ADMIN || props.NAME || '');
    const mapped = NAME_MAP[n] || n;
    return mapped === country;
  });
  if (!feature) return;
  try {
    // helper functions for polygon centroid calculation (planar approx)
    function polygonArea(coords){
      let area = 0;
      for (let i = 0; i < coords.length - 1; i++){
        const x1 = coords[i][0], y1 = coords[i][1];
        const x2 = coords[i+1][0], y2 = coords[i+1][1];
        area += (x1 * y2 - x2 * y1);
      }
      return area / 2;
    }
    function polygonCentroid(coords){
      let A = 0, Cx = 0, Cy = 0;
      for (let i = 0; i < coords.length - 1; i++){
        const x0 = coords[i][0], y0 = coords[i][1];
        const x1 = coords[i+1][0], y1 = coords[i+1][1];
        const cross = x0*y1 - x1*y0;
        A += cross;
        Cx += (x0 + x1) * cross;
        Cy += (y0 + y1) * cross;
      }
      A = A / 2;
      if (Math.abs(A) < 1e-9) {
        // fallback to simple average
        let sx = 0, sy = 0;
        for (const p of coords){ sx += p[0]; sy += p[1]; }
        return [sy / coords.length, sx / coords.length];
      }
      Cx = Cx / (6 * A);
      Cy = Cy / (6 * A);
      return [Cy, Cx]; // lat, lon
    }
    function computeFeatureCentroid(feature){
      const g = feature.geometry;
      if(!g) return null;
      if (g.type === 'Polygon'){
        return polygonCentroid(g.coordinates[0]);
      } else if (g.type === 'MultiPolygon'){
        let best = null, bestArea = 0;
        for (const poly of g.coordinates){
          const ring = poly[0];
          const a = Math.abs(polygonArea(ring));
          if (a > bestArea){ bestArea = a; best = polygonCentroid(ring); }
        }
        return best;
      } else if (g.type === 'Point'){
        return [g.coordinates[1], g.coordinates[0]];
      }
      return null;
    }

    const centroid = computeFeatureCentroid(feature);
    let center;
    if (centroid && !isNaN(centroid[0]) && !isNaN(centroid[1])){
      center = L.latLng(centroid[0], centroid[1]);
    } else {
      const bounds = L.geoJson(feature).getBounds();
      center = bounds.getCenter();
    }

    const label = L.divIcon({
      className: 'country-label',
      html: `<div style=\"color:white;text-shadow:0 0 6px #000;font-weight:900;font-size:13px;line-height:1; padding:3px 7px; border-radius:12px; \">${count}</div>`,
      iconSize: [36, 24],
      iconAnchor: [18, 12]
    });
    if(!window._labelLayerGroup) window._labelLayerGroup = L.layerGroup().addTo(map);
    window._labelLayerGroup.addLayer(L.marker(center, { icon: label, interactive: false }));
  } catch(e){ console.warn('Label fail for', country, e); }
});

}

// show/hide modal and render map only once opened
document.getElementById('btnStats').addEventListener('click', async ()=>{
  const modal = document.getElementById('statsModal');
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
  setTimeout(()=>{
    renderMap().then(()=>{
      // ✅ Correction: forcer Leaflet à redessiner la carte si blanche après réouverture
      setTimeout(()=>{
        const container = document.getElementById('mapContainer');
        if (container && container._leaflet_map) container._leaflet_map.invalidateSize();
      }, 300);
    });
  }, 120);
});
document.getElementById('closeStats').addEventListener('click', ()=>{
  document.getElementById('statsModal').style.display = 'none';
  document.getElementById('statsModal').setAttribute('aria-hidden','true');
});
  </script>
<script id="mobile-stats-script">
   document.addEventListener("DOMContentLoaded", () => {
  const mStats = document.getElementById("mobileStats");
  const dStats = document.getElementById("btnStats");
  const menu = document.getElementById("mobileMenu");
  if (mStats && dStats) {
    mStats.addEventListener("click", () => {
      try { dStats.click(); } catch(e) { console.warn(e); }
      if (menu) menu.classList.remove("show");
    });
  }
});
  </script>
<script>
   // === Synchroniser le bouton mobile avec celui du desktop ===
document.addEventListener("DOMContentLoaded", function(){
  const mobileResellerBtn = document.getElementById("mobileResellerGain");
  const desktopResellerBtn = document.getElementById("btnResellerGain");
  if (mobileResellerBtn && desktopResellerBtn) {
    mobileResellerBtn.addEventListener("click", () => {
      desktopResellerBtn.click(); // simule le clic desktop
    });
  }
});
  </script>
<script>
   (function(){
  function moveResellerBtnToAfter(targetEl){
    try {
      var resellerBtn = document.getElementById('btnResellerGain');
      if (!resellerBtn || !targetEl) return false;
      if (resellerBtn.previousElementSibling === targetEl) return true;
      targetEl.insertAdjacentElement('afterend', resellerBtn);
      return true;
    } catch(e) {
      return false;
    }
  }

  function findAddResellerButton(){
    // 1) by id
    var t = document.getElementById('btnAddResellerOpen');
    if (t) return t;
    // 2) by exact text (case-insensitive) across common tag types
    var textTargets = ['add reseller','add reseller'];
    var tags = ['button','a','div','span','li'];
    for (var ti=0; ti<tags.length; ti++){
      var elems = document.getElementsByTagName(tags[ti]);
      for (var i=0;i<elems.length;i++){
        var txt = (elems[i].textContent || '').trim().toLowerCase();
        if (textTargets.indexOf(txt) !== -1){
          return elems[i];
        }
      }
    }
    // 3) by attributes or aria labels
    var possible = document.querySelector('[data-act="add-reseller"], [aria-label="Add Reseller"], [title="Add Reseller"]');
    if (possible) return possible;
    return null;
  }

  function attemptMove(){
    var target = findAddResellerButton();
    if (target){
      var ok = moveResellerBtnToAfter(target);
      if (ok && window.__reseller_mover_observer){
        window.__reseller_mover_observer.disconnect();
        window.__reseller_mover_observer = null;
      }
      return ok;
    }
    return false;
  }

  document.addEventListener('DOMContentLoaded', function(){
    if (attemptMove()) return;
    if (window.__reseller_mover_observer) window.__reseller_mover_observer.disconnect();
    window.__reseller_mover_observer = new MutationObserver(function(muts){
      if (attemptMove()) {
        // moved
      }
    });
    window.__reseller_mover_observer.observe(document.body || document.documentElement, { childList:true, subtree:true, attributes:false });
    setTimeout(attemptMove, 800);
    setTimeout(attemptMove, 1800);
    setTimeout(attemptMove, 3200);
  });
})();
  </script>
<script>
   (() => {
  function renderDeviceStatsSelect() {
    const visibleTable = document.querySelector(".gm-content #deviceStatsTable");
    if (!visibleTable) return console.warn("❌ Tableau visible introuvable dans gm-content.");

    // crée un tbody si manquant
    let tbody = visibleTable.querySelector("tbody");
    if (!tbody) {
      tbody = document.createElement("tbody");
      visibleTable.appendChild(tbody);
    }

    const mainTbl = document.querySelectorAll('div[style*="max-height:62vh"] table')[0];
    if (!mainTbl) return console.warn("❌ Table principale introuvable.");
    const rows = mainTbl.querySelectorAll("tbody tr");
    if (!rows.length) return console.warn("⏳ Aucune ligne client trouvée.");

    const counts = {};
    rows.forEach(tr => {
      const select = tr.querySelector("td:nth-child(4) select.device-select");
      if (!select) return;
      const selectedOption = select.querySelector("option[selected]");
      const app = selectedOption ? selectedOption.textContent.trim() : "Inconnu";
      counts[app] = (counts[app] || 0) + 1;
    });

    tbody.innerHTML = "";
    const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    entries.forEach(([app,count])=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.06);">${app}</td>
        <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.06);color:var(--accent,#4af);font-weight:700;">${count}</td>
      `;
      tbody.appendChild(tr);
    });
    
  }

  renderDeviceStatsSelect();
})();
  </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js">
</script>
<script>
   document.addEventListener("click", async function(e) {
  if (e.target && e.target.dataset.act === "invoice") {
    const row = e.target.closest("tr");
    if (!row) return alert("Impossible de trouver la ligne du client !");
    const tds = row.querySelectorAll("td");

    function extractCellValue(td) {
      const select = td.querySelector("select");
      if (select) {
        return select.options[select.selectedIndex]?.text || "";
      }
      const input = td.querySelector("input");
      if (input) {
        return input.value || "";
      }
      return td.innerText.trim();
    }

    const client = {
      name: extractCellValue(tds[0]),
      username: extractCellValue(tds[1]),
      mac: extractCellValue(tds[2]),
      device: extractCellValue(tds[3]),
      start: extractCellValue(tds[4]),
      type: extractCellValue(tds[5]),
      sale: extractCellValue(tds[6]),
      paiement: extractCellValue(tds[7])
    };

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Logo centré
    const logoUrl = "assets/img/logo.png";
    try {
      const logo = await loadImage(logoUrl);
      doc.addImage(logo, "PNG", 80, 10, 50, 30);
    } catch (err) {
      console.warn("Logo introuvable");
    }

    // Titre centré
    doc.setFontSize(18);
    doc.text("Facture d'abonnement IPTV", 105, 50, { align: "center" });

    // Tableau infos
    doc.autoTable({
      startY: 65,
      head: [["Champ", "Valeur"]],
      body: [
                ["Nom", client.name],
        ["Username / Code", client.username],
        ["Adresse MAC", client.mac],
        ["Appareil", client.device],
        ["Date début", client.start],
        ["Date d’expiration", _expValue],
        ["N° Facture", (client.id && client.id !== "{{ID}}") ? client.id : (function(){
            var d=new Date();
            var pad=n=>String(n).padStart(2,"0");
            var id="FAC-"+d.getFullYear()
              +pad(d.getMonth()+1)+pad(d.getDate())
              +pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds());
            return id;
        })()]


      ],
      theme: "grid",
      headStyles: { fillColor: [200, 0, 0] },
      styles: { fontSize: 12, cellPadding: 3 }
    });

    doc.save(`facture_${client.username || "client"}.pdf`);
  }
});

function loadImage(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      resolve(canvas.toDataURL("image/png"));
    };
    img.onerror = reject;
    img.src = url;
  });
}
  </script>
<!-- ==== FACTURE (modale imprimable) – injectée ==== -->
<div id="invoiceModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:99999; align-items:center; justify-content:center;">
<div id="invoice" style="width:min(800px, 94vw); background:#fff; color:#111; border-radius:8px; padding:28px; box-shadow:0 20px 60px rgba(0,0,0,.4);">
<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
<h2 style="margin:0; font-size:20px;">
      Facture d'abonnement IPTV
     </h2>
<button id="closeInvoice" style="border:none; background:#eee; padding:6px 10px; border-radius:8px; cursor:pointer">
      Fermer
     </button>
</div>
<table style="width:100%; border-collapse:collapse; font-size:14px;">
<tbody id="invoiceBody">
</tbody>
</table>
<div style="margin-top:24px; display:flex; justify-content:space-between; align-items:center;">
<div style="font-size:12px; color:#555;">
      IPTV MANAGER · Généré automatiquement
     </div>
<button id="printInvoice" style="border:none; background:#111; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer;">
      Télécharger PDF
     </button>
</div>
</div>
</div>
<style id="invoice-print-css">
   @media print {
  body * { visibility: hidden !important; }
  #invoice, #invoice * { visibility: visible !important; }
  #invoice { position: absolute; inset: 0; margin: 0 auto; box-shadow: none !important; }
  #closeInvoice, #printInvoice { display: none !important; }
}
#invoice table td:first-child { width: 42%; color:#444; padding:8px 10px; vertical-align: top; }
#invoice table td:last-child  { width: 58%; font-weight:700; padding:8px 10px; vertical-align: top; }
#invoice table tr + tr td { border-top:1px solid #eee; }
  </style>
<!-- html2pdf.js (CDN) -->
<script>
   (function(){
  function load(src, cb){var s=document.createElement("script"); s.src=src; s.onload=cb; s.onerror=cb; document.head.appendChild(s);} 
  if(!window.html2pdf){
    load("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js", function(){
      if(!window.html2pdf){
        load("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js", function(){});
      }
    });
  }
})();
  </script>
<script id="invoice-logic">
   (function(){
  function fmtFR(d){
    try{
      const dd = new Date(d);
      if(!isNaN(dd)) return dd.toLocaleDateString('fr-FR');
    }catch(_){}
    return d || '';
  }
  function safe(v){
    return String(v==null?'':v).replaceAll('<','&lt;');
  }
  function buildInvoiceRows(c){
    const saleDefault = (window.state && typeof state.saleDefault==='number') ? state.saleDefault : 0;
    const typeLabel = c.type==='1y' ? '1 an' : (c.type==='6m' ? '6 mois' : (c.type==='3m' ? '3 mois' : (c.type||'—')));
    
    // Calcul automatique de la date d’expiration si absente (start + 1 an)
    let expStr = '';
    try {
      if (c && c.end) {
        expStr = fmtFR(c.end);
      } else if (c && c.start) {
        const _s = new Date(c.start);
        if (!isNaN(_s)) {
          const _e = new Date(_s);
          _e.setFullYear(_s.getFullYear() + 1);
          expStr = _e.toLocaleDateString('fr-FR');
        }
      }
    } catch(_) {}

    // Numéro de facture: utiliser c.id si présent et différent de '{{ID}}', sinon générer FAC-YYYYMMDDHHMMSS
    let factId = (c && c.id && c.id !== '{{ID}}') ? String(c.id) : (function(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      return 'FAC-' + d.getFullYear() + pad(d.getMonth()+1) + pad(d.getDate()) + pad(d.getHours()) + pad(d.getMinutes()) + pad(d.getSeconds());
    })();
return [
      ['Nom :', safe(c.name||'—')],
      ['Username / Code :', safe(c.username || c.code || '—')],
      ['Adresse MAC :', safe(c.mac || '—')],
      ['Appareil :', safe(c.device || '—')],
      ['Date début :', safe(fmtFR(c.start))],
      ['Date d’expiration :', safe(expStr || '—')],
      ['Pays :', safe(c.country || '—')],
      ['N° Facture :', safe(factId)],
      ['Date de génération :', safe(new Date().toLocaleString('fr-FR'))],
    ];
    }
  function openInvoice(c){
    var modal = document.getElementById('invoiceModal');
    var tbody = document.getElementById('invoiceBody');
    if(!modal || !tbody) return;
    var rows = buildInvoiceRows(c);
    tbody.innerHTML = rows.map(function(pair){
      return '<tr><td>'+pair[0]+'</td><td>'+pair[1]+'</td></tr>';
    }).join('');
    modal.style.display = 'flex';

    // Bind PDF download
    var btn = document.getElementById('printInvoice');
    if(btn && !btn.__bound){
      btn.addEventListener('click', function(){
        try{
          var el = document.getElementById('invoice');
          var filename = 'facture_' + (c.username || c.code || c.name || 'client') + '.pdf';
          var opt = {
            margin: 10,
            filename: filename,
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };
          if (window.html2pdf) {
            window.html2pdf().from(el).set(opt).save();
          } else if (window.jspdf || window.jsPDF) {
            try {
              var jsPDF = window.jspdf ? window.jspdf.jsPDF : window.jsPDF;
              var doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
              // Title
              doc.setFontSize(18);
              doc.text('Facture d\'abonnement IPTV', 105, 20, { align: 'center' });
              // Build table from current modal rows
              var rows = [];
              document.querySelectorAll('#invoiceBody tr').forEach(function(tr){
                var tds = tr.querySelectorAll('td');
                if(tds.length>=2){ rows.push([tds[0].innerText.trim(), tds[1].innerText.trim()]); }
              });
              if (doc.autoTable && rows.length){
                doc.autoTable({ startY: 30, head: [['Champ','Valeur']], body: rows, theme: 'grid', headStyles: { fillColor: [200,0,0] }, styles: { fontSize: 12, cellPadding: 3 } });
              }
              doc.save(filename);
            } catch(e){ console.error(e); alert('Impossible de générer le PDF (fallback jsPDF).'); }
          } else {
            alert('html2pdf.js non chargé et jsPDF indisponible.');
          }
        }catch(err){
          console.error(err);
          alert('Erreur génération PDF.');
        }
      });
      btn.__bound = true;
    }
  }
  // Close modal
  (function(){
    var closeBtn = document.getElementById('closeInvoice');
    var modal = document.getElementById('invoiceModal');
    if(closeBtn && !closeBtn.__bound){
      closeBtn.addEventListener('click', function(){
        if(modal) modal.style.display = 'none';
      });
      closeBtn.__bound = true;
    }
    if(modal && !modal.__outsideBound){
      modal.addEventListener('click', function(e){
        if(e.target === modal) modal.style.display = 'none';
      });
      modal.__outsideBound = true;
    }
  })();
  // Ensure each actions menu has the "invoice" item, and bind click
  function ensureInvoiceButtons(){
    var menus = document.querySelectorAll('.actions-menu');
    menus.forEach(function(menu){
      if(!menu.querySelector('[data-act="invoice"]')){
        var btn = document.createElement('button');
        btn.className = 'menu-item';
        btn.setAttribute('data-act','invoice');
        // try to find the row id from any sibling button with data-id
        var anyBtn = menu.querySelector('[data-id]');
        var id = anyBtn ? anyBtn.getAttribute('data-id') : null;
        if(id) btn.setAttribute('data-id', id);
        btn.textContent = '🧾 Générer la facture';
        menu.insertBefore(btn, menu.firstChild);
      }
    });
  }
  ensureInvoiceButtons();
  // Delegate clicks: open/close menu + invoice action
  document.addEventListener('click', function(e){
    var t = e.target;
    // Toggle menu open
    if(t && t.classList.contains('actions-btn')){
      var wrap = t.closest('.actions-dropdown');
      if(wrap) wrap.classList.toggle('open');
    }
    // Handle invoice
    if(t && t.dataset && t.dataset.act === 'invoice'){
      var id = t.dataset.id;
      if(!id){
        // if missing, try pull from the row (data-id on siblings)
        var menu = t.closest('.actions-menu');
        var anyBtn = menu ? menu.querySelector('[data-id]') : null;
        id = anyBtn ? anyBtn.getAttribute('data-id') : null;
      }
      var list = (window.state && Array.isArray(state.clients)) ? state.clients : [];
      var c = list.find(function(x){ return x && x.id === id; });
      if(c){ openInvoice(c); }
      else {
        // Fallback: try to read from table row cells (minimal)
        var tr = t.closest('tr');
        if(tr){
          var cells = tr.querySelectorAll('td');
          var cObj = {
            name: cells[1]?.innerText.trim(),
            username: cells[2]?.innerText.trim(),
            device: tr.querySelector('.device-select')?.value || '',
            start: tr.querySelector('.date-start')?.innerText.trim(),
            end: tr.querySelector('.date-end')?.innerText.trim(),
            type: tr.querySelector('.type-select')?.value || '',
            paid: /Payé/i.test(cells[7]?.innerText||'') ? 'yes':'no',
            mac: cells[9]?.innerText.trim(),
            country: tr.querySelector('.country-input')?.value || '',
            sale: parseInt((cells[11]?.innerText||'').replace(/[^0-9-]/g,''),10) || 0,
            id: id || 'row'
          };
          openInvoice(cObj);
        }
      }
      // Close open menu after click
      var open = document.querySelector('.actions-dropdown.open');
      if(open) open.classList.remove('open');
    }
  });
  // After each render() we want to re-ensure invoice buttons
  // Monkey-patch render if available
  try{
    if(typeof window.render === 'function' && !window.__renderPatched){
      const orig = window.render;
      window.render = function(){
        const ret = orig.apply(this, arguments);
        try{ ensureInvoiceButtons(); }catch(_){}
        return ret;
      };
      window.__renderPatched = true;
    }
  }catch(_){}
})();
  </script>
<script id="actions-toggle-fix">
   document.addEventListener('click', (e) => {
  const t = e.target;
  // Ouvrir / fermer le menu
  if (t && t.classList.contains('actions-btn')) {
    const wrap = t.closest('.actions-dropdown');
    if (wrap) wrap.classList.toggle('open');
  }
  // Fermer le menu si on clique ailleurs
  const open = document.querySelector('.actions-dropdown.open');
  if (open && !open.contains(e.target)) {
    open.classList.remove('open');
  }
});
  </script>
<!-- ===== LOGS PANEL ===== -->
<div aria-hidden="true" class="generic-modal" id="logsPanel" style="display:none;align-items:center;justify-content:center;">
<div class="gm-content" style="max-width:820px;min-width:320px">
<div class="gm-header">
<h3 class="gm-title">
      📜 Journal des Activités
     </h3>
<button class="gm-close" id="closeLogs">
      ×
     </button>
</div>
<div style="padding:8px 0 0 0">
<div id="logsContainer" style="font-family:monospace;font-size:13px;white-space:pre-wrap;color:#f8fafc;max-height:58vh;overflow-y:auto;border:1px solid rgba(255,255,255,.06);padding:10px;border-radius:8px;background:rgba(255,255,255,.02);display:none !important;">
</div>
<div class="logs-view" id="logsContainerView">
</div>
<div style="margin-top:10px;text-align:right">
<button class="btn-outline" id="btnLogsClose">
       Fermer
      </button>
<button class="btn-danger" id="btnLogsClear">
       Effacer Logs
      </button>
</div>
</div>
</div>
</div>
<script id="iptv-logs-script">
   // ======== LOG SYSTEM v2 (Resellers + MACs + Paiement montant réel) ========
(function(){
  const LS_LOGS = "iptv_logs_v1";
  const delay = (ms)=>new Promise(res=>setTimeout(res,ms));
  function now(){const d=new Date();return d.toLocaleDateString('fr-FR')+" "+d.toLocaleTimeString('fr-FR',{hour12:false});}
  function num(s){const m=String(s||'').replace(/\s/g,'').match(/([\d\.,]+)/);return m?parseFloat(m[1].replace(',','.')):0;}
  function getCreditsLeft(){const el=document.getElementById('creditsLeft');return el?num(el.textContent):null;}
  function addLog(text){try{const arr=JSON.parse(localStorage.getItem(LS_LOGS)||"[]");arr.unshift(`${now()} ${text}`);localStorage.setItem(LS_LOGS,JSON.stringify(arr));renderLogs();}catch(e){console.error(e);}}
  function renderLogs(){const el=document.getElementById('logsContainer');if(!el)return;const arr=JSON.parse(localStorage.getItem(LS_LOGS)||"[]");el.textContent=arr.join("\n");el.scrollTop=0;}
  function clearLogs(){localStorage.removeItem(LS_LOGS);renderLogs();}
  function showLogs(){renderLogs();const m=document.getElementById('logsPanel');if(m)m.style.display='flex';}
  function hideLogs(){const m=document.getElementById('logsPanel');if(m)m.style.display='none';}

  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('btnLogsClose')?.addEventListener('click',hideLogs);
    document.getElementById('closeLogs')?.addEventListener('click',hideLogs);
    document.getElementById('btnLogsClear')?.addEventListener('click',()=>{if(confirm('Effacer tous les logs ?'))clearLogs();});

    const toolsMenu=document.getElementById('toolsMenu');
    if(toolsMenu&&!document.getElementById('btnViewLogs')){const b=document.createElement('button');b.id='btnViewLogs';b.className='btn-outline';b.textContent='📜 Voir les Logs';b.onclick=showLogs;toolsMenu.appendChild(b);}

    renderLogs();

    const tbody=document.getElementById('tbody');
    let snap=new Map(),creditsBefore=getCreditsLeft();
    function takeSnap(){const m=new Map();if(!tbody)return m;tbody.querySelectorAll('tr').forEach(tr=>{const t=tr.querySelectorAll('td');const name=t[1]?t[1].textContent.trim():'';const user=t[2]?t[2].textContent.trim():name;m.set(user||name,{name,user});});return m;}
    snap=takeSnap();
    if(tbody){new MutationObserver(()=>{const ns=takeSnap();ns.forEach((v,k)=>{if(!snap.has(k)){addLog(`Nouveau Client "${v.name}" → Crédits : ${creditsBefore} → ${getCreditsLeft()} (auto)`);}});snap.forEach((v,k)=>{if(!ns.has(k)){addLog(`Deleted Client "${v.name}" → Crédits : ${creditsBefore} → ${getCreditsLeft()} (auto)`);}});snap=ns;creditsBefore=getCreditsLeft();}).observe(tbody,{childList:true,subtree:true});}

    const btnR=document.getElementById('btnResellerSave');
    if(btnR){btnR.addEventListener('click',async()=>{const name=document.getElementById('r_name')?.value||'[unknown]';const used=num(document.getElementById('r_credits')?.value);const oldC=getCreditsLeft();await delay(400);const newC=getCreditsLeft();addLog(`Nouveau Reseller "${name}" → Crédits : ${oldC} → ${newC} (used:${used})`);});}

    const btnM=document.getElementById('macAddSave');
    if(btnM){btnM.addEventListener('click',async()=>{const mac=document.getElementById('mac_mac')?.value||'[unknown]';const achat=num(document.getElementById('mac_price')?.value);const vente=num(document.getElementById('mac_sale')?.value);await delay(400);addLog(`Nouvelle Mac "${mac}" → Achat: ${achat} DH → Vente: ${vente} DH`);});}

    const payServer=document.getElementById('btnPayServer');
    if(payServer){payServer.addEventListener('click',async()=>{await delay(600);const txt=document.getElementById('totalToPay')?.textContent.trim()||'0 DH';addLog(`Paiement Server effectué : ${txt}`);});}

    const payMac=document.getElementById('btnPayMac');
    if(payMac){payMac.addEventListener('click',async()=>{await delay(600);const txt=document.getElementById('macsTotalPay')?.textContent.trim()||'0 DH';addLog(`Paiement Macs effectué : ${txt}`);});}

    





// === FINAL CLEAN VERSION ===
document.body.addEventListener('click', (ev) => {
  const id = ev.target.id;

  // === Reseller Save ===
  if (id === 'btnResellerSave') {
    
    const name = document.getElementById('r_name')?.value || '[unknown]';
    const used = Number(document.getElementById('r_credits')?.value || 0);
    const oldC = getCreditsLeft();
    addLog(`Nouveau Reseller "${name}" → Crédits : ${oldC} → (en attente MAJ) (used:${used})`);
    setTimeout(() => {
      const newC = getCreditsLeft();
      addLog(`→ MAJ Crédits Reseller "${name}" : ${oldC} → ${newC}`);
    }, 1000);
  }

  // === MAC Save ===
  if (id === 'macAddSave') {
    
    const mac = document.getElementById('mac_mac')?.value || '[unknown]';
    const achat = Number(document.getElementById('mac_price')?.value || 0);
    const vente = Number(document.getElementById('mac_sale')?.value || 0);
    addLog(`Nouvelle Mac "${mac}" → Achat: ${achat} DH → Vente: ${vente} DH`);
  }

  // === Paiement Server ===
  if (id === 'btnPayServer') {
    
    const txt = document.getElementById('totalToPay')?.textContent.trim() || '0 DH';
    addLog(`Paiement Server effectué : ${txt}`);
  }

  // === Paiement MAC ===
  if (id === 'btnPayMac') {
    
    const txt = document.getElementById('macsTotalPay')?.textContent.trim() || '0 DH';
    addLog(`Paiement Macs effectué : ${txt}`);
  }
});



// === FIX DEFINITIF : Capture dynamique du bouton "Save Reseller"
document.body.addEventListener("click", async (e) => {
  if (e.target.id === "btnResellerSave") {
    

    const modal = e.target.closest("#resellerModal");
    if (!modal) {
      console.warn("[FIX] Pas dans resellerModal, clic ignoré");
      return;
    }

    const name = modal.querySelector("#r_name")?.value || "[unknown]";
    const used = Number(modal.querySelector("#r_credits")?.value || 0);
    const oldC = getCreditsLeft();

    addLog(`Nouveau Reseller "${name}" → Crédits : ${oldC} → (en attente MAJ) (used:${used})`);

    await new Promise(r => setTimeout(r, 1000));
    const newC = getCreditsLeft();
    addLog(`→ MAJ Crédits Reseller "${name}" : ${oldC} → ${newC}`);
  }
});





// === FINAL CLEAN LOG FIX ===

// Nettoyage des logs "0 DH" (éviter doublons)
document.body.addEventListener("click", (ev) => {
  const id = ev.target.id;

  // Paiement Server
  if (id === "btnPayServer") {
    const txt = document.getElementById("totalToPay")?.textContent.trim() || "0 DH";
    if (txt !== "0 DH") addLog(`Paiement Server effectué : ${txt}`);
  }

  // Paiement MACs
  if (id === "btnPayMac") {
    const txt = document.getElementById("macsTotalPay")?.textContent.trim() || "0 DH";
    if (txt !== "0 DH") addLog(`Paiement Macs effectué : ${txt}`);
  }
}, true);

// Correction Reseller : affiche une seule ligne finale
document.addEventListener("mouseup", (ev) => {
  const target = ev.target;
  if (target && target.id === "btnResellerSave") {
    const modal = target.closest("#resellerModal");
    const name = modal?.querySelector("#r_name")?.value || "[no name]";
    const credits = modal?.querySelector("#r_credits")?.value || 0;
    const oldC = document.getElementById("creditsLeft")?.textContent?.trim() || "??";
    setTimeout(() => {
      const newC = document.getElementById("creditsLeft")?.textContent?.trim() || "??";
      addLog(`Nouveau Reseller "${name}" → Crédits : ${oldC} → ${newC} (used:${credits})`);
    }, 1000);
  }
}, true);



window.IPTVLogs = {add:addLog,show:showLogs,hide:hideLogs,clear:clearLogs,render:renderLogs};
  });
})();
  </script>
<script>
   // --- Clear Logs: also remove persistent storage so nothing returns after refresh ---
(function() {
  const KEY = 'iptv_activity_logs_v1';
  function attachClearFix(){
    const btn = document.getElementById('btnLogsClear');
    if (!btn || btn.__del_clearfix) return;
    btn.addEventListener('click', function(){
      try { localStorage.removeItem(KEY); } catch(e) {}
      if (window.__LOGS__) window.__LOGS__ = [];
      const c = document.getElementById('logsContainer');
      if (c) c.textContent = '';
      console.log('[DEL-LOG] Historique supprimé définitivement');
    });
    btn.__del_clearfix = true;
  }
  // Run now and on any future DOM changes (in case the modal is rebuilt)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachClearFix);
  } else {
    attachClearFix();
  }
  // Re-attach on clicks (modal toggles) without duplicating
  document.addEventListener('click', () => setTimeout(attachClearFix, 0), true);
})();
  </script>
<script>
   // === Credits-after fix intégré (suppression reseller) — ROBUST PATCH (scoped, non-destructive) ===
(() => {
  const RES_KEY   = 'iptv_resellers_v1';               // localStorage key for resellers
  const KEY_CUSTOM = 'iptv_activity_logs_custom_v1';   // store for our detailed lines (optional)
  const KEY_CUSTOM_LAST_CLEAR = 'iptv_activity_logs_custom_last_clear'; // ts of last 'Effacer Logs' click

  // ---------- Utils ----------
  const num = v => Number(String(v||'').replace(/[^\d]/g,'')) || 0;
  const pad = n => String(n).padStart(2,'0');
  const fmt = d => `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const getCredits = () => {
    try { const el = document.getElementById('creditsLeft'); if (el) return num(el.textContent); } catch {}
    return null;
  };
  const loadCustom = () => { try { return JSON.parse(localStorage.getItem(KEY_CUSTOM)||'[]'); } catch { return []; } };
  const saveCustom = arr => localStorage.setItem(KEY_CUSTOM, JSON.stringify(arr.slice(0, 500)));
  // --- Dedup helpers ---
  function keyOf(line){
    // key: "DD/MM/YYYY HH:MM:SS||NAME"
    const m = line.match(/^(\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}) Suppression Reseller \"([^\"]+)\"/);
    return m ? (m[1] + '||' + m[2]) : null;
  }
  function isEnriched(line){ return /→ Crédits\s*:\s*\d+\s*→\s*\d+/.test(line); }
  function dedupPanel(){
    const c = document.getElementById('logsContainer');
    if (!c) return;
    const lines = (c.textContent || '').split('\n');
    const enrichedKeys = new Set();
    for (const l of lines){
      if (isEnriched(l)){ const k = keyOf(l); if (k) enrichedKeys.add(k); }
    }
    const out = [];
    for (const l of lines){
      if (!l) continue;
      const k = keyOf(l);
      if (k && !isEnriched(l) && enrichedKeys.has(k)) {
        // skip plain if enriched exists for same key
        continue;
      }
      out.push(l);
    }
    c.textContent = out.join('\n');
    c.scrollTop = c.scrollHeight;
    // dedup plain vs enriched lines
    try { dedupPanel(); } catch {}
  }

  function appendToPanel(line){
    const c = document.getElementById('logsContainer');
    if (!c || !line) return;
    const needsNL = c.textContent && !c.textContent.endsWith('\n');
    c.textContent += (needsNL ? '\n' : '') + line;     // append only, never overwrite
    c.scrollTop = c.scrollHeight;
    // dedup plain vs enriched lines
    try { dedupPanel(); } catch {}
  }

  // ---------- Capture "before" au clic sur supprimer ----------
  let snapBefore = null;
  document.addEventListener('click', e => {
    const btn = e.target.closest?.('[data-act="delRes"]');
    if (btn) { snapBefore = getCredits(); }
  }, true);

  // ---------- Détection suppression reseller (diff localStorage) ----------
  let prevRaw = localStorage.getItem(RES_KEY);
  let prev = [];
  try { prev = JSON.parse(prevRaw||'[]'); if (!Array.isArray(prev)) prev = []; } catch { prev = []; }
  const S = x => JSON.stringify(x);

  setInterval(() => {
    const nowRaw = localStorage.getItem(RES_KEY);
    if (nowRaw === prevRaw) return;

    let now = [];
    try { now = JSON.parse(nowRaw||'[]'); if (!Array.isArray(now)) now = []; } catch { now = []; }

    if (now.length < prev.length) {
      const removed = prev.filter(r => !now.find(n => S(n) === S(r)));
      if (removed.length) {
        const used = removed.reduce((s,x)=> s + (Number(x?.used ?? x?.credit ?? x?.credits ?? x?.creditsUsed ?? x?.used_credits ?? 0) || 0), 0);
        const who  = removed[0]?.name || removed[0]?.username || removed[0]?.id || '[unknown]';

        const t0 = Date.now();
        let tries = 0;
        const timer = setInterval(() => {
          tries++;
          const after = getCredits();
          const timeup = (Date.now() - t0) > 1500;
          const settled = after != null;
          if (settled || timeup || tries >= 15) {
            clearInterval(timer);

            let before;
            if (after != null) {
              if (snapBefore != null && snapBefore <= after) before = snapBefore;
              else before = Math.max(0, after - used);
            } else {
              before = (snapBefore != null ? snapBefore : 0);
            }

            const line = `${fmt(new Date())} Suppression Reseller "${who}" → Crédits : ${before} → ${after != null ? after : (before + used)} (used:${used})`;

            // Persist (non-destructive) and append
            const arr = loadCustom();
            if (arr[0] !== line) { arr.unshift(line); saveCustom(arr); }
            appendToPanel(line);
          }
        }, 100);
      }
    }

    prevRaw = nowRaw;
    prev = now;
    snapBefore = null;
  }, 300);

  // ---------- Panel sync: append missing custom lines only (no overwrite) ----------
  (function syncPanelOnOpen(){
    const panel = document.getElementById('logsPanel');
    const container = document.getElementById('logsContainer');
    if (!panel || !container) return;

    function appendMissing() {
      const lines = loadCustom();
      if (!Array.isArray(lines) || lines.length === 0) return;
      const current = container.textContent || '';
      // add newest first if not already contained as full line
      const lastClear = (typeof getLastClearTs === 'function' ? getLastClearTs() : 0);
      for (let i = lines.length - 1; i >= 0; i--) {
        const line = lines[i];
        const ts = (typeof parseLineTs==='function'?parseLineTs(line):null);
        if (line && (!ts || ts >= lastClear) && !current.includes(line)) {
          const needsNL = container.textContent && !container.textContent.endsWith('\n');
          container.textContent += (needsNL ? '\n' : '') + line;
        }
      }
      container.scrollTop = container.scrollHeight;
      try { dedupPanel(); } catch {}
    }

    new MutationObserver(() => {
      if (panel.style.display !== 'none') {
        setTimeout(appendMissing, 40);
        setTimeout(appendMissing, 200);
      }
    }).observe(panel, { attributes:true, attributeFilter:['style'] });
  })();

  
  // --- Integrate with "Effacer Logs" button: clear our custom store too
  (function hookClearButton(){
    try {
      const btn = document.getElementById('btnLogsClear');
      if (btn && !btn.__customClearHooked) {
        btn.__customClearHooked = true;
        btn.addEventListener('click', () => {
          localStorage.setItem(KEY_CUSTOM, '[]');
          localStorage.setItem(KEY_CUSTOM_LAST_CLEAR, String(Date.now()));
          const c = document.getElementById('logsContainer');
          if (c) { /* do not overwrite panel; let original handler clear; we only ensure our lines won't return */ }
          console.log('[CustomLogs] Cleared custom logs and set last_clear ts.');
        }, true);
      }
    } catch {}
  })();
  // --- If any script clears iptv_activity_logs_v1 via setItem, mirror clear on our custom key
  (function hookStorageClear(){
    try{
      const _set = localStorage.setItem.bind(localStorage);
      localStorage.setItem = function(k, v){
        if (k === 'iptv_activity_logs_v1' && (v === '[]' || v === '[ ]' || v === '"[]"')){
          try {
            localStorage.setItem(KEY_CUSTOM, '[]');
            localStorage.setItem(KEY_CUSTOM_LAST_CLEAR, String(Date.now()));
          } catch {}
        }
        return _set.apply(this, arguments);
      };
    }catch{}
  })();

  console.log('Credits-after fix intégré (suppression reseller) — patch robuste non-destructif chargé.');
})();
  </script>
<script>
   // --- Chronological ordering: sort panel lines by timestamp (DD/MM/YYYY HH:mm:ss) ---
(function(){
  const tsRegex = /^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})\b/;
  function parseTs(line){
    const m = tsRegex.exec(line);
    if(!m) return null;
    const [_, dd, mm, yyyy, HH, MM, SS] = m;
    const d = new Date(
      Number(yyyy), Number(mm)-1, Number(dd),
      Number(HH), Number(MM), Number(SS)
    );
    return d.getTime();
  }
  function sortPanelChrono(){
    const panel = document.getElementById('logsPanel');
    const c = document.getElementById('logsContainer');
    if(!panel || !c) return;
    const raw = (c.textContent || '').split('\n').filter(Boolean);
    if(!raw.length) return;
    const items = raw.map(line => ({ line, t: parseTs(line) ?? 0 }));
    items.sort((a,b) => b.t - a.t); // oldest -> newest
    const out = items.map(x => x.line).join('\n\n');
    if (out !== c.textContent) {
      c.textContent = out;
      c.scrollTop = c.scrollHeight;
    }
  }
  // sort when panel opens
  const btn = document.getElementById('btnViewLogs');
  if (btn && !btn.__chrono_sort_bound) {
    btn.addEventListener('click', () => setTimeout(sortPanelChrono, 0));
    btn.__chrono_sort_bound = true;
  }
  const p = document.getElementById('logsPanel');
  if (p && !p.__chrono_sort_obs) {
    const obs = new MutationObserver(() => {
      if (p.style.display !== 'none') setTimeout(sortPanelChrono, 50);
    });
    obs.observe(p, { attributes:true, attributeFilter:['style','aria-hidden'] });
    p.__chrono_sort_obs = true;
  }
  // also attempt once on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', sortPanelChrono);
  } else {
    setTimeout(sortPanelChrono, 0);
  }
})();
  </script>
<!-- Mobile 'Voir les Logs' opener -->
<script>
   document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btnViewLogs');
  const panel = document.getElementById('logsPanel');
  if (btn && panel) {
    btn.addEventListener('click', () => {
      // Close mobile menu if visible
      const mobileMenu = document.getElementById('mobileMenu');
      if (mobileMenu) mobileMenu.classList.remove('show');

      // Open logs panel
      panel.style.display = 'block';
      panel.scrollTop = panel.scrollHeight;

      // Subtle animation
      panel.classList.add('fade-in');
      setTimeout(() => panel.classList.remove('fade-in'), 250);
    });
  }
});
  </script>
<style>
   #logsPanel.fade-in {
  animation: fadeInLogs 0.25s ease-in-out;
}
@keyframes fadeInLogs {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}
  </style>
<script>
   /* LOGS PANEL OPEN/CLOSE (injected) */
document.addEventListener('DOMContentLoaded', function() {
  function openLogsPanel() {
    try {
      var panel = document.getElementById('logsPanel');
      if (!panel) return;
      panel.style.display = 'flex';
      panel.setAttribute('aria-hidden', 'false');
      // Give focus to close for accessibility
      var closeBtn = document.getElementById('closeLogs');
      if (closeBtn) closeBtn.focus();
    } catch (e) { console.warn('openLogsPanel error', e); }
  }
  function closeLogsPanel() {
    try {
      var panel = document.getElementById('logsPanel');
      if (!panel) return;
      panel.style.display = 'none';
      panel.setAttribute('aria-hidden', 'true');
    } catch (e) { console.warn('closeLogsPanel error', e); }
  }

  // Bind both mobile and desktop buttons
  var mobileBtn = document.getElementById('btnViewLogs');
  var desktopBtn = document.getElementById('btnViewLogsDesktop');
  if (mobileBtn && !mobileBtn.__logsBound) {
    mobileBtn.addEventListener('click', function(e) {
      e.preventDefault();
      openLogsPanel();
      // optionally close mobile menu if open
      var menu = document.getElementById('mobileMenu');
      if (menu && menu.classList.contains('show')) {
        menu.classList.remove('show');
        menu.setAttribute('aria-hidden','true');
        var mt = document.getElementById('menuToggle');
        if (mt) mt.setAttribute('aria-expanded','false');
      }
    });
    mobileBtn.__logsBound = true;
  }
  if (desktopBtn && !desktopBtn.__logsBound) {
    desktopBtn.addEventListener('click', function(e) {
      e.preventDefault();
      openLogsPanel();
    });
    desktopBtn.__logsBound = true;
  }

  // Close actions
  var closeBtn = document.getElementById('closeLogs');
  if (closeBtn && !closeBtn.__logsBound) {
    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      closeLogsPanel();
    });
    closeBtn.__logsBound = true;
  }

  // Click outside to close
  var panel = document.getElementById('logsPanel');
  if (panel && !panel.__logsBound) {
    panel.addEventListener('click', function(e) {
      if (e.target === panel) closeLogsPanel();
    });
    panel.__logsBound = true;
  }

  // Esc to close
  window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeLogsPanel();
  });
});
  </script>
<script>
   /* LOGS PIPELINE (injected) */
(function() {
  var BUSY = false;
  var LAST = "";
  var OBS = null;
  var MAX_LINES = 300; // cap for performance

  function hash(s) {
    var h = 0, i = 0, len = s.length;
    while (i < len) { h = (h * 31 + s.charCodeAt(i++)) | 0; }
    return h.toString();
  }

  function stripBullet(line) {
    return line.replace(/^\s*•\s*/, '').trim();
  }

  function parseTs(line) {
    // Accept optional bullet at start
    line = stripBullet(line);
    var m = line.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})/);
    if (!m) return null;
    var dd = +m[1], mm = +m[2]-1, yy = +m[3];
    var hh = +m[4], mi = +m[5], ss = +m[6];
    return new Date(yy, mm, dd, hh, mi, ss).getTime();
  }

  function normalizeKey(line) {
    // Remove bullets and excessive spaces for stable de-dup
    return stripBullet(line).replace(/\s+/g,' ').trim();
  }

  function filterLines(text) {
    // Ensure newline before each date if glued
    text = text.replace(/([^\n])(?=(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}:\d{2}))/g, '$1\n');
    var raw = text.split('\n').map(function(l) { return l.replace(/\u200B/g,'').trim(); });

    var out = [];
    for (var i=0;i<raw.length;i++) {
      var line = raw[i];
      if (!line) continue;

      // Remove leading bullets from previous passes
      line = stripBullet(line);
      // remove `(auto)` markers from logs
      line = line.replace(/\(auto\)/gi, "").trim();
      // remove `(used:xx)` markers from logs (guard)
      line = line.replace(/\(used:[0-9]+\)/gi, '').trim();
      if (!line) continue;
      // remove `(used:xx)` markers from logs
      line = line.replace(/\(used:[0-9]+\)/gi, "").trim();

      // Filters
      if (/\bPaiement\s+(Server|Macs)\b/i.test(line)) continue;           // hide payments
      if (/\bSuppression\s+Client\b/i.test(line)) continue;               // hide FR duplicate for client
      if (/\bSuppression\s+Reseller\b/i.test(line) && !/Crédits/i.test(line)) continue; // keep only the credited one
      // (Optional) keep credited variant if both exist
      out.push(line);
    }
    return out;
  }

  function normalizeLines(lines) {
    // Dedup with normalized key ignoring bullet/spacing and '(used:xx)'
    var map = new Map();
    for (var i=0;i<lines.length;i++) {
      var raw = lines[i];
      var key = normalizeKey(raw.replace(/\(used:[0-9]+\)/gi, '').trim());
      if (map.has(key)) {
        var existing = map.get(key);
        // prefer the version WITHOUT (used:xx)
        var hasUsedExisting = /\(used:[0-9]+\)/i.test(existing);
        var hasUsedRaw = /\(used:[0-9]+\)/i.test(raw);
        if (hasUsedExisting && !hasUsedRaw) {
          map.set(key, raw);
        }
        // if both have/none have used, keep the first
      } else {
        map.set(key, raw);
      }
    }
    var uniq = Array.from(map.values());

    // Sort by timestamp desc when possible
    uniq.sort(function(a,b){
      var ta = parseTs(a), tb = parseTs(b);
      if (ta && tb) return tb - ta;
      return 0;
    });

    // Cap lines
    if (uniq.length > MAX_LINES) uniq = uniq.slice(0, MAX_LINES);

    // Bulletize
    return uniq.map(function(l){ return '• ' + l; }).join('\\n');
  }

  function apply(function apply(text) {
    var container = document.getElementById('logsContainer');
    // Hard sanitize incoming text in case upstream injected raw markers
    if (typeof text === 'string') {
      text = text.replace(/\(auto\)/gi, '')
                 .replace(/\(used:\s*\d+\)/gi, '')
                 .replace(/\s{2,}/g, ' ');
    }
    if (!container) return;
    if (BUSY) return;
    BUSY = true;
    try {
      var lines = filterLines(text);
      var out = normalizeLines(lines);
      var h = hash(out);
      if (h !== LAST && out !== (container.innerText || '')) {
        if (OBS) try { OBS.disconnect(); } catch(e){}
        container.textContent = out;
        // Final guard: ensure no '(auto)' or '(used:xx)' slipped through
        container.textContent = (container.textContent || '')
          .replace(/\(auto\)/gi, '')
          .replace(/\(used:\s*\d+\)/gi, '');
        LAST = h;
        requestAnimationFrame(function(){
          if (OBS) try {
            OBS.observe(container, { childList: true, characterData: true, subtree: true });
          } catch(e){}
          BUSY = false;
        });
      } else {
        BUSY = false;
      }
    } catch(e) {
      BUSY = false;
      console.warn('logs pipeline error', e);
    }
  }

  function currentRaw() {
    var container = document.getElementById('logsContainer');
    if (!container) return "";
    return container.textContent || container.innerText || "";
  }

  function refresh() { apply(currentRaw()); }

  window.__refreshLogsPipeline = refresh;

  document.addEventListener('DOMContentLoaded', function(){
    var container = document.getElementById('logsContainer');
    if (!container) return;
    refresh();
    OBS = new MutationObserver(function() { Promise.resolve().then(refresh); });
    OBS.observe(container, { childList: true, characterData: true, subtree: true });

    if (typeof window.openLogsPanel === 'function') {
      var origOpen = window.openLogsPanel;
      window.openLogsPanel = function() {
        try { origOpen(); } catch(e){}
        try { refresh(); } catch(e){}
      }
    }
  });
})();
  </script>
<script>
   /* LOGS COLOR RENDERER (injected) */
(function() {
  
  function classify(line) {
    if (/Nouveau\s+(Client|Reseller|Mac)/i.test(line)) return 'log-add';
    if (/(Suppression|Deleted)\s+(Client|Reseller|Mac)/i.test(line)) return 'log-delete';
    return '';
  }


  function renderColored() {
    var src = document.getElementById('logsContainer');
    var dst = document.getElementById('logsContainerView');
    if (!src || !dst) return;
    var text = src.textContent || '';
    var lines = text.split('\n');
    var html = '';
    for (var i=0;i<lines.length;i++) {
      var l = lines[i].trim();
      if (!l) continue;
      var cls = classify(l);
      // escape basic HTML
      var safe = l.replace(/[&<>]/g, function(c) { return {'&':'&amp;','<':'&lt;','>':'&gt;'}[c]; });
      html += '<span class="log-line ' + cls + '">'
           + safe + '</span>\n';
    }
    // Only write if changed
    if (dst.dataset.hash !== String(text.length) || dst.innerHTML.length === 0) {
      dst.innerHTML = html;
      dst.dataset.hash = String(text.length);
    }
  }

  // Initial render
  document.addEventListener('DOMContentLoaded', renderColored);

  // Re-render after pipeline refresh if present
  if (typeof window.__refreshLogsPipeline === 'function') {
    var oldRefresh = window.__refreshLogsPipeline;
    window.__refreshLogsPipeline = function() {
      try { oldRefresh(); } catch(e){}
      try { renderColored(); } catch(e){}
    }
  }

  // Observe changes on the hidden raw container to re-render view
  document.addEventListener('DOMContentLoaded', function(){
    var src = document.getElementById('logsContainer');
    if (!src) return;
    var obs = new MutationObserver(function(){ renderColored(); });
    obs.observe(src, { childList: true, characterData: true, subtree: true });
  });
})();
  </script>
<script>
(() => {
  const cssId = 'force-mac-green-css';
  if (!document.getElementById(cssId)) {
    const style = document.createElement('style');
    style.id = cssId;
    style.textContent = `
      #logsContainerView .force-mac-green,
      #logsContainer .force-mac-green,
      .logs-view .force-mac-green,
      .force-mac-green {
        color: #00ff00 !important;
      }
    `;
    document.head.appendChild(style);
  }

  const TARGET_TEXT = 'Nouvelle Mac';

  function markNode(el) {
    try {
      if (!el) return;
      if (el.classList && el.classList.contains('force-mac-green')) return;

      const txt = (el.innerText || el.textContent || '').trim();
      if (txt.includes(TARGET_TEXT)) {
        el.classList?.add('force-mac-green');
        el.style.setProperty('color', '#00ff00', 'important');
        return;
      }

      if (el.nodeType === Node.TEXT_NODE) {
        if ((el.nodeValue || '').includes(TARGET_TEXT)) {
          const span = document.createElement('span');
          span.className = 'force-mac-green';
          span.style.setProperty('color', '#00ff00', 'important');
          el.parentNode?.insertBefore(span, el);
          span.appendChild(el);
        }
        return;
      }

      const walker = document.createTreeWalker(el, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT, null);
      let node;
      while ((node = walker.nextNode())) {
        if (node.nodeType === Node.TEXT_NODE) {
          if ((node.nodeValue || '').includes(TARGET_TEXT)) {
            const span = document.createElement('span');
            span.className = 'force-mac-green';
            span.style.setProperty('color', '#00ff00', 'important');
            node.parentNode?.insertBefore(span, node);
            span.appendChild(node);
          }
        } else {
          const t = (node.innerText || node.textContent || '');
          if (t.includes(TARGET_TEXT)) {
            node.classList?.add('force-mac-green');
            node.style?.setProperty('color', '#00ff00', 'important');
          }
        }
      }
    } catch (_) {}
  }

  const containers = [
    document.getElementById('logsContainerView'),
    document.getElementById('logsContainer'),
    document.querySelector('.logs-view'),
    document.body
  ].filter(Boolean);

  containers.forEach(markNode);

  const obs = new MutationObserver((muts) => {
    for (const m of muts) {
      if (m.type === 'characterData') {
        markNode(m.target.parentNode || m.target);
      } else {
        m.addedNodes && m.addedNodes.forEach(n => markNode(n));
        if (m.target) markNode(m.target);
      }
    }
  });

  containers.forEach(c => {
    obs.observe(c, { childList: true, subtree: true, characterData: true });
  });

  setTimeout(() => containers.forEach(markNode), 300);
  setTimeout(() => containers.forEach(markNode), 1200);
  console.log('%c[OK] Forçage "Nouvelle Mac" en vert actif', 'color:#00ff00;font-weight:800');
})();
</script>
<!-- credits logger: robust delegated listener (mauve + prepend) -->
<script id="creditsLoggerDelegated">
// === Logger crédits (robuste, mauve, en haut du panel) ===
(() => {
  const STORE_KEY = 'iptv_activity_logs_v1';
  const pad = n => String(n).padStart(2, '0');
  const fmt = d => `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}  ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

  // ---- Style mauve ----
  if (!document.getElementById('logCreditsCSS')) {
    const st = document.createElement('style');
    st.id = 'logCreditsCSS';
    st.textContent = '#logsContainerView .log-credits{color:#a855f7;font-weight:700;}';
    document.head.appendChild(st);
  }

  // ---- Helpers ----
  function save(item){
    let arr;
    try { arr = JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); if(!Array.isArray(arr)) arr=[]; } catch { arr=[]; }
    arr.unshift(item);
    localStorage.setItem(STORE_KEY, JSON.stringify(arr.slice(0,500)));
  }

  function prependLine(line){
    const cont = document.getElementById('logsContainer');
    const view = document.getElementById('logsContainerView');
    if (cont){
      if (!(cont.textContent||'').includes(line)){
        cont.textContent = line + '\n' + cont.textContent;
      }
      cont.scrollTop = 0;
    }
    if (view){
      if (!(view.firstChild && view.firstChild.textContent === line)){
        const span = document.createElement('span');
        span.className = 'log-line log-credits';
        span.textContent = line;
        view.insertBefore(span, view.firstChild || null);
      }
      view.scrollTop = 0;
    }
  }

  function logCredits(amount){
    const now = new Date();
    const line = `${fmt(now)}  Nouveaux Crédits  ${amount} Ajoutés`;
    save({
      time: now.toISOString(),
      type: 'credits',
      action: 'add',
      entity: 'settings',
      details: { amount }
    });
    prependLine(line);
    try{ if(typeof window.addLog==='function') window.addLog(line); }catch(_){}
    console.log('🟣', line);
  }

  // ---- Écoute déléguée (attrape #inputCredits même s’il arrive plus tard) ----
  document.addEventListener('change', function(e){
    const t = e.target;
    if(!(t && t.id === 'inputCredits')) return;
    const n = parseInt(t.value || '0', 10);
    if (!isNaN(n) && n > 0) logCredits(n);
  }, true);

  // ---- Affiche le dernier log crédits à l’ouverture du panel ----
  const reShowLatest = () => setTimeout(() => {
    try{
      const arr = JSON.parse(localStorage.getItem(STORE_KEY)||'[]') || [];
      const it = arr.find(x => x?.type==='credits' && x?.action==='add');
      if(!it) return;
      const d = new Date(it.time || Date.now());
      const a = parseInt(it.details?.amount || 0, 10) || 0;
      prependLine(`${fmt(d)}  Nouveaux Crédits  ${a} Ajoutés`);
    }catch(_){}
  }, 120);

  document.getElementById('btnViewLogs')?.addEventListener('click', reShowLatest);
  document.getElementById('btnViewLogsDesktop')?.addEventListener('click', reShowLatest);
})();
</script>


<!-- injected: sort logs chrono (text + colorized) -->
<script id="sortLogsChronoInjected">
// === Tri chrono des logs (texte + colorisé) — nouveau → ancien ===
(() => {
  const tsRegex = /(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})/;
  const parseTs = (s) => {
    const m = tsRegex.exec(String(s||""));
    if(!m) return 0;
    const [_, dd, mm, yyyy, HH, MM, SS] = m.map(x=>Number(x));
    return new Date(yyyy, mm-1, dd, HH, MM, SS).getTime() || 0;
  };

  function sortTextView(){
    const cont = document.getElementById('logsContainer');
    if(!cont) return;
    const raw = (cont.textContent || "").split("\n").filter(Boolean);
    if(!raw.length) return;
    const items = raw.map(line => ({ line, t: parseTs(line) }));
    items.sort((a,b)=> b.t - a.t);
    cont.textContent = items.map(x=>x.line).join("\n\n");
    cont.scrollTop = 0;
  }

  function sortColoredView(){
    const view = document.getElementById('logsContainerView');
    if(!view) return;
    const nodes = Array.from(view.querySelectorAll('.log-line'));
    if(!nodes.length) return;
    const items = nodes.map(n => ({ n, t: parseTs(n.textContent||"") }));
    items.sort((a,b)=> b.t - a.t);
    for(const it of items){ view.appendChild(it.n); }
    view.scrollTop = 0;
  }

  function sortBoth(){
    sortTextView();
    sortColoredView();
  }

  const bind = () => {
    const panel = document.getElementById('logsPanel');
    const btn1  = document.getElementById('btnViewLogs');
    const btn2  = document.getElementById('btnViewLogsDesktop');
    const run = () => setTimeout(sortBoth, 80);

    btn1 && btn1.addEventListener('click', run, {once:false});
    btn2 && btn2.addEventListener('click', run, {once:false});

    if(panel && !panel.__sortBothObs){
      const obs = new MutationObserver(() => {
        if (panel.style.display !== 'none') setTimeout(sortBoth, 80);
      });
      obs.observe(panel, { attributes:true, attributeFilter:['style','aria-hidden'] });
      panel.__sortBothObs = true;
    }

    if (panel && panel.style.display !== 'none') sortBoth();
  };

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }

  console.log('✅ Tri chrono activé (texte + colorisé) — nouveau → ancien.');
})();
</script>

</body>
</html>
<script>
 // Guard: empêcher tout recalcul live sur les champs rg-buy/rg-sell (on tape)
document.addEventListener('input', function(e){
  var t = e && e.target;
  if(t && t.classList && (t.classList.contains('rg-buy') || t.classList.contains('rg-sell'))){
    // Bloque la propagation (capture) vers d'éventuels listeners existants
    e.stopImmediatePropagation && e.stopImmediatePropagation();
    e.stopPropagation && e.stopPropagation();
  }
}, true);


/* --- Device stats renderer (robust, uses in-memory state or multiple storage keys) --- */
function getClientsForCurrentUser() {
  try {
    // Prefer in-memory state if available
    if (window.state && Array.isArray(state.clients)) return state.clients;

    // Determine current user from known keys
    const user = (window.state && state.user) || localStorage.getItem(LS_CURRENT) || localStorage.getItem('iptv_current_user_v1') || '';

    // candidate keys (per-user and global)
    const candidateKeys = [];
    if (user) {
      candidateKeys.push(`iptv_clients_v4__${user}`, `iptv_clients__${user}`, `iptv_clients_v4__${user}`, `iptv_clients__${user}`);
    }
    candidateKeys.push('iptv_clients_v4', 'iptv_clients', `iptv_clients_v4__${user}`, `iptv_clients__${user}`);

    // try each key until we find an array
    for (const key of candidateKeys) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) continue;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
      } catch (e) { /* ignore and continue */ }
    }

    // fallback: parse current table rows (#tbody) if present
    const rows = Array.from(document.querySelectorAll('#tbody tr'));
    if (rows.length) {
      const out = [];
      rows.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (!tds || tds.length < 4) return;
        const dev = (tds[3].textContent || '').trim(); // 4th column is Device/APP
        if (dev) out.push({ device: dev });
      });
      if (out.length) return out;
    }

    // last fallback: empty array
    return [];
  } catch (err) {
    console.error('getClientsForCurrentUser error', err);
    return [];
  }
}

const mobileBtn = document.getElementById('mobileStats');
    if(mobileBtn && !mobileBtn.__deviceStatsBound){ mobileBtn.addEventListener('click', renderDeviceStats); mobileBtn.__deviceStatsBound = true; }

    // If you have a close/open cycle for the modal, optionally call when modal becomes visible
    const closeStats = document.getElementById('closeStats');
    if(closeStats && !closeStats.__deviceStatsBound){ closeStats.addEventListener('click', renderDeviceStats); closeStats.__deviceStatsBound = true; }
  }catch(e){ console.warn('attachDeviceStatsListeners failed', e); }
}

// Attach on DOM ready
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachDeviceStatsListeners);
else attachDeviceStatsListeners();
/* --- end device stats block --- */

  } catch(e){ console.error('renderDeviceStats error', e); }
}

function attachDeviceStatsListeners(){
  const btn = document.getElementById('btnStats');
  if(btn) btn.addEventListener('click', renderDeviceStats);
  const mobileBtn = document.getElementById('mobileStats');
  if(mobileBtn) mobileBtn.addEventListener('click', renderDeviceStats);
}
// wait for DOM ready if needed
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', attachDeviceStatsListeners);
} else {
  attachDeviceStatsListeners();
}
/* --- end injected --- */

/* --- Device stats (reads directly from clients table) --- */
function renderDeviceStats() {
  try {
    const tbodyClients = document.querySelector('div[style*="max-height:62vh"] table tbody');
    const tbodyStats = document.getElementById("deviceStatsBody");
    if (!tbodyClients || !tbodyStats) return;

    const rows = tbodyClients.querySelectorAll("tr");
    const counts = {};

    rows.forEach(tr => {
      const tds = tr.querySelectorAll("td");
      if (tds.length === 0) return;
      const devText = (tds[3] || tds[tds.length - 1]).textContent.trim() || "Inconnu";
      counts[devText] = (counts[devText] || 0) + 1;
    });

    tbodyStats.innerHTML = "";

    const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    entries.forEach(([device, count]) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,.06);">${device}</td>
        <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,.06); color:var(--accent); font-weight:700;">${count}</td>
      `;
      tbodyStats.appendChild(row);
    });

    if (entries.length === 0) {
      tbodyStats.innerHTML = '<tr><td colspan="2" style="padding:8px; color:var(--muted)">Aucun client trouvé</td></tr>';
    }
  } catch (err) {
    console.error("renderDeviceStats error:", err);
  }
}

function attachDeviceStatsListeners() {
  const btn = document.getElementById("btnStats");
  if (btn && !btn.__statsBound) {
    btn.addEventListener("click", renderDeviceStats);
    btn.__statsBound = true;
  }
  const mobileBtn = document.getElementById("mobileStats");
  if (mobileBtn && !mobileBtn.__statsBound) {
    mobileBtn.addEventListener("click", renderDeviceStats);
    mobileBtn.__statsBound = true;
  }

  // auto-refresh when clients table changes
  const clientsContainer = document.querySelector('div[style*="max-height:62vh"] table tbody');
  if (clientsContainer && !clientsContainer.__observer) {
    const mo = new MutationObserver(() => renderDeviceStats());
    mo.observe(clientsContainer, { childList: true, subtree: true });
    clientsContainer.__observer = true;
  }
}

if (document.readyState === "loading")
  document.addEventListener("DOMContentLoaded", attachDeviceStatsListeners);
else
  attachDeviceStatsListeners();
/* --- end Device stats --- */

/* --- Device stats (final version: reads from TABLE 0, column 3) --- */
function renderDeviceStats() {
  try {
    const allTables = document.querySelectorAll('div[style*="max-height:62vh"] table');
    const tbl = allTables[0]; // TABLE 0 ✅
    const deviceIndex = 3;    // colonne Device/APP ✅
    if (!tbl) return;

    const rows = tbl.querySelectorAll("tbody tr");
    const counts = {};

    rows.forEach(tr => {
      const tds = tr.querySelectorAll("td");
      if (!tds.length) return;
      let devText = (tds[deviceIndex]?.textContent.trim()) || "Inconnu";

      // découpe les valeurs multiples par virgule, slash, point-virgule, ou majuscules successives
      const parts = devText.split(/[,;|/\\]+|\s*(?=[A-Z][a-z])/g).map(s => s.trim()).filter(Boolean);
      parts.forEach(dev => {
        counts[dev] = (counts[dev] || 0) + 1;
      });
    });

    const tbodyStats = document.getElementById("deviceStatsBody");
    if (!tbodyStats) return;
    tbodyStats.innerHTML = "";

    const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    entries.forEach(([device, count]) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="padding:8px; border-bottom:1px solid rgba(255,255,255,.06);">${device}</td>
        <td style="padding:8px; border-bottom:1px solid rgba(255,255,255;.06); color:var(--accent); font-weight:700;">${count}</td>
      `;
      tbodyStats.appendChild(row);
    });

    if (entries.length === 0) {
      tbodyStats.innerHTML = '<tr><td colspan="2" style="padding:8px; color:var(--muted)">Aucun client trouvé</td></tr>';
    }
  } catch (err) {
    console.error("renderDeviceStats error:", err);
  }
}

function attachDeviceStatsListeners() {
  const btn = document.getElementById("btnStats");
  if (btn && !btn.__statsBound) {
    btn.addEventListener("click", renderDeviceStats);
    btn.__statsBound = true;
  }
  const mobileBtn = document.getElementById("mobileStats");
  if (mobileBtn && !mobileBtn.__statsBound) {
    mobileBtn.addEventListener("click", renderDeviceStats);
    mobileBtn.__statsBound = true;
  }

  // auto-refresh quand la table clients change
  const mainDiv = document.querySelector('div[style*="max-height:62vh"]');
  if (mainDiv && !mainDiv.__observer) {
    const mo = new MutationObserver(() => renderDeviceStats());
    mo.observe(mainDiv, { childList: true, subtree: true });
    mainDiv.__observer = true;
  }
}

if (document.readyState === "loading")
  document.addEventListener("DOMContentLoaded", attachDeviceStatsListeners);
else
  attachDeviceStatsListeners();
/* --- end Device stats --- */
</script>
